<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Sous-système | Propriétaire</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; background:#f4f6f8; margin:0 }
    header { background:#111; color:#fff; padding:12px 16px; display:flex; align-items:center; gap:12px }
    header img { height:36px }
    main { padding:16px }
    .card { background:#fff; border-radius:8px; padding:16px; margin-bottom:16px; box-shadow:0 2px 6px rgba(0,0,0,.08) }
    h2 { margin:0 0 8px }
    button { padding:8px 12px; cursor:pointer }
    .row { display:flex; gap:12px; flex-wrap:wrap }
    .muted { color:#777 }
    table { width:100%; border-collapse:collapse }
    th,td { padding:8px; border-bottom:1px solid #eee; text-align:left }
  </style>
</head>
<body>

<header>
  <img id="logo" src="" alt="" onerror="this.style.display='none'">
  <div>
    <div id="name">Sous-système</div>
    <small class="muted" id="status">Chargement…</small>
  </div>
</header>

<main>
  <div class="card">
    <h2>Configuration du jeu</h2>
    <div class="row">
      <div>
        <label>Multiplicateur</label><br>
        <input id="multiplier" type="number" step="0.1" />
      </div>
      <div>
        <label>Bloquer une boule</label><br>
        <input id="blockedBall" placeholder="ex: 12" />
      </div>
    </div>
    <br>
    <button onclick="saveConfig()">Enregistrer</button>
  </div>

  <div class="card">
    <h2>Superviseurs</h2>
    <button onclick="createSupervisor(2)">Créer Superviseur N2</button>
    <button onclick="createSupervisor(1)">Créer Superviseur N1</button>
    <table id="supTable">
      <thead><tr><th>Nom</th><th>Niveau</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Agents</h2>
    <table id="agentTable">
      <thead><tr><th>Nom</th><th>Statut</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="card">
    <h2>Transactions</h2>
    <table id="txTable">
      <thead><tr><th>Agent</th><th>Montant</th><th>Date</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</main>

<script>
  // === LOGIQUE COPIÉE DU MASTER (token) ===
  const params = new URLSearchParams(location.search);
  const token = params.get('token');
  if (!token || !token.startsWith('nova_')) {
    document.body.innerHTML = '<h3 style="padding:16px">Accès refusé</h3>';
    throw new Error('Token invalide');
  }

  // === API helper ===
  async function api(path, method='GET', body) {
    const res = await fetch(path + '?token=' + encodeURIComponent(token), {
      method,
      headers: { 'Content-Type':'application/json' },
      body: body ? JSON.stringify(body) : undefined
    });
    return res.json();
  }

  // === LOAD ===
  async function load() {
    const info = await api('/api/subsystem/me');
    if (!info.success) return alert(info.error || 'Erreur');

    document.getElementById('name').textContent = info.data.name;
    document.getElementById('status').textContent = info.data.active ? 'Actif' : 'Bloqué';
    if (info.data.logo) document.getElementById('logo').src = info.data.logo;

    document.getElementById('multiplier').value = info.data.multiplier || 1;

    fillTable('supTable', info.supervisors || [], (s)=>`
      <tr><td>${s.username}</td><td>${s.level}</td>
      <td><button onclick="blockUser('${s._id}')">Bloquer</button></td></tr>`);

    fillTable('agentTable', info.agents || [], (a)=>`
      <tr><td>${a.username}</td><td>${a.blocked?'Bloqué':'Actif'}</td>
      <td><button onclick="blockUser('${a._id}')">Bloquer</button></td></tr>`);

    fillTable('txTable', info.transactions || [], (t)=>`
      <tr><td>${t.agent}</td><td>${t.amount}</td><td>${new Date(t.date).toLocaleString()}</td></tr>`);
  }

  function fillTable(id, rows, tpl){
    const tb = document.querySelector('#'+id+' tbody');
    tb.innerHTML = rows.map(tpl).join('');
  }

  async function saveConfig(){
    const multiplier = Number(document.getElementById('multiplier').value);
    const blockedBall = document.getElementById('blockedBall').value;
    const r = await api('/api/subsystem/config','POST',{ multiplier, blockedBall });
    alert(r.success ? 'Enregistré' : r.error);
  }

  async function createSupervisor(level){
    const username = prompt('Nom utilisateur');
    const password = prompt('Mot de passe');
    if (!username || !password) return;
    const r = await api('/api/subsystem/supervisor','POST',{ username, password, level });
    if (!r.success) return alert(r.error);
    load();
  }

  async function blockUser(id){
    const r = await api('/api/subsystem/block','POST',{ id });
    if (!r.success) return alert(r.error);
    load();
  }

  load();
</script>
</body>
</html>