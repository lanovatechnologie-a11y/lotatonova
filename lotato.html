<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOTATO - Agent</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- CSS externalisé dans un fichier séparé pour la production -->
    <style>
        /* Version minimale du CSS - Pour production, externaliser dans lotato.css */
        :root {
            --primary-color: #ad00f1;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #9000f0;
            --warning-color: #1cf100;
            --light-color: #ecf0f1;
            --dark-color: #0004ff;
            --miami-color: #e74c3c;
            --georgia-color: #3498db;
            --newyork-color: #e99700;
            --texas-color: #f30000;
            --tunisia-color: #1abc9c;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            line-height: 1.6;
            max-width: 500px;
            margin: 0 auto;
            position: relative;
            min-height: 100vh;
        }
        
        /* Styles réduits pour l'exemple - Version complète dans fichier séparé */
        .container { padding: 15px; padding-bottom: 80px; }
        header { background: linear-gradient(135deg, var(--primary-color), #1a2530); color: white; padding: 15px; text-align: center; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .draws-container { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .draw-card { background-color: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); padding: 15px; text-align: center; cursor: pointer; }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: white; display: flex; justify-content: space-around; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); max-width: 500px; margin: 0 auto; z-index: 1000; }
        .screen { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: white; z-index: 100; padding: 20px; overflow-y: auto; max-width: 500px; margin: 0 auto; }
        .login-screen { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, var(--primary-color), #1a2530); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 2000; padding: 20px; }
        .betting-screen { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: white; z-index: 100; padding: 20px; overflow-y: auto; max-width: 500px; margin: 0 auto; }
        
        /* Classes pour les notifications */
        .notification {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--primary-color);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 90%;
            animation: slideUp 0.3s ease-out;
        }
        
        @keyframes slideUp {
            from { opacity: 0; transform: translate(-50%, 20px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }
        
        .notification.success { background-color: var(--success-color); }
        .notification.warning { background-color: var(--warning-color); }
        .notification.error { background-color: var(--accent-color); }
        
        .sync-status {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
            padding: 8px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        .sync-connected { background-color: var(--success-color); color: white; }
        .sync-disconnected { background-color: var(--accent-color); color: white; }
        
        /* Game items */
        .game-item {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            border-left: 4px solid var(--secondary-color);
        }
        
        .game-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .game-category-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <!-- Écran de login -->
    <div class="login-screen" id="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <div class="logo">
                    <i class="fas fa-dice"></i>
                </div>
            </div>
            <h2 class="login-title">LOTATO - Agent</h2>
            <div class="login-error" id="login-error" style="display: none;">
                Identifiant ou mot de passe incorrect
            </div>
            <div class="form-group">
                <label for="admin-username">Identifiant</label>
                <input type="text" id="admin-username" placeholder="admin" maxlength="50">
            </div>
            <div class="form-group">
                <label for="admin-password">Mot de passe</label>
                <input type="password" id="admin-password" placeholder="••••••••" maxlength="100">
            </div>
            <button class="submit-bet" id="login-btn">Konekte</button>
        </div>
    </div>
    
    <!-- Statut de synchronisation -->
    <div class="sync-status sync-disconnected" id="sync-status" style="display: none;">
        <i class="fas fa-cloud"></i> <span id="sync-text">Pa Konekte</span>
    </div>
    
    <!-- Contenu principal -->
    <div class="container" id="main-container" style="display: none;">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <img src="logo-borlette.jpg" alt="Logo Nova Lotto" class="logo-image" id="company-logo" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNTAiIGhlaWdodD0iNTAiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyNSIgY3k9IjI1IiByPSIyMCIgZmlsbD0iIzFhYjljYyIvPjx0ZXh0IHg9IjI1IiB5PSIyOCIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZG9taW5hbnQtYmFzZWxpbmU9Im1pZGRsZSI+Tkw8L3RleHQ+PC9zdmc+'">
                    <div class="logo">
                        <i class="fas fa-dice"></i>
                    </div>
                </div>
                <div class="header-text">
                    <h1 id="company-name">Nova Lotto</h1>
                    <p>Agent: <span id="agent-name">-</span></p>
                </div>
            </div>
            <div class="time-display">
                <i class="fas fa-clock"></i> <span id="current-time">Chargement...</span>
            </div>
        </header>
        
        <!-- Panel multi-tirage -->
        <div class="multi-draw-panel" id="multi-draw-panel">
            <!-- Contenu dynamique via JS -->
        </div>
        
        <!-- Conteneur des tirages -->
        <div class="draws-container" id="draws-container">
            <!-- Contenu dynamique via JS -->
        </div>
        
        <!-- Section résultats -->
        <div class="results-section" id="results-section">
            <!-- Contenu dynamique via JS -->
        </div>
        
        <!-- Notification des gagnants -->
        <div id="winners-notification-container" style="display: none;"></div>
    </div>
    
    <!-- Navigation inférieure -->
    <div class="bottom-nav" id="bottom-nav" style="display: none;">
        <div class="nav-item active" data-screen="home">
            <div class="nav-icon"><i class="fas fa-home"></i></div>
            <span>Akèy</span>
        </div>
        <div class="nav-item" data-screen="winning-tickets">
            <div class="nav-icon"><i class="fas fa-trophy"></i></div>
            <span>Fiche Gagnant</span>
        </div>
        <div class="nav-item" data-screen="history">
            <div class="nav-icon"><i class="fas fa-history"></i></div>
            <span>Istorik</span>
        </div>
        <div class="nav-item" data-screen="ticket-management">
            <div class="nav-icon"><i class="fas fa-file-invoice"></i></div>
            <span>Jesyon Fiche</span>
        </div>
    </div>
    
    <!-- Écrans secondaires (dynamiques via JS) -->
    <div id="screens-container"></div>
    
    <!-- Template pour les notifications -->
    <template id="notification-template">
        <div class="notification">
            <i class="fas fa-info-circle"></i>
            <span></span>
        </div>
    </template>

    <!-- Script principal CORRIGÉ -->
    <script>
        // ============================================================================
        // CONFIGURATION ET CONSTANTES
        // ============================================================================
        const API_BASE_URL = 'https://lotatonova-fv0b.onrender.com';
        const APP_CONFIG = {
            health: `${API_BASE_URL}/api/health`,
            login: `${API_BASE_URL}/api/auth/login`,
            tickets: `${API_BASE_URL}/api/tickets`,
            results: `${API_BASE_URL}/api/results`,
            draws: `${API_BASE_URL}/api/draws`,
            winners: `${API_BASE_URL}/api/winners`,
            reports: `${API_BASE_URL}/api/reports`
        };
        
        const LOT_MULTIPLIERS = {
            first: 60,
            second: 20,
            third: 10
        };
        
        const SECURITY_CONFIG = {
            SESSION_TIMEOUT: 30 * 60 * 1000, // 30 minutes
            MAX_BET_AMOUNT: 10000,
            MAX_NUMBER_LENGTH: 10,
            REQUEST_TIMEOUT: 10000 // 10 secondes
        };
        
        const betTypes = {
            borlette: {
                name: "BORLETTE",
                multiplier: LOT_MULTIPLIERS.first,
                icon: "fas fa-dice",
                description: "2 chif (1er lot seulement)",
                category: "borlette",
                validate: (number) => /^\d{2}$/.test(number),
                sanitize: (num) => num.replace(/[^\d]/g, '').slice(0, 2)
            },
            boulpe: {
                name: "BOUL PE",
                multiplier: LOT_MULTIPLIERS.first,
                icon: "fas fa-circle",
                description: "Boul pe (00-99)",
                category: "borlette",
                validate: (number) => /^\d{2}$/.test(number) && number[0] === number[1],
                sanitize: (num) => num.replace(/[^\d]/g, '').slice(0, 2)
            },
            lotto3: {
                name: "LOTO 3",
                multiplier: 500,
                icon: "fas fa-list-ol",
                description: "3 chif (ex: 123)",
                category: "lotto",
                validate: (number) => /^\d{3}$/.test(number),
                sanitize: (num) => num.replace(/[^\d]/g, '').slice(0, 3)
            },
            grap: {
                name: "GRAP",
                multiplier: 500,
                icon: "fas fa-chart-line",
                description: "Grap boule paire (111, 222, ..., 000)",
                category: "special",
                validate: (number) => /^\d{3}$/.test(number) && number[0] === number[1] && number[1] === number[2],
                sanitize: (num) => num.replace(/[^\d]/g, '').slice(0, 3)
            },
            marriage: {
                name: "MARYAJ",
                multiplier: 1000,
                icon: "fas fa-link",
                description: "Maryaj 2 chif (ex: 12*34)",
                category: "special",
                validate: (numbers) => {
                    const [num1, num2] = numbers.split('*');
                    return /^\d{2}$/.test(num1) && /^\d{2}$/.test(num2);
                },
                sanitize: (num) => num.replace(/[^\d*]/g, '')
            },
            lotto4: {
                name: "LOTO 4",
                multiplier: 5000,
                icon: "fas fa-list-ol",
                description: "4 chif (2+2 boules)",
                category: "lotto",
                validate: (numbers) => {
                    const [num1, num2] = numbers.split('*');
                    return /^\d{2}$/.test(num1) && /^\d{2}$/.test(num2);
                },
                sanitize: (num) => num.replace(/[^\d*]/g, '')
            },
            lotto5: {
                name: "LOTO 5",
                multiplier: 25000,
                icon: "fas fa-list-ol",
                description: "5 chif (3+2 boules)",
                category: "lotto",
                validate: (numbers) => {
                    const [num1, num2] = numbers.split('*');
                    return /^\d{3}$/.test(num1) && /^\d{2}$/.test(num2);
                },
                sanitize: (num) => num.replace(/[^\d*]/g, '')
            }
        };
        
        const draws = {
            miami: {
                name: "Miami",
                times: { morning: "1:30 PM", evening: "9:50 PM" },
                color: "--miami-color"
            },
            georgia: {
                name: "Georgia",
                times: { morning: "12:30 PM", evening: "7:00 PM" },
                color: "--georgia-color"
            },
            newyork: {
                name: "New York",
                times: { morning: "2:30 PM", evening: "8:00 PM" },
                color: "--newyork-color"
            },
            texas: {
                name: "Texas",
                times: { morning: "12:00 PM", evening: "6:00 PM" },
                color: "--texas-color"
            },
            tunisia: {
                name: "Tunisie",
                times: { morning: "10:30 AM", evening: "2:00 PM" },
                color: "--tunisia-color"
            }
        };
        
        // ============================================================================
        // ÉTAT GLOBAL DE L'APPLICATION
        // ============================================================================
        class AppState {
            constructor() {
                this.currentDraw = null;
                this.currentDrawTime = null;
                this.activeBets = [];
                this.currentAdmin = null;
                this.isOnline = navigator.onLine;
                this.selectedMultiDraws = new Set();
                this.selectedMultiGame = 'borlette';
                this.latestResults = {};
                this.eventListeners = new Map(); // Pour gérer les écouteurs
                this.sessionExpiry = null;
                this.pendingRequests = new Map(); // Pour éviter les doublons
            }
            
            // Gestion sécurisée des sessions
            setAdmin(adminData) {
                this.currentAdmin = adminData;
                this.sessionExpiry = Date.now() + SECURITY_CONFIG.SESSION_TIMEOUT;
                
                // Stockage sécurisé (avec expiration)
                const sessionData = {
                    id: adminData.id,
                    name: adminData.name,
                    expiry: this.sessionExpiry
                };
                localStorage.setItem('lotatoAgent', JSON.stringify(sessionData));
                
                // Stocker le token dans une variable sécurisée (pas dans localStorage)
                window.__SECURE_TOKEN = adminData.token;
            }
            
            clearAdmin() {
                this.currentAdmin = null;
                this.sessionExpiry = null;
                localStorage.removeItem('lotatoAgent');
                delete window.__SECURE_TOKEN;
            }
            
            isSessionValid() {
                if (!this.currentAdmin || !this.sessionExpiry) return false;
                return Date.now() < this.sessionExpiry;
            }
            
            getToken() {
                return window.__SECURE_TOKEN || null;
            }
        }
        
        // Instance unique de l'état
        const appState = new AppState();
        
        // ============================================================================
        // UTILITAIRES DE SÉCURITÉ ET VALIDATION
        // ============================================================================
        class SecurityUtils {
            static sanitizeInput(input) {
                if (typeof input !== 'string') return '';
                return input
                    .replace(/[<>]/g, '') // Éviter XSS
                    .trim()
                    .slice(0, SECURITY_CONFIG.MAX_NUMBER_LENGTH);
            }
            
            static validateBetAmount(amount) {
                const num = parseInt(amount);
                return !isNaN(num) && 
                       num > 0 && 
                       num <= SECURITY_CONFIG.MAX_BET_AMOUNT;
            }
            
            static validateNumber(input, type) {
                const betType = betTypes[type];
                if (!betType) return false;
                
                const sanitized = betType.sanitize ? betType.sanitize(input) : input;
                return betType.validate(sanitized);
            }
            
            static escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }
        
        // ============================================================================
        // GESTION DES REQUÊTES API
        // ============================================================================
        class ApiClient {
            static async request(endpoint, options = {}) {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), SECURITY_CONFIG.REQUEST_TIMEOUT);
                
                const requestId = `${endpoint}_${Date.now()}`;
                if (appState.pendingRequests.has(requestId)) {
                    throw new Error('Requête déjà en cours');
                }
                
                appState.pendingRequests.set(requestId, controller);
                
                try {
                    const defaultOptions = {
                        headers: {
                            'Content-Type': 'application/json',
                            ...(appState.getToken() && { 'Authorization': `Bearer ${appState.getToken()}` })
                        },
                        signal: controller.signal
                    };
                    
                    const response = await fetch(endpoint, { ...defaultOptions, ...options });
                    
                    clearTimeout(timeoutId);
                    appState.pendingRequests.delete(requestId);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    
                    return await response.json();
                } catch (error) {
                    clearTimeout(timeoutId);
                    appState.pendingRequests.delete(requestId);
                    
                    if (error.name === 'AbortError') {
                        throw new Error('La requête a expiré. Vérifiez votre connexion.');
                    }
                    
                    throw error;
                }
            }
            
            static async login(username, password) {
                return this.request(APP_CONFIG.login, {
                    method: 'POST',
                    body: JSON.stringify({ username, password })
                });
            }
            
            static async createTicket(ticketData) {
                return this.request(APP_CONFIG.tickets, {
                    method: 'POST',
                    body: JSON.stringify(ticketData)
                });
            }
            
            static async getAgentTickets(agentId) {
                return this.request(`${APP_CONFIG.tickets}/agent/${agentId}`);
            }
            
            static async getLatestResults() {
                return this.request(`${APP_CONFIG.results}/latest`);
            }
            
            static async deleteTicket(ticketId) {
                return this.request(`${APP_CONFIG.tickets}/${ticketId}`, {
                    method: 'DELETE'
                });
            }
            
            static async getWinningTickets(agentId) {
                return this.request(`${APP_CONFIG.winners}/agent/${agentId}`);
            }
            
            static async checkForWinners(agentId) {
                return this.request(`${APP_CONFIG.winners}/check/${agentId}`);
            }
            
            static async getGeneralReport(agentId) {
                return this.request(`${APP_CONFIG.reports}/general/${agentId}`);
            }
            
            static async getDrawReport(agentId, drawId, time) {
                return this.request(`${APP_CONFIG.reports}/draw/${agentId}/${drawId}/${time}`);
            }
            
            static async getEndOfDrawReport(agentId) {
                return this.request(`${APP_CONFIG.reports}/end-of-draw/${agentId}`);
            }
            
            static async checkHealth() {
                return this.request(APP_CONFIG.health);
            }
        }
        
        // ============================================================================
        // GESTION DE L'INTERFACE UTILISATEUR
        // ============================================================================
        class UIHandler {
            constructor() {
                this.notifications = [];
                this.screens = {};
                this.initTemplates();
            }
            
            initTemplates() {
                // Templates pour les éléments réutilisables
                this.templates = {
                    notification: document.getElementById('notification-template'),
                    drawCard: this.createDrawCardTemplate(),
                    gameItem: this.createGameItemTemplate()
                };
            }
            
            createDrawCardTemplate() {
                const template = document.createElement('template');
                template.innerHTML = `
                    <div class="draw-card">
                        <div class="draw-icon"></div>
                        <h3></h3>
                        <div class="draw-buttons">
                            <button class="draw-btn morning" data-time="morning"></button>
                            <button class="draw-btn evening" data-time="evening"></button>
                        </div>
                        <div class="draw-countdown"></div>
                    </div>
                `;
                return template;
            }
            
            createGameItemTemplate() {
                const template = document.createElement('template');
                template.innerHTML = `
                    <div class="game-item">
                        <div class="game-name"></div>
                        <div class="game-multiplier"></div>
                        <small></small>
                    </div>
                `;
                return template;
            }
            
            // CORRECTION DU BUG CRITIQUE : Gestion propre des événements
            static addGameListeners(container) {
                // Nettoyer les anciens écouteurs
                const existingListeners = container.dataset.listenersAttached;
                if (existingListeners === 'true') return;
                
                container.addEventListener('click', (e) => {
                    const gameItem = e.target.closest('.game-item');
                    if (!gameItem) return;
                    
                    const gameType = gameItem.dataset.game;
                    if (!gameType) return;
                    
                    if (gameType === 'auto-marriage' || gameType === 'auto-lotto4') {
                        showAutoGameForm(gameType);
                    } else {
                        showBetForm(gameType);
                    }
                });
                
                // Marquer comme configuré
                container.dataset.listenersAttached = 'true';
            }
            
            showNotification(message, type = 'info', duration = 5000) {
                const template = this.templates.notification;
                const notification = template.content.cloneNode(true).querySelector('.notification');
                
                notification.classList.add(type);
                notification.querySelector('span').textContent = message;
                
                // Icône selon le type
                const iconMap = {
                    success: 'fa-check-circle',
                    warning: 'fa-exclamation-triangle',
                    error: 'fa-times-circle',
                    info: 'fa-info-circle'
                };
                
                notification.querySelector('i').className = `fas ${iconMap[type] || 'fa-info-circle'}`;
                
                document.body.appendChild(notification);
                this.notifications.push(notification);
                
                // Auto-destruction
                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translate(-50%, 20px)';
                    setTimeout(() => {
                        notification.remove();
                        this.notifications = this.notifications.filter(n => n !== notification);
                    }, 300);
                }, duration);
                
                return notification;
            }
            
            updateSyncStatus(connected) {
                const syncStatus = document.getElementById('sync-status');
                const syncText = document.getElementById('sync-text');
                
                if (connected) {
                    syncStatus.className = 'sync-status sync-connected';
                    syncText.textContent = 'Konekte ak MongoDB';
                } else {
                    syncStatus.className = 'sync-status sync-disconnected';
                    syncText.textContent = 'Pa Konekte';
                }
                
                syncStatus.style.display = 'flex';
            }
            
            showMainApp() {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-container').style.display = 'block';
                document.getElementById('bottom-nav').style.display = 'flex';
                this.updateSyncStatus(true);
                
                // Initialiser les écrans
                this.initScreens();
                this.loadDraws();
                this.loadLatestResults();
            }
            
            initScreens() {
                // Écran de gestion des tickets
                this.createScreen('ticket-management', 'Jesyon Fiche', this.renderTicketManagement.bind(this));
                // Écran des tickets gagnants
                this.createScreen('winning-tickets', 'Fiche Genyen', this.renderWinningTickets.bind(this));
                // Écran d'historique
                this.createScreen('history', 'Istorik Parye', this.renderHistory.bind(this));
                // Écran de rapport
                this.createScreen('report', 'Rapò Fin Tiraj', this.renderReport.bind(this));
            }
            
            createScreen(id, title, renderFunction) {
                const screen = document.createElement('div');
                screen.className = 'screen';
                screen.id = `${id}-screen`;
                screen.innerHTML = `
                    <div class="screen-header">
                        <button class="back-button" data-screen="home">
                            <i class="fas fa-arrow-left"></i>
                        </button>
                        <h2 class="screen-title">${title}</h2>
                    </div>
                    <div class="screen-content" id="${id}-content"></div>
                `;
                
                document.getElementById('screens-container').appendChild(screen);
                this.screens[id] = { screen, renderFunction };
            }
            
            async renderTicketManagement() {
                const content = document.getElementById('ticket-management-content');
                content.innerHTML = `
                    <div class="ticket-search-box">
                        <div class="search-history">
                            <input type="text" id="search-ticket-number" class="search-input" 
                                   placeholder="Chache fiche pa nimewo..." maxlength="20">
                            <button class="search-btn" id="search-ticket-btn">
                                <i class="fas fa-search"></i> Chache
                            </button>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn-secondary" id="show-all-tickets">Afiche Tout Fiche</button>
                            <button class="btn-secondary" id="show-today-tickets">Fiche Jodi a</button>
                        </div>
                    </div>
                    <div id="ticket-management-list" class="ticket-list"></div>
                `;
                
                await this.loadAgentTickets();
                this.setupTicketManagementListeners();
            }
            
            async loadAgentTickets() {
                try {
                    const tickets = await ApiClient.getAgentTickets(appState.currentAdmin.id);
                    this.displayAgentTickets(tickets);
                } catch (error) {
                    this.showNotification("Erè chajman fiche: " + error.message, "error");
                }
            }
            
            displayAgentTickets(tickets) {
                const list = document.getElementById('ticket-management-list');
                if (!list) return;
                
                if (!tickets || tickets.length === 0) {
                    list.innerHTML = '<p style="text-align: center; padding: 20px; color: #7f8c8d;">Pa gen fiche ki kreye.</p>';
                    return;
                }
                
                tickets.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
                
                list.innerHTML = tickets.map(ticket => {
                    const ticketDate = new Date(ticket.createdAt);
                    const now = new Date();
                    const timeDiff = now - ticketDate;
                    const canDelete = timeDiff <= 5 * 60 * 1000; // 5 minutes
                    
                    const betsHtml = Array.isArray(ticket.bets) ? ticket.bets.map(bet => `
                        <div class="history-bet">
                            <span>${SecurityUtils.escapeHtml(bet.name)}: ${SecurityUtils.escapeHtml(bet.number)}</span>
                            <span>${bet.amount} G</span>
                        </div>
                    `).join('') : '';
                    
                    return `
                        <div class="ticket-management" data-ticket-id="${ticket._id}">
                            <div class="ticket-management-header">
                                <div>
                                    <strong>Fiche #${String(ticket.ticketNumber).padStart(6, '0')}</strong>
                                    <div style="font-size: 0.9rem; color: #7f8c8d;">
                                        ${draws[ticket.draw]?.name || 'Inconnu'} (${ticket.drawTime === 'morning' ? 'Maten' : 'Swè'})
                                        <span style="color: ${ticket.status === 'pending' ? 'var(--warning-color)' : 'var(--success-color)'}">
                                            (${ticket.status === 'pending' ? 'Pokò tire' : 'Fini'})
                                        </span>
                                    </div>
                                </div>
                                <div class="ticket-actions-buttons">
                                    ${canDelete ? `
                                        <button class="delete-btn" onclick="handleDeleteTicket('${ticket._id}')">
                                            <i class="fas fa-trash"></i> Efase
                                        </button>
                                    ` : ''}
                                    <button class="edit-btn" onclick="handleReprintTicket('${ticket._id}')">
                                        <i class="fas fa-print"></i> Re-enprime
                                    </button>
                                </div>
                            </div>
                            <div class="ticket-details">
                                <div style="margin-bottom: 10px;">
                                    <strong>Dat:</strong> ${ticketDate.toLocaleString('fr-FR')}
                                </div>
                                <div>
                                    <strong>Parye:</strong>
                                    ${betsHtml}
                                </div>
                                <div style="margin-top: 10px; font-weight: bold;">
                                    Total: ${ticket.total} G
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            setupTicketManagementListeners() {
                const searchBtn = document.getElementById('search-ticket-btn');
                const showAllBtn = document.getElementById('show-all-tickets');
                const showTodayBtn = document.getElementById('show-today-tickets');
                
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => this.searchTicket());
                }
                if (showAllBtn) {
                    showAllBtn.addEventListener('click', () => this.loadAgentTickets());
                }
                if (showTodayBtn) {
                    showTodayBtn.addEventListener('click', () => this.showTodayTickets());
                }
            }
            
            searchTicket() {
                const searchTerm = document.getElementById('search-ticket-number').value.trim().toLowerCase();
                const ticketItems = document.querySelectorAll('#ticket-management-list .ticket-management');
                
                ticketItems.forEach(item => {
                    const text = item.textContent.toLowerCase();
                    item.style.display = text.includes(searchTerm) ? 'block' : 'none';
                });
            }
            
            showTodayTickets() {
                const today = new Date().toISOString().split('T')[0];
                const ticketItems = document.querySelectorAll('#ticket-management-list .ticket-management');
                
                ticketItems.forEach(item => {
                    const dateText = item.querySelector('.ticket-details').textContent;
                    item.style.display = dateText.includes(today) ? 'block' : 'none';
                });
            }
            
            async renderWinningTickets() {
                const content = document.getElementById('winning-tickets-content');
                content.innerHTML = `
                    <div class="search-history">
                        <input type="text" id="search-winning-tickets" class="search-input" 
                               placeholder="Chache fiche..." maxlength="50">
                        <button class="search-btn" id="search-winning-btn">
                            <i class="fas fa-search"></i> Chache
                        </button>
                    </div>
                    <div id="winning-tickets-list" class="ticket-list"></div>
                `;
                
                await this.loadWinningTickets();
                this.setupWinningTicketsListeners();
            }
            
            async loadWinningTickets() {
                try {
                    const winners = await ApiClient.getWinningTickets(appState.currentAdmin.id);
                    this.displayWinningTickets(winners);
                } catch (error) {
                    this.showNotification("Erè chajman fiche gagnant: " + error.message, "error");
                }
            }
            
            displayWinningTickets(winners) {
                const list = document.getElementById('winning-tickets-list');
                if (!list) return;
                
                if (!winners || winners.length === 0) {
                    list.innerHTML = '<p>Pa gen fiche gagnant pou montre.</p>';
                    return;
                }
                
                list.innerHTML = winners.map(winner => {
                    const betsHtml = winner.ticket.bets.map(bet => {
                        const winAmount = bet.amount * bet.multiplier;
                        return `
                            <div class="history-bet">
                                <span>${SecurityUtils.escapeHtml(bet.name)}: ${SecurityUtils.escapeHtml(bet.number)}</span>
                                <span style="color: var(--success-color); font-weight: bold;">+${winAmount} G</span>
                            </div>
                        `;
                    }).join('');
                    
                    return `
                        <div class="history-item">
                            <div class="history-header">
                                <span class="history-draw">Fiche #${String(winner.ticket.ticketNumber).padStart(6, '0')}</span>
                                <span class="history-date">${new Date(winner.ticket.createdAt).toLocaleString()}</span>
                            </div>
                            <div class="history-bets">
                                ${betsHtml}
                            </div>
                            <div class="history-total">
                                <span>Total Gains:</span>
                                <span style="color: var(--success-color); font-weight: bold;">
                                    ${winner.totalWinnings} G
                                </span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            setupWinningTicketsListeners() {
                const searchBtn = document.getElementById('search-winning-btn');
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => this.searchWinningTickets());
                }
            }
            
            searchWinningTickets() {
                const searchTerm = document.getElementById('search-winning-tickets').value.toLowerCase();
                const winningItems = document.querySelectorAll('#winning-tickets-list .history-item');
                
                winningItems.forEach(item => {
                    item.style.display = item.textContent.toLowerCase().includes(searchTerm) ? 'block' : 'none';
                });
            }
            
            async renderHistory() {
                const content = document.getElementById('history-content');
                content.innerHTML = `
                    <div class="search-history">
                        <input type="text" id="search-history" class="search-input" 
                               placeholder="Chache fiche..." maxlength="50">
                        <button class="search-btn" id="search-history-btn">
                            <i class="fas fa-search"></i> Chache
                        </button>
                    </div>
                    <div class="reports-container" id="reports-container"></div>
                    <div id="report-results"></div>
                    <div id="history-list" class="ticket-list"></div>
                `;
                
                await this.loadHistory();
                this.setupHistoryListeners();
                this.loadReportsButtons();
            }
            
            async loadHistory() {
                try {
                    // Note: Cette route doit exister dans votre API
                    const response = await ApiClient.request(`${APP_CONFIG.tickets}/history/${appState.currentAdmin.id}`);
                    this.displayHistory(response);
                } catch (error) {
                    this.showNotification("Erè chajman istorik: " + error.message, "error");
                }
            }
            
            displayHistory(history) {
                const list = document.getElementById('history-list');
                if (!list) return;
                
                if (!history || history.length === 0) {
                    list.innerHTML = '<p>Pa gen fiche nan istorik.</p>';
                    return;
                }
                
                list.innerHTML = history.map(ticket => {
                    const groupedBets = this.groupBetsByType(ticket.bets);
                    let betsHtml = '';
                    
                    for (const [type, bets] of Object.entries(groupedBets)) {
                        const betStrings = bets.map(bet => 
                            `${SecurityUtils.escapeHtml(bet.number)} (${bet.amount} G)`
                        );
                        betsHtml += `<div style="margin-bottom: 8px;"><strong>${SecurityUtils.escapeHtml(type)}:</strong> ${betStrings.join(', ')}</div>`;
                    }
                    
                    return `
                        <div class="history-item">
                            <div class="history-header">
                                <span class="history-draw">${draws[ticket.draw]?.name || 'Inconnu'} (${ticket.drawTime === 'morning' ? 'Maten' : 'Swè'})</span>
                                <span class="history-date">${new Date(ticket.createdAt).toLocaleString()}</span>
                            </div>
                            <div class="history-bets">
                                ${betsHtml}
                            </div>
                            <div class="history-total">
                                <span>Total:</span>
                                <span>${ticket.total} G</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            groupBetsByType(bets) {
                const grouped = {};
                
                bets.forEach(bet => {
                    if (!grouped[bet.name]) {
                        grouped[bet.name] = [];
                    }
                    grouped[bet.name].push({...bet});
                });
                
                return grouped;
            }
            
            loadReportsButtons() {
                const container = document.getElementById('reports-container');
                if (!container) return;
                
                container.innerHTML = '';
                
                // Bouton rapport général
                const generalBtn = document.createElement('button');
                generalBtn.className = 'report-btn general';
                generalBtn.textContent = 'Rapò Jeneral';
                generalBtn.addEventListener('click', () => this.generateGeneralReport());
                container.appendChild(generalBtn);
                
                // Boutons par tirage
                for (const [drawId, draw] of Object.entries(draws)) {
                    const morningBtn = document.createElement('button');
                    morningBtn.className = 'report-btn';
                    morningBtn.textContent = `${draw.name} Midi`;
                    morningBtn.addEventListener('click', () => this.generateDrawReport(drawId, 'morning'));
                    container.appendChild(morningBtn);
                    
                    const eveningBtn = document.createElement('button');
                    eveningBtn.className = 'report-btn';
                    eveningBtn.textContent = `${draw.name} Swè`;
                    eveningBtn.addEventListener('click', () => this.generateDrawReport(drawId, 'evening'));
                    container.appendChild(eveningBtn);
                }
            }
            
            async generateGeneralReport() {
                try {
                    const report = await ApiClient.getGeneralReport(appState.currentAdmin.id);
                    this.displayGeneralReport(report);
                } catch (error) {
                    this.showNotification("Erè jenere rapò: " + error.message, "error");
                }
            }
            
            displayGeneralReport(report) {
                const results = document.getElementById('report-results');
                if (!results) return;
                
                results.innerHTML = `
                    <div class="report-results">
                        <h3>Rapò Jeneral</h3>
                        <div class="report-item">
                            <span>Fiche Total:</span>
                            <span>${report.totalTickets || 0}</span>
                        </div>
                        <div class="report-item">
                            <span>Parye Total:</span>
                            <span>${report.totalBets || 0}</span>
                        </div>
                        <div class="report-item">
                            <span>Ventes Total:</span>
                            <span>${report.totalSales || 0} G</span>
                        </div>
                        <div class="report-item">
                            <span>Gains Total:</span>
                            <span>${report.totalWinnings || 0} G</span>
                        </div>
                        <div class="report-item">
                            <span>Profit Net:</span>
                            <span style="color: ${(report.netProfit || 0) >= 0 ? 'var(--success-color)' : 'var(--accent-color)'}">
                                ${report.netProfit || 0} G
                            </span>
                        </div>
                    </div>
                `;
            }
            
            async generateDrawReport(drawId, time) {
                try {
                    const report = await ApiClient.getDrawReport(appState.currentAdmin.id, drawId, time);
                    this.displayDrawReport(drawId, time, report);
                } catch (error) {
                    this.showNotification("Erè jenere rapò tiraj: " + error.message, "error");
                }
            }
            
            displayDrawReport(drawId, time, report) {
                const results = document.getElementById('report-results');
                if (!results) return;
                
                const drawName = draws[drawId]?.name || drawId;
                const timeName = time === 'morning' ? 'Midi' : 'Swè';
                
                results.innerHTML = `
                    <div class="report-results">
                        <h3>Rapò ${drawName} ${timeName}</h3>
                        <div class="report-item">
                            <span>Fiche Total:</span>
                            <span>${report.totalTickets || 0}</span>
                        </div>
                        <div class="report-item">
                            <span>Parye Total:</span>
                            <span>${report.totalBets || 0}</span>
                        </div>
                        <div class="report-item">
                            <span>Ventes Total:</span>
                            <span>${report.totalSales || 0} G</span>
                        </div>
                        <div class="report-item">
                            <span>Gains Total:</span>
                            <span>${report.totalWinnings || 0} G</span>
                        </div>
                        <div class="report-item">
                            <span>Profit:</span>
                            <span style="color: ${(report.netProfit || 0) >= 0 ? 'var(--success-color)' : 'var(--accent-color)'}">
                                ${report.netProfit || 0} G
                            </span>
                        </div>
                    </div>
                `;
            }
            
            async renderReport() {
                const content = document.getElementById('report-content');
                content.innerHTML = '<p>Chargement...</p>';
                
                try {
                    const report = await ApiClient.getEndOfDrawReport(appState.currentAdmin.id);
                    this.displayReport(report);
                } catch (error) {
                    content.innerHTML = `<p class="error">Erè: ${error.message}</p>`;
                }
            }
            
            displayReport(report) {
                const content = document.getElementById('report-content');
                if (!content) return;
                
                content.innerHTML = `
                    <div class="report-header">
                        <h2>RAPÒ FIN TIRAJ</h2>
                        <p>Nova Lotto</p>
                        <p>Agent: ${SecurityUtils.escapeHtml(appState.currentAdmin.name)}</p>
                    </div>
                    
                    <div class="report-details">
                        <div class="report-row">
                            <span>Dat:</span>
                            <span>${new Date(report.date || Date.now()).toLocaleDateString('fr-FR')}</span>
                        </div>
                        <div class="report-row">
                            <span>D. Impression:</span>
                            <span>${new Date().toLocaleString('fr-FR')}</span>
                        </div>
                    </div>
                    
                    <div style="text-align: center; margin: 20px 0;">
                        <strong>${"*".repeat(7)}</strong>
                    </div>
                    
                    <div class="report-details">
                        <div class="report-row">
                            <span>#Fiche vendues:</span>
                            <span>${report.totalTickets || 0}</span>
                        </div>
                        <div class="report-row">
                            <span>#Fiche gagnantes:</span>
                            <span>${report.winningTickets || 0}</span>
                        </div>
                        <div class="report-row">
                            <span>Ventes:</span>
                            <span>${report.totalSales || 0} G</span>
                        </div>
                        <div class="report-row">
                            <span>Paiements:</span>
                            <span>${report.totalPayouts || 0} G</span>
                        </div>
                        <div class="report-row total ${(report.netProfit || 0) >= 0 ? 'report-profit' : 'report-loss'}">
                            <span>Profit/Perte:</span>
                            <span>${report.netProfit || 0} G</span>
                        </div>
                    </div>
                    
                    <div class="ticket-actions" style="margin-top: 30px;">
                        <button class="ticket-action-btn print-ticket-btn" onclick="printEndOfDrawReport(${JSON.stringify(report).replace(/"/g, '&quot;')})">
                            <i class="fas fa-print"></i> Enprime Rapò
                        </button>
                    </div>
                `;
            }
            
            setupHistoryListeners() {
                const searchBtn = document.getElementById('search-history-btn');
                if (searchBtn) {
                    searchBtn.addEventListener('click', () => this.searchHistory());
                }
            }
            
            searchHistory() {
                const searchTerm = document.getElementById('search-history').value.toLowerCase();
                const historyItems = document.querySelectorAll('#history-list .history-item');
                
                historyItems.forEach(item => {
                    item.style.display = item.textContent.toLowerCase().includes(searchTerm) ? 'block' : 'none';
                });
            }
            
            loadDraws() {
                const container = document.getElementById('draws-container');
                if (!container) return;
                
                container.innerHTML = Object.entries(draws).map(([drawId, draw]) => `
                    <div class="draw-card" data-draw="${drawId}" style="border-top: 5px solid var(${draw.color})">
                        <div class="draw-icon" style="color: var(${draw.color})">
                            <i class="fas fa-${drawId === 'texas' ? 'hat-cowboy' : 
                                             drawId === 'newyork' ? 'building' : 
                                             drawId === 'miami' ? 'sun' : 
                                             drawId === 'tunisia' ? 'flag' : 'map-marker-alt'}"></i>
                        </div>
                        <h3>${draw.name}</h3>
                        <div class="draw-buttons">
                            <button class="draw-btn morning active" data-time="morning">${draw.times.morning}</button>
                            <button class="draw-btn evening" data-time="evening">${draw.times.evening}</button>
                        </div>
                        <div class="draw-countdown" id="${drawId}-countdown">Calcul...</div>
                    </div>
                `).join('');
                
                this.setupDrawListeners();
                this.updateDrawCountdowns();
            }
            
            setupDrawListeners() {
                document.querySelectorAll('.draw-card').forEach(card => {
                    card.addEventListener('click', (e) => {
                        if (e.target.closest('.draw-btn')) return; // Éviter double déclenchement
                        
                        const drawId = card.dataset.draw;
                        const activeBtn = card.querySelector('.draw-btn.active');
                        const time = activeBtn ? activeBtn.dataset.time : 'morning';
                        
                        openBettingScreen(drawId, time);
                    });
                });
                
                document.querySelectorAll('.draw-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const card = e.target.closest('.draw-card');
                        const drawId = card.dataset.draw;
                        const time = e.target.dataset.time;
                        
                        card.querySelectorAll('.draw-btn').forEach(b => b.classList.remove('active'));
                        e.target.classList.add('active');
                        
                        openBettingScreen(drawId, time);
                    });
                });
            }
            
            updateDrawCountdowns() {
                const now = new Date();
                
                Object.keys(draws).forEach(drawId => {
                    const element = document.getElementById(`${drawId}-countdown`);
                    if (!element) return;
                    
                    const nextTime = this.calculateNextDrawTime(drawId, now);
                    const diff = nextTime - now;
                    
                    if (diff > 0) {
                        const hours = Math.floor(diff / (1000 * 60 * 60));
                        const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                        element.textContent = `${hours}h ${minutes}min`;
                    } else {
                        element.textContent = "An kou";
                    }
                });
            }
            
            calculateNextDrawTime(drawId, now) {
                const draw = draws[drawId];
                if (!draw) return new Date(now.getTime() + 3600000);
                
                const times = Object.values(draw.times).map(timeStr => {
                    const [time, modifier] = timeStr.split(' ');
                    let [hours, minutes] = time.split(':').map(Number);
                    
                    if (modifier === 'PM' && hours < 12) hours += 12;
                    if (modifier === 'AM' && hours === 12) hours = 0;
                    
                    const drawTime = new Date(now);
                    drawTime.setHours(hours, minutes, 0, 0);
                    
                    if (drawTime < now) {
                        drawTime.setDate(drawTime.getDate() + 1);
                    }
                    
                    return drawTime;
                });
                
                return times.reduce((closest, time) => time < closest ? time : closest);
            }
            
            async loadLatestResults() {
                try {
                    const results = await ApiClient.getLatestResults();
                    appState.latestResults = results;
                    this.updateResultsDisplay(results);
                } catch (error) {
                    console.warn("Impossible de charger les résultats:", error.message);
                }
            }
            
            updateResultsDisplay(results) {
                const container = document.getElementById('results-section');
                if (!container) return;
                
                const resultsHtml = Object.entries(draws).map(([drawId, draw]) => {
                    const result = results[drawId] || { first: '--', second: '--', third: '--' };
                    return `
                        <div class="result-card">
                            <h4>${draw.name}</h4>
                            <div class="result-number">${SecurityUtils.escapeHtml(result.first)}</div>
                            <small>${SecurityUtils.escapeHtml(result.second)} / ${SecurityUtils.escapeHtml(result.third)}</small>
                        </div>
                    `;
                }).join('');
                
                container.innerHTML = `
                    <div class="section-title">
                        <i class="fas fa-trophy"></i>
                        <h2>Dènye Rezilta</h2>
                    </div>
                    <div class="results-grid">
                        ${resultsHtml}
                    </div>
                    <div class="ticket-actions" style="margin-top: 15px;">
                        <button class="ticket-action-btn save-print-btn" id="generate-report-btn">
                            <i class="fas fa-file-alt"></i> Jenere Rapò Fin Tiraj
                        </button>
                    </div>
                `;
                
                document.getElementById('generate-report-btn')?.addEventListener('click', () => {
                    this.showScreen('report');
                });
            }
        }
        
        // ============================================================================
        // INITIALISATION DE L'APPLICATION
        // ============================================================================
        const uiHandler = new UIHandler();
        
        document.addEventListener('DOMContentLoaded', async () => {
            console.log("LOTATO Agent - Initialisation sécurisée...");
            
            // Vérifier la session existante
            await checkExistingSession();
            
            // Mettre à jour l'heure
            updateCurrentTime();
            setInterval(updateCurrentTime, 60000);
            
            // Configurer la détection de connexion
            setupConnectionDetection();
            
            // Configurer les écouteurs globaux
            setupGlobalListeners();
            
            // Vérifier la santé de l'API
            checkApiHealth();
            
            console.log("Initialisation terminée");
        });
        
        async function checkExistingSession() {
            try {
                const sessionData = localStorage.getItem('lotatoAgent');
                if (!sessionData) {
                    showLoginScreen();
                    return;
                }
                
                const { id, name, expiry } = JSON.parse(sessionData);
                
                if (Date.now() > expiry) {
                    localStorage.removeItem('lotatoAgent');
                    showLoginScreen();
                    return;
                }
                
                // Note: En production, il faudrait vérifier le token avec le serveur
                appState.currentAdmin = { id, name };
                appState.sessionExpiry = expiry;
                
                // Masquer l'écran de login
                uiHandler.showMainApp();
                document.getElementById('agent-name').textContent = name;
                
            } catch (error) {
                console.error("Erreur vérification session:", error);
                showLoginScreen();
            }
        }
        
        function showLoginScreen() {
            document.getElementById('login-screen').style.display = 'flex';
            document.getElementById('main-container').style.display = 'none';
            document.getElementById('bottom-nav').style.display = 'none';
        }
        
        async function adminLogin() {
            const username = SecurityUtils.sanitizeInput(document.getElementById('admin-username').value);
            const password = document.getElementById('admin-password').value;
            
            if (!username || !password) {
                showLoginError("Tanpri antre identifian ak modpas la");
                return;
            }
            
            try {
                const loginData = await ApiClient.login(username, password);
                
                appState.setAdmin({
                    id: loginData.id,
                    username: loginData.username,
                    name: loginData.name,
                    role: loginData.role,
                    token: loginData.token
                });
                
                uiHandler.showMainApp();
                uiHandler.showNotification("Koneksyon reyisi!", "success");
                
                document.getElementById('agent-name').textContent = loginData.name;
                
                // Charger les données initiales
                await uiHandler.loadAgentTickets();
                await uiHandler.loadWinningTickets();
                
            } catch (error) {
                console.error("Erreur connexion:", error);
                showLoginError(error.message || "Identifian oswa modpas la pa kòrèk");
            }
        }
        
        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }
        
        function updateCurrentTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            const dateString = now.toLocaleDateString('fr-FR', options);
            const timeString = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            
            document.getElementById('current-time').textContent = `${dateString} - ${timeString}`;
        }
        
        function setupConnectionDetection() {
            window.addEventListener('online', () => {
                appState.isOnline = true;
                uiHandler.updateSyncStatus(true);
                uiHandler.showNotification("Koneksyon retabli ak MongoDB", "success");
            });
            
            window.addEventListener('offline', () => {
                appState.isOnline = false;
                uiHandler.updateSyncStatus(false);
                uiHandler.showNotification("Pa konekte ak MongoDB", "warning");
            });
        }
        
        function setupGlobalListeners() {
            // Login
            document.getElementById('login-btn')?.addEventListener('click', adminLogin);
            document.getElementById('admin-password')?.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') adminLogin();
            });
            
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const screen = this.dataset.screen;
                    showScreen(screen);
                });
            });
            
            // Boutons retour
            document.addEventListener('click', (e) => {
                if (e.target.closest('.back-button')) {
                    const screen = e.target.closest('.back-button').dataset.screen || 'home';
                    showScreen(screen);
                }
            });
        }
        
        async function checkApiHealth() {
            try {
                await ApiClient.checkHealth();
                uiHandler.updateSyncStatus(true);
            } catch (error) {
                uiHandler.updateSyncStatus(false);
                console.warn("API non disponible:", error.message);
            }
        }
        
        function showScreen(screenId) {
            // Cacher tous les écrans
            document.querySelectorAll('.screen, .betting-screen, .report-screen').forEach(screen => {
                screen.style.display = 'none';
            });
            
            document.querySelector('.container').style.display = screenId === 'home' ? 'block' : 'none';
            
            // Mettre à jour la navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.dataset.screen === screenId) {
                    item.classList.add('active');
                }
            });
            
            // Afficher l'écran demandé
            const screen = uiHandler.screens[screenId];
            if (screen) {
                screen.screen.style.display = 'block';
                if (screen.renderFunction) {
                    screen.renderFunction();
                }
            }
        }
        
        // ============================================================================
        // GESTION DES PARIS (BETTING SCREEN)
        // ============================================================================
        function openBettingScreen(drawId, time = 'morning') {
            appState.currentDraw = drawId;
            appState.currentDrawTime = time;
            const draw = draws[drawId];
            
            // Créer l'écran de pari dynamiquement
            const bettingScreen = document.createElement('div');
            bettingScreen.className = 'betting-screen slide-in';
            bettingScreen.id = 'current-betting-screen';
            bettingScreen.innerHTML = `
                <div class="betting-header">
                    <button class="back-button" id="close-betting">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <h2 class="betting-title">${draw.name} (${time === 'morning' ? 'Maten' : 'Swè'})</h2>
                    <div class="total-display" id="header-total-display" style="display: none;">Total: 0 G</div>
                    <div style="margin-left: auto;">
                        <button class="submit-bet" id="confirm-bet-top" style="padding: 8px 15px; font-size: 0.9rem;">
                            <i class="fas fa-check"></i> Konfime Parye
                        </button>
                    </div>
                </div>
                
                <div id="games-interface" class="all-categories-container">
                    <div class="game-category">
                        <div class="game-category-title">BORLETTE</div>
                        <div class="game-category-grid">
                            <div class="game-item" data-game="borlette">
                                <div class="game-name">BORLETTE</div>
                                <div class="game-multiplier">x 60</div>
                                <small>2 chif (1er lot)</small>
                            </div>
                            <div class="game-item" data-game="boulpe">
                                <div class="game-name">BOUL PE</div>
                                <div class="game-multiplier">x 60</div>
                                <small>Boul pe (00-99)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="game-category">
                        <div class="game-category-title">LOTTO</div>
                        <div class="game-category-grid">
                            <div class="game-item" data-game="lotto3">
                                <div class="game-name">LOTO 3</div>
                                <div class="game-multiplier">x 500</div>
                                <small>3 chif (ex: 123)</small>
                            </div>
                            <div class="game-item" data-game="lotto4">
                                <div class="game-name">LOTO 4</div>
                                <div class="game-multiplier">x 5000</div>
                                <small>4 chif (2+2 boules)</small>
                            </div>
                            <div class="game-item" data-game="lotto5">
                                <div class="game-name">LOTO 5</div>
                                <div class="game-multiplier">x 25000</div>
                                <small>5 chif (3+2 boules)</small>
                            </div>
                        </div>
                    </div>
                    
                    <div class="game-category">
                        <div class="game-category-title">JEUX SPÉCIAUX</div>
                        <div class="game-category-grid">
                            <div class="game-item" data-game="grap">
                                <div class="game-name">GRAP</div>
                                <div class="game-multiplier">x 500</div>
                                <small>Boule paire (111, 222...)</small>
                            </div>
                            <div class="game-item" data-game="marriage">
                                <div class="game-name">MARYAJ</div>
                                <div class="game-multiplier">x 1000</div>
                                <small>Maryaj 2 chif</small>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="bet-form" id="bet-form" style="display: none;"></div>
                
                <div class="active-bets" id="active-bets">
                    <div class="ticket-actions">
                        <button class="ticket-action-btn save-print-btn" id="save-print-ticket">Enprime Fiche</button>
                    </div>
                    <h3>Parye Aktif</h3>
                    <div id="bets-list"></div>
                    <div class="bet-total">
                        <span>Total:</span>
                        <span id="bet-total">0 goud</span>
                    </div>
                </div>
            `;
            
            document.body.appendChild(bettingScreen);
            
            // Configurer les écouteurs CORRIGÉS
            bettingScreen.querySelector('#close-betting').addEventListener('click', closeBettingScreen);
            bettingScreen.querySelector('#confirm-bet-top').addEventListener('click', submitBets);
            bettingScreen.querySelector('#save-print-ticket').addEventListener('click', saveAndPrintTicket);
            
            // CORRECTION: Gestion propre des écouteurs de jeu
            const gamesInterface = bettingScreen.querySelector('#games-interface');
            UIHandler.addGameListeners(gamesInterface);
            
            updateBetsList();
            document.querySelector('.container').style.display = 'none';
        }
        
        function showBetForm(gameType) {
            const bettingScreen = document.getElementById('current-betting-screen');
            if (!bettingScreen) return;
            
            const bet = betTypes[gameType];
            const betForm = bettingScreen.querySelector('#bet-form');
            const gamesInterface = bettingScreen.querySelector('#games-interface');
            
            gamesInterface.style.display = 'none';
            betForm.style.display = 'block';
            
            let formHTML = '';
            
            switch(gameType) {
                case 'borlette':
                    formHTML = `
                        <h3>${bet.name} - ${bet.description}</h3>
                        <div class="quick-bet-form">
                            <input type="text" id="borlette-number" class="quick-number-input" 
                                   placeholder="00" maxlength="2" pattern="[0-9]{2}">
                            <input type="number" id="borlette-amount" class="quick-amount-input" 
                                   placeholder="Kantite" min="1" max="${SECURITY_CONFIG.MAX_BET_AMOUNT}">
                            <button class="btn-primary" id="add-borlette-bet">Ajoute</button>
                        </div>
                        <div class="bet-actions">
                            <button class="btn-secondary" id="return-to-games">Retounen</button>
                        </div>
                    `;
                    break;
                    
                case 'boulpe':
                    formHTML = `
                        <h3>${bet.name} - ${bet.description}</h3>
                        <div class="quick-bet-form">
                            <input type="text" id="boulpe-number" class="quick-number-input" 
                                   placeholder="00" maxlength="2" pattern="[0-9]{2}">
                            <input type="number" id="boulpe-amount" class="quick-amount-input" 
                                   placeholder="Kantite" min="1" max="${SECURITY_CONFIG.MAX_BET_AMOUNT}">
                            <button class="btn-primary" id="add-boulpe-bet">Ajoute</button>
                        </div>
                        <div class="bet-actions">
                            <button class="btn-secondary" id="return-to-games">Retounen</button>
                        </div>
                        <div style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 5px; margin-top: 10px;">
                            ${['00', '11', '22', '33', '44', '55', '66', '77', '88', '99'].map(num => `
                                <button class="n-ball" data-number="${num}" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer;">
                                    ${num}
                                </button>
                            `).join('')}
                        </div>
                    `;
                    break;
                    
                case 'lotto3':
                    formHTML = `
                        <h3>${bet.name} - ${bet.description}</h3>
                        <div class="quick-bet-form">
                            <input type="text" id="lotto3-number" class="quick-number-input" 
                                   placeholder="000" maxlength="3" pattern="[0-9]{3}">
                            <input type="number" id="lotto3-amount" class="quick-amount-input" 
                                   placeholder="Kantite" min="1" max="${SECURITY_CONFIG.MAX_BET_AMOUNT}">
                            <button class="btn-primary" id="add-lotto3-bet">Ajoute</button>
                        </div>
                        <div class="bet-actions">
                            <button class="btn-secondary" id="return-to-games">Retounen</button>
                        </div>
                    `;
                    break;
                    
                case 'marriage':
                    formHTML = `
                        <h3>${bet.name} - ${bet.description}</h3>
                        <div class="form-group">
                            <label>2 Chif yo (sépare pa *)</label>
                            <input type="text" id="marriage-number" placeholder="12*34" 
                                   maxlength="5" pattern="\\d{2}\\*\\d{2}">
                        </div>
                        <div class="quick-bet-form">
                            <input type="number" id="marriage-amount" class="quick-amount-input" 
                                   placeholder="Kantite" min="1" max="${SECURITY_CONFIG.MAX_BET_AMOUNT}">
                            <button class="btn-primary" id="add-marriage-bet">Ajoute</button>
                        </div>
                        <div class="bet-actions">
                            <button class="btn-secondary" id="return-to-games">Retounen</button>
                        </div>
                    `;
                    break;
                    
                case 'lotto4':
                    formHTML = `
                        <h3>${bet.name} - ${bet.description}</h3>
                        <div class="form-group">
                            <label>4 Chif yo (2 boules, sépare pa *)</label>
                            <input type="text" id="lotto4-number" placeholder="12*34" 
                                   maxlength="5" pattern="\\d{2}\\*\\d{2}">
                        </div>
                        <div class="quick-bet-form">
                            <input type="number" id="lotto4-amount" class="quick-amount-input" 
                                   placeholder="Kantite" min="1" max="${SECURITY_CONFIG.MAX_BET_AMOUNT}">
                            <button class="btn-primary" id="add-lotto4-bet">Ajoute</button>
                        </div>
                        <div class="bet-actions">
                            <button class="btn-secondary" id="return-to-games">Retounen</button>
                        </div>
                    `;
                    break;
                    
                case 'lotto5':
                    formHTML = `
                        <h3>${bet.name} - ${bet.description}</h3>
                        <div class="form-group">
                            <label>5 Chif yo (3+2 boules, sépare pa *)</label>
                            <input type="text" id="lotto5-number" placeholder="123*45" 
                                   maxlength="6" pattern="\\d{3}\\*\\d{2}">
                        </div>
                        <div class="quick-bet-form">
                            <input type="number" id="lotto5-amount" class="quick-amount-input" 
                                   placeholder="Kantite" min="1" max="${SECURITY_CONFIG.MAX_BET_AMOUNT}">
                            <button class="btn-primary" id="add-lotto5-bet">Ajoute</button>
                        </div>
                        <div class="bet-actions">
                            <button class="btn-secondary" id="return-to-games">Retounen</button>
                        </div>
                    `;
                    break;
                    
                case 'grap':
                    formHTML = `
                        <h3>${bet.name} - ${bet.description}</h3>
                        <div style="margin-bottom: 15px;">
                            <div class="all-graps-btn" id="select-all-graps" style="background: var(--secondary-color); color: white; padding: 10px; border-radius: 6px; text-align: center; margin-bottom: 5px; cursor: pointer;">
                                <i class="fas fa-check-square"></i> Chwazi Tout Graps
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;" id="grap-selection-container">
                            ${['111', '222', '333', '444', '555', '666', '777', '888', '999', '000'].map(pair => `
                                <div class="pair-ball" data-pair="${pair}" style="background: #f0f0f0; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer;">
                                    ${pair}
                                </div>
                            `).join('')}
                        </div>
                        
                        <div class="form-group">
                            <label for="grap-amount">Kantite pou chak grap</label>
                            <input type="number" id="grap-amount" placeholder="Kantite" min="1" 
                                   max="${SECURITY_CONFIG.MAX_BET_AMOUNT}" value="1">
                        </div>
                        
                        <div class="bet-actions">
                            <button class="btn-primary" id="add-selected-graps">Ajoute Graps Chwazi</button>
                            <button class="btn-secondary" id="return-to-games">Retounen</button>
                        </div>
                    `;
                    break;
            }
            
            betForm.innerHTML = formHTML;
            
            // Configurer les écouteurs du formulaire
            const returnBtn = betForm.querySelector('#return-to-games');
            if (returnBtn) {
                returnBtn.addEventListener('click', () => {
                    betForm.style.display = 'none';
                    gamesInterface.style.display = 'block';
                    UIHandler.addGameListeners(gamesInterface);
                });
            }
            
            // Configurer le bouton d'ajout selon le type
            const addBtn = betForm.querySelector('[id^="add-"]');
            if (addBtn) {
                addBtn.addEventListener('click', () => addBet(gameType));
            }
            
            // Configurer les boutons spéciaux
            if (gameType === 'boulpe') {
                betForm.querySelectorAll('.n-ball[data-number]').forEach(ball => {
                    ball.addEventListener('click', () => {
                        document.getElementById('boulpe-number').value = ball.dataset.number;
                        document.getElementById('boulpe-amount').focus();
                    });
                });
            }
            
            if (gameType === 'grap') {
                setupGrapSelection();
            }
        }
        
        function setupGrapSelection() {
            const container = document.getElementById('grap-selection-container');
            if (!container) return;
            
            const selectAllBtn = document.getElementById('select-all-graps');
            const addBtn = document.getElementById('add-selected-graps');
            
            let selectedGraps = new Set();
            
            container.querySelectorAll('.pair-ball').forEach(ball => {
                ball.addEventListener('click', () => {
                    ball.classList.toggle('selected');
                    const pair = ball.dataset.pair;
                    
                    if (ball.classList.contains('selected')) {
                        selectedGraps.add(pair);
                    } else {
                        selectedGraps.delete(pair);
                    }
                });
            });
            
            selectAllBtn?.addEventListener('click', () => {
                container.querySelectorAll('.pair-ball').forEach(ball => {
                    ball.classList.add('selected');
                    selectedGraps.add(ball.dataset.pair);
                });
            });
            
            addBtn?.addEventListener('click', () => {
                addSelectedGraps(selectedGraps);
            });
        }
        
        function addSelectedGraps(selectedGraps) {
            const amountInput = document.getElementById('grap-amount');
            if (!amountInput) return;
            
            const amount = parseInt(amountInput.value);
            
            if (selectedGraps.size === 0) {
                uiHandler.showNotification("Tanpri chwazi omwen yon grap", "warning");
                return;
            }
            
            if (!SecurityUtils.validateBetAmount(amount)) {
                uiHandler.showNotification("Tanpri antre yon kantite valab", "warning");
                return;
            }
            
            selectedGraps.forEach(pair => {
                appState.activeBets.push({
                    type: 'grap',
                    name: 'GRAP',
                    number: pair,
                    amount: amount,
                    multiplier: betTypes.grap.multiplier,
                    draw: appState.currentDraw,
                    drawTime: appState.currentDrawTime
                });
            });
            
            updateBetsList();
            uiHandler.showNotification(`${selectedGraps.size} graps ajoute avèk siksè!`, "success");
            
            // Réinitialiser
            selectedGraps.clear();
            amountInput.value = '1';
            document.getElementById('grap-selection-container')?.querySelectorAll('.pair-ball').forEach(ball => {
                ball.classList.remove('selected');
            });
        }
        
        function addBet(gameType) {
            const bet = betTypes[gameType];
            let number, amount;
            
            switch(gameType) {
                case 'borlette':
                    number = SecurityUtils.sanitizeInput(document.getElementById('borlette-number').value);
                    amount = parseInt(document.getElementById('borlette-amount').value);
                    break;
                    
                case 'boulpe':
                    number = SecurityUtils.sanitizeInput(document.getElementById('boulpe-number').value);
                    amount = parseInt(document.getElementById('boulpe-amount').value);
                    break;
                    
                case 'lotto3':
                    number = SecurityUtils.sanitizeInput(document.getElementById('lotto3-number').value);
                    amount = parseInt(document.getElementById('lotto3-amount').value);
                    break;
                    
                case 'marriage':
                    number = SecurityUtils.sanitizeInput(document.getElementById('marriage-number').value);
                    amount = parseInt(document.getElementById('marriage-amount').value);
                    break;
                    
                case 'lotto4':
                    number = SecurityUtils.sanitizeInput(document.getElementById('lotto4-number').value);
                    amount = parseInt(document.getElementById('lotto4-amount').value);
                    break;
                    
                case 'lotto5':
                    number = SecurityUtils.sanitizeInput(document.getElementById('lotto5-number').value);
                    amount = parseInt(document.getElementById('lotto5-amount').value);
                    break;
            }
            
            // Validation
            if (!number || !SecurityUtils.validateNumber(number, gameType)) {
                uiHandler.showNotification(`Nimewo ${bet.name} pa valab`, "warning");
                return;
            }
            
            if (!SecurityUtils.validateBetAmount(amount)) {
                uiHandler.showNotification("Kantite pa valab (1-" + SECURITY_CONFIG.MAX_BET_AMOUNT + ")", "warning");
                return;
            }
            
            // Vérifier les doublons
            const duplicate = appState.activeBets.find(bet => 
                bet.type === gameType && 
                bet.number === number && 
                bet.draw === appState.currentDraw
            );
            
            if (duplicate) {
                if (confirm("Parye sa a deja ekziste. Vle ajoute kantite a?")) {
                    duplicate.amount += amount;
                    updateBetsList();
                    uiHandler.showNotification("Kantite ajoute avèk siksè!", "success");
                    return;
                }
                return;
            }
            
            appState.activeBets.push({
                type: gameType,
                name: bet.name,
                number: number,
                amount: amount,
                multiplier: bet.multiplier,
                draw: appState.currentDraw,
                drawTime: appState.currentDrawTime
            });
            
            updateBetsList();
            uiHandler.showNotification("Parye ajoute avèk siksè!", "success");
            
            // Retourner aux jeux après un délai
            setTimeout(() => {
                const betForm = document.getElementById('bet-form');
                const gamesInterface = document.getElementById('games-interface');
                if (betForm && gamesInterface) {
                    betForm.style.display = 'none';
                    gamesInterface.style.display = 'block';
                    UIHandler.addGameListeners(gamesInterface);
                }
            }, 500);
        }
        
        function updateBetsList() {
            const bettingScreen = document.getElementById('current-betting-screen');
            if (!bettingScreen) return;
            
            const betsList = bettingScreen.querySelector('#bets-list');
            const betTotal = bettingScreen.querySelector('#bet-total');
            const headerTotal = bettingScreen.querySelector('#header-total-display');
            
            if (!betsList) return;
            
            betsList.innerHTML = '';
            
            if (appState.activeBets.length === 0) {
                betsList.innerHTML = '<p style="text-align: center; padding: 10px; color: #7f8c8d;">Pa gen okenn parye aktif.</p>';
                if (betTotal) betTotal.textContent = '0 goud';
                if (headerTotal) {
                    headerTotal.textContent = 'Total: 0 G';
                    headerTotal.style.display = 'none';
                }
                return;
            }
            
            // Grouper les paris similaires
            const grouped = {};
            appState.activeBets.forEach((bet, index) => {
                const key = `${bet.type}_${bet.number}_${bet.draw}`;
                if (!grouped[key]) {
                    grouped[key] = {
                        bet: bet,
                        count: 1,
                        total: bet.amount,
                        indexes: [index]
                    };
                } else {
                    grouped[key].count++;
                    grouped[key].total += bet.amount;
                    grouped[key].indexes.push(index);
                }
            });
            
            for (const key in grouped) {
                const group = grouped[key];
                const bet = group.bet;
                
                const betItem = document.createElement('div');
                betItem.className = 'bet-item';
                betItem.style.cssText = 'display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee; align-items: center;';
                
                betItem.innerHTML = `
                    <div style="flex: 2;">
                        <strong>${SecurityUtils.escapeHtml(bet.name)}</strong><br>
                        <span>${SecurityUtils.escapeHtml(bet.number)}</span>
                        ${group.count > 1 ? `<small style="color: #666;"> (${group.count}x)</small>` : ''}
                    </div>
                    <div style="flex: 1; text-align: right; font-weight: bold;">
                        ${group.total} goud
                        <span class="bet-remove" style="color: var(--accent-color); margin-left: 10px; cursor: pointer;"
                              data-indexes="${group.indexes.join(',')}">
                            <i class="fas fa-times"></i>
                        </span>
                    </div>
                `;
                
                betsList.appendChild(betItem);
                
                // Écouteur pour supprimer
                betItem.querySelector('.bet-remove').addEventListener('click', function() {
                    const indexes = this.dataset.indexes.split(',').map(Number);
                    indexes.sort((a, b) => b - a).forEach(index => {
                        appState.activeBets.splice(index, 1);
                    });
                    updateBetsList();
                });
            }
            
            const total = appState.activeBets.reduce((sum, bet) => sum + bet.amount, 0);
            if (betTotal) betTotal.textContent = `${total} goud`;
            if (headerTotal) {
                headerTotal.textContent = `Total: ${total} G`;
                headerTotal.style.display = 'block';
            }
        }
        
        async function submitBets() {
            if (appState.activeBets.length === 0) {
                uiHandler.showNotification("Pa gen okenn parye pou soumèt", "warning");
                return;
            }
            
            if (!appState.isSessionValid()) {
                uiHandler.showNotification("Session ekspire. Tanpri rekonekte.", "error");
                showLoginScreen();
                return;
            }
            
            try {
                const ticketData = {
                    agentId: appState.currentAdmin.id,
                    agentName: appState.currentAdmin.name,
                    draw: appState.currentDraw,
                    drawTime: appState.currentDrawTime,
                    bets: appState.activeBets.map(bet => ({
                        type: bet.type,
                        name: bet.name,
                        number: bet.number,
                        amount: bet.amount,
                        multiplier: bet.multiplier
                    })),
                    total: appState.activeBets.reduce((sum, bet) => sum + bet.amount, 0),
                    status: 'pending'
                };
                
                const result = await ApiClient.createTicket(ticketData);
                uiHandler.showNotification("Fiche kreye avèk siksè nan MongoDB!", "success");
                
                // Imprimer le ticket
                printTicket(result.ticket || result);
                
                // Réinitialiser
                appState.activeBets = [];
                closeBettingScreen();
                
            } catch (error) {
                uiHandler.showNotification("Erè lè w ap kreye fiche a: " + error.message, "error");
            }
        }
        
        async function saveAndPrintTicket() {
            if (appState.activeBets.length === 0) {
                uiHandler.showNotification("Pa gen okenn parye pou sove", "warning");
                return;
            }
            
            await submitBets();
        }
        
        function printTicket(ticketData) {
            const printContent = document.createElement('div');
            printContent.style.cssText = `
                font-family: Arial, sans-serif;
                padding: 20px;
                border: 2px solid #000;
                max-width: 300px;
                margin: 0 auto;
            `;
            
            const groupedBets = {};
            (ticketData.bets || []).forEach(bet => {
                if (!groupedBets[bet.name]) {
                    groupedBets[bet.name] = [];
                }
                groupedBets[bet.name].push(bet);
            });
            
            let betsHTML = '';
            for (const [type, bets] of Object.entries(groupedBets)) {
                betsHTML += `
                    <div style="margin-bottom: 10px;">
                        <div style="font-weight: bold; margin-bottom: 5px;">${SecurityUtils.escapeHtml(type)}</div>
                        <div style="display: flex; flex-wrap: wrap; gap: 5px;">
                `;
                
                bets.forEach(bet => {
                    betsHTML += `
                        <div style="background: #f0f0f0; padding: 5px 10px; border-radius: 4px; font-size: 0.9rem; min-width: 60px;">
                            ${SecurityUtils.escapeHtml(bet.number)}<br>
                            <strong>${bet.amount} G</strong>
                        </div>
                    `;
                });
                
                betsHTML += `
                        </div>
                    </div>
                `;
            }
            
            printContent.innerHTML = `
                <div style="text-align: center;">
                    <h2 style="margin: 0 0 10px 0;">NOVA LOTTO</h2>
                    <p style="margin: 0 0 10px 0;">Fiche Parye</p>
                    <p style="margin: 0 0 5px 0;"><strong>Nimewo Fiche:</strong> #${String(ticketData.ticketNumber || '000000').padStart(6, '0')}</p>
                    <p style="margin: 0 0 5px 0;"><strong>Dat:</strong> ${new Date(ticketData.createdAt || Date.now()).toLocaleString('fr-FR')}</p>
                    <p style="margin: 0 0 5px 0;"><strong>Tiraj:</strong> ${draws[ticketData.draw]?.name || 'Inconnu'} (${ticketData.drawTime === 'morning' ? 'Maten' : 'Swè'})</p>
                    <p style="margin: 0 0 15px 0;"><strong>Agent:</strong> ${SecurityUtils.escapeHtml(ticketData.agentName || '')}</p>
                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #000;">
                    <div style="margin: 15px 0;">
                        ${betsHTML}
                    </div>
                    <hr style="margin: 15px 0; border: none; border-top: 1px solid #000;">
                    <div style="display: flex; justify-content: space-between; margin-top: 15px; font-weight: bold; font-size: 1.1rem;">
                        <span>Total:</span>
                        <span>${ticketData.total || 0} goud</span>
                    </div>
                    <p style="margin-top: 20px; font-size: 0.9rem;">Mèsi pou konfyans ou!</p>
                </div>
            `;
            
            // Impression sécurisée avec fallback
            try {
                const printWindow = window.open('', '_blank', 'width=400,height=600');
                if (!printWindow) {
                    throw new Error('Pop-up bloqué. Activez les pop-ups pour imprimer.');
                }
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Fiche Nova Lotto</title>
                        <style>
                            body { 
                                font-family: Arial, sans-serif; 
                                margin: 0; 
                                padding: 20px;
                                -webkit-print-color-adjust: exact;
                            }
                            @media print {
                                body { margin: 0; padding: 0; }
                                @page { margin: 0; size: auto; }
                            }
                        </style>
                    </head>
                    <body>
                        ${printContent.innerHTML}
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(function() {
                                    window.close();
                                }, 1000);
                            };
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
            } catch (error) {
                uiHandler.showNotification("Erè enprimasyon: " + error.message, "warning");
                
                // Fallback: Afficher le contenu
                const fallbackDiv = document.createElement('div');
                fallbackDiv.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 9999; overflow: auto; padding: 20px;';
                fallbackDiv.innerHTML = `
                    <div style="text-align: center; margin-bottom: 20px;">
                        <button onclick="this.parentElement.parentElement.remove()" style="padding: 10px 20px; background: var(--accent-color); color: white; border: none; border-radius: 5px; cursor: pointer;">
                            Fèmen
                        </button>
                        <button onclick="window.print()" style="padding: 10px 20px; background: var(--success-color); color: white; border: none; border-radius: 5px; cursor: pointer; margin-left: 10px;">
                            Enprime
                        </button>
                    </div>
                    ${printContent.innerHTML}
                `;
                document.body.appendChild(fallbackDiv);
            }
        }
        
        function closeBettingScreen() {
            const bettingScreen = document.getElementById('current-betting-screen');
            if (bettingScreen) {
                bettingScreen.classList.remove('slide-in');
                bettingScreen.classList.add('slide-out');
                
                setTimeout(() => {
                    bettingScreen.remove();
                    document.querySelector('.container').style.display = 'block';
                }, 300);
            }
            
            appState.activeBets = [];
        }
        
        function showAutoGameForm(gameType) {
            uiHandler.showNotification("Fonksyon sa a ap disponib pi ta", "info");
        }
        
        // ============================================================================
        // FONCTIONS GLOBALES EXPOSÉES
        // ============================================================================
        window.handleDeleteTicket = async function(ticketId) {
            if (!confirm("Èske w sèten ou vle efase fiche sa a?")) return;
            
            try {
                await ApiClient.deleteTicket(ticketId);
                uiHandler.showNotification("Fiche efase avèk siksè!", "success");
                await uiHandler.loadAgentTickets();
            } catch (error) {
                uiHandler.showNotification("Pa kapab efase fiche a: " + error.message, "error");
            }
        };
        
        window.handleReprintTicket = async function(ticketId) {
            try {
                // Note: Cette route doit exister dans votre API
                const response = await ApiClient.request(`${APP_CONFIG.tickets}/${ticketId}`);
                printTicket(response);
            } catch (error) {
                uiHandler.showNotification("Erè re-enprimasyon: " + error.message, "error");
            }
        };
        
        window.printEndOfDrawReport = function(report) {
            try {
                const printWindow = window.open('', '_blank');
                if (!printWindow) {
                    throw new Error('Pop-up bloqué');
                }
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <title>Rapport Fin Tirage</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                            @media print {
                                body { margin: 0; padding: 0; }
                                @page { margin: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        <div style="text-align: center; padding: 20px; border: 2px solid #000;">
                            <h1>NOVA LOTTO</h1>
                            <h3>Rapport de fin tirage</h3>
                            <p><strong>Date:</strong> ${new Date(report.date || Date.now()).toLocaleDateString('fr-FR')}</p>
                            <p><strong>D. Impression:</strong> ${new Date().toLocaleString('fr-FR')}</p>
                            <p><strong>Agent:</strong> ${SecurityUtils.escapeHtml(appState.currentAdmin?.name || '')}</p>
                            <hr>
                            <p><strong>#Fiche vendues:</strong> ${report.totalTickets || 0}</p>
                            <p><strong>#Fiche gagnantes:</strong> ${report.winningTickets || 0}</p>
                            <p><strong>Ventes:</strong> ${report.totalSales || 0} G</p>
                            <p><strong>Paiements:</strong> ${report.totalPayouts || 0} G</p>
                            <p><strong>Profit/Perte:</strong> <span style="${(report.netProfit || 0) >= 0 ? 'color: green;' : 'color: red;'}">${report.netProfit || 0} G</span></p>
                        </div>
                        <script>
                            window.onload = function() {
                                window.print();
                                setTimeout(() => window.close(), 1000);
                            };
                        <\/script>
                    </body>
                    </html>
                `);
                printWindow.document.close();
                
            } catch (error) {
                uiHandler.showNotification("Erè enprimasyon rapò: " + error.message, "warning");
            }
        };
        
        // ============================================================================
        // INTERVALLES PERIODIQUES
        // ============================================================================
        setInterval(() => {
            uiHandler.updateDrawCountdowns();
        }, 60000); // Toutes les minutes
        
        setInterval(async () => {
            await uiHandler.loadLatestResults();
            await checkForWinners();
        }, 30000); // Toutes les 30 secondes
        
        async function checkForWinners() {
            if (!appState.currentAdmin?.id) return;
            
            try {
                const winners = await ApiClient.checkForWinners(appState.currentAdmin.id);
                if (winners && winners.length > 0) {
                    showWinnersNotification(winners);
                }
            } catch (error) {
                console.warn("Erreur vérification gagnants:", error.message);
            }
        }
        
        function showWinnersNotification(winners) {
            const container = document.getElementById('winners-notification-container');
            if (!container) return;
            
            winners.forEach(winner => {
                const notification = document.createElement('div');
                notification.className = 'notification success';
                notification.innerHTML = `
                    <i class="fas fa-trophy"></i>
                    <span>
                        <strong>FICHE GAGNANT!</strong><br>
                        Fiche #${String(winner.ticket?.ticketNumber || '000000').padStart(6, '0')} genyen ${winner.totalWinnings || 0} G!
                    </span>
                `;
                
                container.appendChild(notification);
                container.style.display = 'block';
                
                setTimeout(() => {
                    notification.remove();
                    if (container.children.length === 0) {
                        container.style.display = 'none';
                    }
                }, 10000);
            });
            
            // Recharger les tickets gagnants
            uiHandler.loadWinningTickets();
        }
    </script>
</body>
</html>