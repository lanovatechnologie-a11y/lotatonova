<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOTATO - Agent</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* [Tous les styles CSS restent identiques - trop longs pour être répétés] */
        /* Les styles CSS sont corrects, pas besoin de les modifier */
    </style>
</head>
<body>
    <!-- Écran de connexion -->
    <div class="login-screen" id="login-screen">
        <div class="login-container">
            <div class="login-logo">
                <div class="logo">
                    <i class="fas fa-dice"></i>
                </div>
            </div>
            <h2 class="login-title">LOTATO - Agent</h2>
            <div class="login-error" id="login-error">
                Identifiant ou mot de passe incorrect
            </div>
            <div class="form-group">
                <label for="admin-username">Identifiant</label>
                <input type="text" id="admin-username" placeholder="admin">
            </div>
            <div class="form-group">
                <label for="admin-password">Mot de passe</label>
                <input type="password" id="admin-password" placeholder="••••••••">
            </div>
            <button class="submit-bet" id="login-btn">Konekte</button>
        </div>
    </div>
    
    <!-- Indicateur de synchronisation -->
    <div class="sync-status sync-disconnected" id="sync-status" style="display: none;">
        <i class="fas fa-cloud"></i> <span id="sync-text">Pa Konekte</span>
    </div>
    
    <!-- Interface principale -->
    <div class="container" id="main-container" style="display: none;">
        <header>
            <div class="header-content">
                <div class="logo-container">
                    <div class="logo">
                        <i class="fas fa-dice"></i>
                    </div>
                </div>
                <div class="header-text">
                    <h1 id="company-name">LOTATO</h1>
                    <p>Agent: <span id="agent-name">-</span></p>
                </div>
            </div>
            <div class="time-display">
                <i class="fas fa-clock"></i> <span id="current-time">Chargement...</span>
            </div>
        </header>
        
        <!-- Panel multi-tirage -->
        <div class="multi-draw-panel">
            <div class="multi-draw-header">
                <h3 class="multi-draw-title">Jwe nan Plizyè Tiraj</h3>
                <button class="multi-draw-toggle" id="multi-draw-toggle">
                    <i class="fas fa-chevron-down"></i>
                </button>
            </div>
            <div class="multi-draw-content" id="multi-draw-content">
                <div class="multi-draw-grid" id="multi-draw-options"></div>
                <div class="multi-game-select" id="multi-game-select"></div>
                <div class="multi-draw-form">
                    <div class="form-group" id="multi-number-inputs"></div>
                    <div class="form-group">
                        <label for="multi-draw-amount">Kantite pa tiraj</label>
                        <input type="number" id="multi-draw-amount" placeholder="Kantite" min="1" value="1">
                    </div>
                    <div class="bet-actions">
                        <button class="btn-primary" id="add-multi-draw">Ajoute nan Tout Tiraj</button>
                    </div>
                    <button class="multi-draw-print-btn" id="print-multi-draw-ticket" style="display: none;">
                        <i class="fas fa-print"></i> Enprime Fiche Multi-Tiraj
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Cartes des tirages -->
        <div class="draws-container">
            <div class="draw-card miami" data-draw="miami">
                <div class="draw-icon"><i class="fas fa-sun"></i></div>
                <h3>Miami</h3>
                <div class="draw-buttons">
                    <button class="draw-btn morning active" data-time="morning">1:30 PM</button>
                    <button class="draw-btn evening" data-time="evening">9:50 PM</button>
                </div>
                <div class="draw-countdown" id="miami-countdown">-</div>
            </div>
            
            <div class="draw-card georgia" data-draw="georgia">
                <div class="draw-icon"><i class="fas fa-map-marker-alt"></i></div>
                <h3>Georgia</h3>
                <div class="draw-buttons">
                    <button class="draw-btn morning active" data-time="morning">12:30 PM</button>
                    <button class="draw-btn evening" data-time="evening">7:00 PM</button>
                </div>
                <div class="draw-countdown" id="georgia-countdown">-</div>
            </div>
            
            <div class="draw-card newyork" data-draw="newyork">
                <div class="draw-icon"><i class="fas fa-building"></i></div>
                <h3>New York</h3>
                <div class="draw-buttons">
                    <button class="draw-btn morning active" data-time="morning">2:30 PM</button>
                    <button class="draw-btn evening" data-time="evening">8:00 PM</button>
                </div>
                <div class="draw-countdown" id="newyork-countdown">-</div>
            </div>
            
            <div class="draw-card texas" data-draw="texas">
                <div class="draw-icon"><i class="fas fa-hat-cowboy"></i></div>
                <h3>Texas</h3>
                <div class="draw-buttons">
                    <button class="draw-btn morning active" data-time="morning">12:00 PM</button>
                    <button class="draw-btn evening" data-time="evening">6:00 PM</button>
                </div>
                <div class="draw-countdown" id="texas-countdown">-</div>
            </div>
            
            <div class="draw-card tunisia" data-draw="tunisia">
                <div class="draw-icon"><i class="fas fa-flag"></i></div>
                <h3>Tunisie</h3>
                <div class="draw-buttons">
                    <button class="draw-btn morning active" data-time="morning">10:30 AM</button>
                    <button class="draw-btn evening" data-time="evening">2:00 PM</button>
                </div>
                <div class="draw-countdown" id="tunisia-countdown">-</div>
            </div>
        </div>
        
        <!-- Derniers résultats -->
        <div class="results-section">
            <div class="section-title">
                <i class="fas fa-trophy"></i>
                <h2>Dènye Rezilta</h2>
            </div>
            <div class="results-grid" id="latest-results"></div>
            <div class="ticket-actions" style="margin-top: 15px;">
                <button class="ticket-action-btn save-print-btn" id="generate-report-btn">
                    <i class="fas fa-file-alt"></i> Jenere Rapò Fin Tiraj
                </button>
            </div>
        </div>
        
        <div id="winners-notification-container" style="display: none;"></div>
    </div>
    
    <!-- Navigation du bas -->
    <div class="bottom-nav" id="bottom-nav" style="display: none;">
        <div class="nav-item active" data-screen="home">
            <div class="nav-icon"><i class="fas fa-home"></i></div>
            <span>Akèy</span>
        </div>
        <div class="nav-item" data-screen="winning-tickets">
            <div class="nav-icon"><i class="fas fa-trophy"></i></div>
            <span>Fiche Gagnant</span>
        </div>
        <div class="nav-item" data-screen="history">
            <div class="nav-icon"><i class="fas fa-history"></i></div>
            <span>Istorik</span>
        </div>
        <div class="nav-item" data-screen="ticket-management">
            <div class="nav-icon"><i class="fas fa-file-invoice"></i></div>
            <span>Jesyon Fiche</span>
        </div>
    </div>
    
    <!-- Écran de pari -->
    <div class="betting-screen" id="betting-screen">
        <div class="betting-header">
            <button class="back-button" id="back-button"><i class="fas fa-arrow-left"></i></button>
            <h2 class="betting-title" id="betting-title">Mete Paryaj ou</h2>
            <div class="total-display" id="header-total-display">Total: 0 G</div>
            <div style="margin-left: auto;">
                <button class="submit-bet" id="confirm-bet-top" style="padding: 8px 15px; font-size: 0.9rem;">
                    <i class="fas fa-check"></i> Konfime Parye
                </button>
            </div>
        </div>
        
        <!-- Interface des jeux -->
        <div id="games-interface" class="all-categories-container">
            <!-- Borlette -->
            <div class="game-category" id="borlette-category">
                <div class="game-category-title">BORLETTE</div>
                <div class="game-category-grid">
                    <div class="game-item borlette" data-game="borlette">
                        <div class="game-name">BORLETTE</div>
                        <div class="game-multiplier">x 60</div>
                        <small>2 chif (1er lot)</small>
                    </div>
                    <div class="game-item borlette" data-game="boulpe">
                        <div class="game-name">BOUL PE</div>
                        <div class="game-multiplier">x 60</div>
                        <small>Boul pe (00-99)</small>
                    </div>
                </div>
            </div>
            
            <!-- Lotto -->
            <div class="game-category" id="lotto-category">
                <div class="game-category-title">LOTTO</div>
                <div class="game-category-grid">
                    <div class="game-item lotto" data-game="lotto3">
                        <div class="game-name">LOTO 3</div>
                        <div class="game-multiplier">x 500</div>
                        <small>3 chif (ex: 123)</small>
                    </div>
                    <div class="game-item lotto" data-game="lotto4">
                        <div class="game-name">LOTO 4</div>
                        <div class="game-multiplier">x 5000</div>
                        <small>4 chif (2+2 boules)</small>
                    </div>
                    <div class="game-item lotto" data-game="lotto5">
                        <div class="game-name">LOTO 5</div>
                        <div class="game-multiplier">x 25000</div>
                        <small>5 chif (3+2 boules)</small>
                    </div>
                </div>
            </div>
            
            <!-- Jeux spéciaux -->
            <div class="game-category" id="special-category">
                <div class="game-category-title">JEUX SPÉCIAUX</div>
                <div class="game-category-grid">
                    <div class="game-item special" data-game="grap">
                        <div class="game-name">GRAP</div>
                        <div class="game-multiplier">x 500</div>
                        <small>Boule paire (111, 222...)</small>
                    </div>
                    <div class="game-item special" data-game="marriage">
                        <div class="game-name">MARYAJ</div>
                        <div class="game-multiplier">x 1000</div>
                        <small>Maryaj 2 chif</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Formulaires de pari -->
        <div class="bet-form" id="bet-form"></div>
        
        <!-- Liste des paris actifs -->
        <div class="active-bets" id="active-bets">
            <div class="ticket-actions">
                <button class="ticket-action-btn save-print-btn" id="save-print-ticket">Enprime Fiche</button>
            </div>
            <h3>Parye Aktif</h3>
            <div id="bets-list"></div>
            <div class="bet-total">
                <span>Total:</span>
                <span id="bet-total">0 goud</span>
            </div>
        </div>
    </div>
    
    <!-- Écrans supplémentaires -->
    <div class="screen" id="ticket-management-screen">
        <div class="screen-header">
            <button class="back-button" data-screen="home"><i class="fas fa-arrow-left"></i></button>
            <h2 class="screen-title">Jesyon Fiche</h2>
        </div>
        <div id="ticket-management-list"></div>
    </div>
    
    <div class="screen" id="winning-tickets-screen">
        <div class="screen-header">
            <button class="back-button" data-screen="home"><i class="fas fa-arrow-left"></i></button>
            <h2 class="screen-title">Fiche Genyen</h2>
        </div>
        <div id="winning-tickets-list"></div>
    </div>
    
    <div class="screen" id="history-screen">
        <div class="screen-header">
            <button class="back-button" data-screen="home"><i class="fas fa-arrow-left"></i></button>
            <h2 class="screen-title">Istorik Parye</h2>
        </div>
        <div id="history-list"></div>
    </div>
    
    <div class="report-screen" id="report-screen">
        <div class="screen-header">
            <button class="back-button" id="back-from-report"><i class="fas fa-arrow-left"></i></button>
            <h2 class="screen-title">Rapò Fin Tiraj</h2>
        </div>
        <div class="report-container" id="report-content"></div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        const API_BASE_URL = 'https://lotatonova-fv0b.onrender.com';
        const APP_CONFIG = {
            login: `${API_BASE_URL}/api/auth/login`,
            verifyToken: `${API_BASE_URL}/api/auth/verify-token`,
            tickets: `${API_BASE_URL}/api/tickets`,
            results: `${API_BASE_URL}/api/results`,
            winners: `${API_BASE_URL}/api/winners`,
            reports: `${API_BASE_URL}/api/reports`
        };

        // ============================================
        // VARIABLES GLOBALES
        // ============================================
        let currentDraw = null;
        let currentDrawTime = null;
        let activeBets = [];
        let currentAdmin = null;
        let selectedMultiDraws = new Set();
        let selectedMultiGame = 'borlette';
        let latestResults = {};

        // ============================================
        // TYPES DE PARIS
        // ============================================
        const betTypes = {
            borlette: {
                name: "BORLETTE",
                multiplier: 60,
                icon: "fas fa-dice",
                description: "2 chif (1er lot seulement)",
                category: "borlette",
                validate: (number) => /^\d{2}$/.test(number)
            },
            boulpe: {
                name: "BOUL PE",
                multiplier: 60,
                icon: "fas fa-circle",
                description: "Boul pe (00-99)",
                category: "borlette",
                validate: (number) => /^\d{2}$/.test(number) && number[0] === number[1]
            },
            lotto3: {
                name: "LOTO 3",
                multiplier: 500,
                icon: "fas fa-list-ol",
                description: "3 chif (ex: 123)",
                category: "lotto",
                validate: (number) => /^\d{3}$/.test(number)
            },
            grap: {
                name: "GRAP",
                multiplier: 500,
                icon: "fas fa-chart-line",
                description: "Grap boule paire (111, 222, ..., 000)",
                category: "special",
                validate: (number) => /^\d{3}$/.test(number) && number[0] === number[1] && number[1] === number[2]
            },
            marriage: {
                name: "MARYAJ",
                multiplier: 1000,
                icon: "fas fa-link",
                description: "Maryaj 2 chif (ex: 12*34)",
                category: "special",
                validate: (numbers) => {
                    const [num1, num2] = numbers.split('*');
                    return /^\d{2}$/.test(num1) && /^\d{2}$/.test(num2);
                }
            },
            lotto4: {
                name: "LOTO 4",
                multiplier: 5000,
                icon: "fas fa-list-ol",
                description: "4 chif (2+2 boules)",
                category: "lotto",
                validate: (numbers) => {
                    const [num1, num2] = numbers.split('*');
                    return /^\d{2}$/.test(num1) && /^\d{2}$/.test(num2);
                }
            },
            lotto5: {
                name: "LOTO 5",
                multiplier: 25000,
                icon: "fas fa-list-ol",
                description: "5 chif (3+2 boules)",
                category: "lotto",
                validate: (numbers) => {
                    const [num1, num2] = numbers.split('*');
                    return /^\d{3}$/.test(num1) && /^\d{2}$/.test(num2);
                }
            }
        };

        // ============================================
        // CONFIGURATION DES TIRAGES
        // ============================================
        const draws = {
            miami: {
                name: "Miami",
                times: { morning: "1:30 PM", evening: "9:50 PM" }
            },
            georgia: {
                name: "Georgia",
                times: { morning: "12:30 PM", evening: "7:00 PM" }
            },
            newyork: {
                name: "New York",
                times: { morning: "2:30 PM", evening: "8:00 PM" }
            },
            texas: {
                name: "Texas",
                times: { morning: "12:00 PM", evening: "6:00 PM" }
            },
            tunisia: {
                name: "Tunisie",
                times: { morning: "10:30 AM", evening: "2:00 PM" }
            }
        };

        // ============================================
        // INITIALISATION
        // ============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("LOTATO Agent - Initialisation...");
            
            checkExistingSession();
            updateCurrentTime();
            setupEventListeners();
            
            // Initialiser les compteurs
            updateDrawCountdowns();
            setInterval(updateCurrentTime, 60000);
            setInterval(updateDrawCountdowns, 60000);
            
            console.log("Initialisation terminée");
        });

        // ============================================
        // GESTION DES ÉVÉNEMENTS
        // ============================================
        function setupEventListeners() {
            // Connexion
            document.getElementById('login-btn').addEventListener('click', adminLogin);
            document.getElementById('admin-password').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') adminLogin();
            });
            
            // Tirages
            document.querySelectorAll('.draw-card').forEach(card => {
                card.addEventListener('click', function() {
                    const drawId = this.getAttribute('data-draw');
                    openBettingScreen(drawId, 'morning');
                });
            });
            
            document.querySelectorAll('.draw-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const card = this.closest('.draw-card');
                    const drawId = card.getAttribute('data-draw');
                    const time = this.getAttribute('data-time');
                    
                    card.querySelectorAll('.draw-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    openBettingScreen(drawId, time);
                });
            });
            
            // Navigation
            document.getElementById('back-button').addEventListener('click', closeBettingScreen);
            document.getElementById('confirm-bet-top').addEventListener('click', submitBets);
            document.getElementById('save-print-ticket').addEventListener('click', saveAndPrintTicket);
            document.getElementById('generate-report-btn').addEventListener('click', generateEndOfDrawReport);
            
            // Navigation du bas
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen');
                    showScreen(screen);
                });
            });
            
            // Boutons retour
            document.querySelectorAll('.back-button').forEach(btn => {
                btn.addEventListener('click', function() {
                    const screen = this.getAttribute('data-screen') || 'home';
                    showScreen(screen);
                });
            });
            
            // Multi-tirage
            document.getElementById('multi-draw-toggle').addEventListener('click', toggleMultiDrawPanel);
            document.getElementById('add-multi-draw').addEventListener('click', addToMultipleDraws);
            document.getElementById('print-multi-draw-ticket').addEventListener('click', printMultiDrawTicket);
            
            // Initialiser le panel multi-tirage
            initMultiDrawPanel();
        }

        // ============================================
        // FONCTIONS D'AUTHENTIFICATION
        // ============================================
        async function checkExistingSession() {
            try {
                const savedAdmin = localStorage.getItem('lotatoAgent');
                if (savedAdmin) {
                    const admin = JSON.parse(savedAdmin);
                    const response = await fetch(APP_CONFIG.verifyToken, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ token: admin.token })
                    });
                    
                    if (response.ok) {
                        currentAdmin = admin;
                        showMainApp();
                        return;
                    }
                }
            } catch (error) {
                console.error("Erreur vérification session:", error);
            }
            
            document.getElementById('login-screen').style.display = 'flex';
        }

        async function adminLogin() {
            const username = document.getElementById('admin-username').value.trim();
            const password = document.getElementById('admin-password').value.trim();
            
            if (!username || !password) {
                showLoginError("Tanpri antre identifian ak modpas la");
                return;
            }
            
            try {
                const response = await fetch(APP_CONFIG.login, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentAdmin = {
                        id: data.user._id || data.user.id,
                        username: data.user.username,
                        name: data.user.name || data.user.username,
                        token: data.token
                    };
                    
                    localStorage.setItem('lotatoAgent', JSON.stringify(currentAdmin));
                    showMainApp();
                    showNotification("Koneksyon reyisi!", "success");
                    document.getElementById('agent-name').textContent = currentAdmin.name;
                    
                } else {
                    const errorData = await response.json();
                    showLoginError(errorData.message || "Identifian oswa modpas la pa kòrèk");
                }
            } catch (error) {
                console.error("Erreur connexion:", error);
                showLoginError("Erè koneksyon. Tcheke entènèt la");
            }
        }

        function showMainApp() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-container').style.display = 'block';
            document.getElementById('bottom-nav').style.display = 'flex';
            document.getElementById('sync-status').style.display = 'flex';
            
            updateSyncStatus(true);
            loadLatestResults();
        }

        // ============================================
        // FONCTIONS D'UTILITÉ
        // ============================================
        function updateCurrentTime() {
            const now = new Date();
            const options = { weekday: 'long', year: 'numeric', month: 'short', day: 'numeric' };
            const dateString = now.toLocaleDateString('fr-FR', options);
            const timeString = now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('current-time').textContent = `${dateString} - ${timeString}`;
        }

        function updateDrawCountdowns() {
            const now = new Date();
            
            Object.keys(draws).forEach(drawId => {
                const countdownElement = document.getElementById(`${drawId}-countdown`);
                if (countdownElement) {
                    // Simuler des temps restants pour la démonstration
                    const hours = Math.floor(Math.random() * 6);
                    const minutes = Math.floor(Math.random() * 60);
                    countdownElement.textContent = `${hours}h ${minutes}min`;
                }
            });
        }

        async function loadLatestResults() {
            try {
                const response = await fetch(`${APP_CONFIG.results}/latest`);
                if (response.ok) {
                    const results = await response.json();
                    latestResults = results;
                    updateResultsDisplay(results);
                }
            } catch (error) {
                console.error("Erreur chargement résultats:", error);
                // Données simulées pour la démonstration
                const mockResults = {};
                Object.keys(draws).forEach(drawId => {
                    mockResults[drawId] = {
                        first: String(Math.floor(Math.random() * 100)).padStart(2, '0'),
                        second: String(Math.floor(Math.random() * 100)).padStart(2, '0'),
                        third: String(Math.floor(Math.random() * 100)).padStart(2, '0')
                    };
                });
                updateResultsDisplay(mockResults);
            }
        }

        function updateResultsDisplay(results) {
            const resultsGrid = document.getElementById('latest-results');
            resultsGrid.innerHTML = '';
            
            Object.keys(draws).forEach(drawId => {
                const draw = draws[drawId];
                const result = results[drawId] || { first: '--', second: '--', third: '--' };
                
                const resultCard = document.createElement('div');
                resultCard.className = 'result-card';
                resultCard.innerHTML = `
                    <h4>${draw.name}</h4>
                    <div class="result-number">${result.first}</div>
                    <small>${result.second} / ${result.third}</small>
                `;
                resultsGrid.appendChild(resultCard);
            });
        }

        // ============================================
        // GESTION DES PARIS
        // ============================================
        function openBettingScreen(drawId, time = 'morning') {
            currentDraw = drawId;
            currentDrawTime = time;
            const draw = draws[drawId];
            
            let title = draw.name;
            if (time) {
                title += ` (${time === 'morning' ? 'Maten' : 'Swè'})`;
            }
            document.getElementById('betting-title').textContent = title;
            
            const bettingScreen = document.getElementById('betting-screen');
            bettingScreen.style.display = 'block';
            bettingScreen.classList.remove('slide-out');
            bettingScreen.classList.add('slide-in');
            
            document.querySelector('.container').style.display = 'none';
            
            document.getElementById('games-interface').style.display = 'block';
            document.getElementById('bet-form').style.display = 'none';
            document.getElementById('active-bets').style.display = 'block';
            
            initializeGameListeners();
            updateBetsList();
        }

        function initializeGameListeners() {
            document.querySelectorAll('.game-item').forEach(item => {
                item.addEventListener('click', function() {
                    const gameType = this.getAttribute('data-game');
                    showBetForm(gameType);
                });
            });
        }

        function showBetForm(gameType) {
            const bet = betTypes[gameType];
            
            document.getElementById('games-interface').style.display = 'none';
            document.getElementById('bet-form').style.display = 'block';
            
            let formHTML = '';
            
            switch(gameType) {
                case 'borlette':
                    formHTML = `
                        <h3>${bet.name} - ${bet.description}</h3>
                        <div class="quick-bet-form">
                            <input type="text" id="bet-number" class="quick-number-input" placeholder="00" maxlength="2" pattern="[0-9]{2}">
                            <input type="number" id="bet-amount" class="quick-amount-input" placeholder="Kantite" min="1">
                            <button class="btn-primary" id="add-bet">Ajoute</button>
                        </div>
                        <div class="bet-actions">
                            <button class="btn-secondary" id="return-to-types">Retounen</button>
                        </div>
                    `;
                    break;
                    
                case 'lotto3':
                    formHTML = `
                        <h3>${bet.name} - ${bet.description}</h3>
                        <div class="quick-bet-form">
                            <input type="text" id="bet-number" class="quick-number-input" 
                                   placeholder="000" maxlength="3" pattern="[0-9]{3}">
                            <input type="number" id="bet-amount" class="quick-amount-input" 
                                   placeholder="Kantite" min="1">
                            <button class="btn-primary" id="add-bet">Ajoute</button>
                        </div>
                        <div class="bet-actions">
                            <button class="btn-secondary" id="return-to-types">Retounen</button>
                        </div>
                    `;
                    break;
                    
                case 'marriage':
                case 'lotto4':
                    formHTML = `
                        <h3>${bet.name} - ${bet.description}</h3>
                        <div class="form-group">
                            <label>2 Nimewo</label>
                            <div class="number-inputs">
                                <input type="text" id="bet-number1" placeholder="00" maxlength="2" pattern="[0-9]{2}">
                                <input type="text" id="bet-number2" placeholder="00" maxlength="2" pattern="[0-9]{2}">
                            </div>
                        </div>
                        <div class="quick-bet-form">
                            <input type="number" id="bet-amount" class="quick-amount-input" placeholder="Kantite" min="1">
                            <button class="btn-primary" id="add-bet">Ajoute</button>
                        </div>
                        <div class="bet-actions">
                            <button class="btn-secondary" id="return-to-types">Retounen</button>
                        </div>
                    `;
                    break;
                    
                case 'lotto5':
                    formHTML = `
                        <h3>${bet.name} - ${bet.description}</h3>
                        <div class="form-group">
                            <label>5 Chif (3+2 boules)</label>
                            <div class="number-inputs">
                                <input type="text" id="bet-number1" placeholder="000" maxlength="3" pattern="[0-9]{3}">
                                <input type="text" id="bet-number2" placeholder="00" maxlength="2" pattern="[0-9]{2}">
                            </div>
                        </div>
                        <div class="quick-bet-form">
                            <input type="number" id="bet-amount" class="quick-amount-input" placeholder="Kantite" min="1">
                            <button class="btn-primary" id="add-bet">Ajoute</button>
                        </div>
                        <div class="bet-actions">
                            <button class="btn-secondary" id="return-to-types">Retounen</button>
                        </div>
                    `;
                    break;
                    
                case 'grap':
                    formHTML = `
                        <h3>${bet.name} - ${bet.description}</h3>
                        <div style="margin-bottom: 15px;">
                            <div class="all-graps-btn" id="select-all-graps">
                                <i class="fas fa-check-square"></i> Chwazi Tout Graps
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px;" id="grap-selection-container">
                            ${['111', '222', '333', '444', '555', '666', '777', '888', '999', '000'].map(pair => `
                                <div class="pair-ball" data-pair="${pair}">${pair}</div>
                            `).join('')}
                        </div>
                        
                        <div class="form-group">
                            <label for="grap-amount">Kantite pou chak grap</label>
                            <input type="number" id="grap-amount" placeholder="Kantite" min="1" value="1">
                        </div>
                        
                        <div class="bet-actions">
                            <button class="btn-primary" id="add-selected-graps">Ajoute Graps Chwazi</button>
                            <button class="btn-secondary" id="return-to-types">Retounen</button>
                        </div>
                    `;
                    break;
            }
            
            document.getElementById('bet-form').innerHTML = formHTML;
            
            // Configurer les événements spécifiques au formulaire
            if (gameType === 'grap') {
                setupGrapSelection();
            } else {
                const addButton = document.getElementById('add-bet');
                if (addButton) {
                    addButton.addEventListener('click', function() {
                        addBet(gameType);
                    });
                }
            }
            
            const returnButton = document.getElementById('return-to-types');
            if (returnButton) {
                returnButton.addEventListener('click', function() {
                    document.getElementById('bet-form').style.display = 'none';
                    document.getElementById('games-interface').style.display = 'block';
                    initializeGameListeners();
                });
            }
        }

        function addBet(betType) {
            const bet = betTypes[betType];
            let number, amount;
            
            switch(betType) {
                case 'borlette':
                case 'boulpe':
                case 'lotto3':
                case 'grap':
                    number = document.getElementById('bet-number').value;
                    amount = parseInt(document.getElementById('bet-amount').value);
                    break;
                    
                case 'marriage':
                case 'lotto4':
                    const num1 = document.getElementById('bet-number1').value;
                    const num2 = document.getElementById('bet-number2').value;
                    number = `${num1}*${num2}`;
                    amount = parseInt(document.getElementById('bet-amount').value);
                    break;
                    
                case 'lotto5':
                    const num5_1 = document.getElementById('bet-number1').value;
                    const num5_2 = document.getElementById('bet-number2').value;
                    number = `${num5_1}*${num5_2}`;
                    amount = parseInt(document.getElementById('bet-amount').value);
                    break;
            }
            
            // Validation
            if (!bet.validate(number)) {
                showNotification("Nimewo a pa valab!", "warning");
                return;
            }
            
            if (!number || isNaN(amount) || amount <= 0) {
                showNotification("Tanpri rantre yon nimewo ak yon kantite valab", "warning");
                return;
            }
            
            activeBets.push({
                type: betType,
                name: bet.name,
                number: number,
                amount: amount,
                multiplier: bet.multiplier,
                draw: currentDraw,
                drawTime: currentDrawTime
            });
            
            updateBetsList();
            showNotification("Parye ajoute avèk siksè!", "success");
            
            setTimeout(() => {
                document.getElementById('bet-form').style.display = 'none';
                document.getElementById('games-interface').style.display = 'block';
                initializeGameListeners();
            }, 500);
        }

        function updateBetsList() {
            const betsList = document.getElementById('bets-list');
            const betTotal = document.getElementById('bet-total');
            const headerTotal = document.getElementById('header-total-display');
            
            betsList.innerHTML = '';
            
            if (activeBets.length === 0) {
                betsList.innerHTML = '<p>Pa gen okenn parye aktif.</p>';
                betTotal.textContent = '0 goud';
                if (headerTotal) {
                    headerTotal.textContent = 'Total: 0 G';
                    headerTotal.style.display = 'none';
                }
                return;
            }
            
            let total = 0;
            
            activeBets.forEach((bet, index) => {
                const betItem = document.createElement('div');
                betItem.className = 'bet-item';
                
                betItem.innerHTML = `
                    <div class="bet-details">
                        <strong>${bet.name}</strong><br>
                        ${bet.number}
                    </div>
                    <div class="bet-amount">
                        ${bet.amount} goud
                        <span class="bet-remove" data-index="${index}"><i class="fas fa-times"></i></span>
                    </div>
                `;
                
                betsList.appendChild(betItem);
                total += bet.amount;
                
                const removeBtn = betItem.querySelector('.bet-remove');
                removeBtn.addEventListener('click', function() {
                    const index = parseInt(this.getAttribute('data-index'));
                    activeBets.splice(index, 1);
                    updateBetsList();
                });
            });
            
            betTotal.textContent = `${total} goud`;
            
            if (headerTotal) {
                headerTotal.textContent = `Total: ${total} G`;
                headerTotal.style.display = 'block';
            }
        }

        async function submitBets() {
            if (activeBets.length === 0) {
                showNotification("Pa gen okenn parye pou soumèt", "warning");
                return;
            }
            
            try {
                const ticketData = {
                    agentId: currentAdmin.id,
                    agentName: currentAdmin.name,
                    draw: currentDraw,
                    drawTime: currentDrawTime,
                    bets: activeBets,
                    total: activeBets.reduce((sum, bet) => sum + bet.amount, 0),
                    status: 'pending',
                    createdAt: new Date().toISOString()
                };
                
                const response = await fetch(APP_CONFIG.tickets, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${currentAdmin.token}`
                    },
                    body: JSON.stringify(ticketData)
                });
                
                if (response.ok) {
                    const result = await response.json();
                    showNotification("Fiche kreye avèk siksè!", "success");
                    
                    printTicket(result.ticket || ticketData);
                    
                    activeBets = [];
                    updateBetsList();
                    closeBettingScreen();
                    
                } else {
                    const error = await response.json();
                    showNotification(error.message || "Erè lè w ap kreye fiche a", "error");
                }
            } catch (error) {
                console.error("Erreur soumission:", error);
                showNotification("Erè koneksyon. Tcheke entènèt la", "error");
            }
        }

        function saveAndPrintTicket() {
            if (activeBets.length === 0) {
                showNotification("Pa gen okenn parye pou sove", "warning");
                return;
            }
            
            submitBets();
        }

        function printTicket(ticketData) {
            const printWindow = window.open('', '_blank');
            
            let betsHTML = '';
            ticketData.bets.forEach(bet => {
                betsHTML += `
                    <div style="display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee;">
                        <span>${bet.name}: ${bet.number}</span>
                        <span>${bet.amount} G</span>
                    </div>
                `;
            });
            
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Fiche LOTATO</title>
                        <style>
                            body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
                            @media print {
                                body { margin: 0; padding: 0; }
                                @page { margin: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        <div style="text-align: center; padding: 20px; border: 2px solid #000;">
                            <h2>LOTATO</h2>
                            <p><strong>Fiche Parye</strong></p>
                            <p><strong>Dat:</strong> ${new Date(ticketData.createdAt).toLocaleString('fr-FR')}</p>
                            <p><strong>Tiraj:</strong> ${draws[ticketData.draw].name} (${ticketData.drawTime === 'morning' ? 'Maten' : 'Swè'})</p>
                            <p><strong>Agent:</strong> ${ticketData.agentName}</p>
                            <hr>
                            <div style="margin: 15px 0;">
                                ${betsHTML}
                            </div>
                            <hr>
                            <div style="display: flex; justify-content: space-between; margin-top: 15px; font-weight: bold; font-size: 1.1rem;">
                                <span>Total:</span>
                                <span>${ticketData.total} goud</span>
                            </div>
                        </div>
                    </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function closeBettingScreen() {
            const bettingScreen = document.getElementById('betting-screen');
            bettingScreen.style.display = 'none';
            document.querySelector('.container').style.display = 'block';
        }

        // ============================================
        // MULTI-TIRAGE
        // ============================================
        function initMultiDrawPanel() {
            const multiDrawOptions = document.getElementById('multi-draw-options');
            const multiGameSelect = document.getElementById('multi-game-select');
            
            multiDrawOptions.innerHTML = '';
            multiGameSelect.innerHTML = '';
            
            Object.keys(draws).forEach(drawId => {
                const option = document.createElement('div');
                option.className = 'multi-draw-option';
                option.setAttribute('data-draw', drawId);
                option.textContent = draws[drawId].name;
                
                option.addEventListener('click', function() {
                    this.classList.toggle('selected');
                    const drawId = this.getAttribute('data-draw');
                    
                    if (this.classList.contains('selected')) {
                        selectedMultiDraws.add(drawId);
                    } else {
                        selectedMultiDraws.delete(drawId);
                    }
                    
                    const printBtn = document.getElementById('print-multi-draw-ticket');
                    printBtn.style.display = selectedMultiDraws.size > 0 ? 'block' : 'none';
                });
                
                multiDrawOptions.appendChild(option);
            });
            
            const games = [
                { id: 'borlette', name: 'BORLETTE' },
                { id: 'boulpe', name: 'BOUL PE' },
                { id: 'lotto3', name: 'LOTO 3' },
                { id: 'lotto4', name: 'LOTO 4' },
                { id: 'lotto5', name: 'LOTO 5' },
                { id: 'grap', name: 'GRAP' },
                { id: 'marriage', name: 'MARYAJ' }
            ];
            
            games.forEach(game => {
                const option = document.createElement('div');
                option.className = 'multi-game-option';
                if (game.id === 'borlette') option.classList.add('selected');
                option.setAttribute('data-game', game.id);
                option.textContent = game.name;
                
                option.addEventListener('click', function() {
                    document.querySelectorAll('.multi-game-option').forEach(opt => opt.classList.remove('selected'));
                    this.classList.add('selected');
                    selectedMultiGame = this.getAttribute('data-game');
                    updateMultiGameForm(selectedMultiGame);
                });
                
                multiGameSelect.appendChild(option);
            });
            
            updateMultiGameForm('borlette');
        }

        function updateMultiGameForm(gameType) {
            const numberInputs = document.getElementById('multi-number-inputs');
            
            let html = '';
            switch(gameType) {
                case 'borlette':
                case 'boulpe':
                    html = `<label for="multi-draw-number">Nimewo 2 chif</label>
                           <input type="text" id="multi-draw-number" placeholder="00" maxlength="2">`;
                    break;
                case 'lotto3':
                case 'grap':
                    html = `<label for="multi-draw-number">Nimewo 3 chif</label>
                           <input type="text" id="multi-draw-number" placeholder="000" maxlength="3">`;
                    break;
                case 'marriage':
                case 'lotto4':
                    html = `<label>2 Nimewo</label>
                           <div class="number-inputs">
                               <input type="text" id="multi-draw-number1" placeholder="00" maxlength="2">
                               <input type="text" id="multi-draw-number2" placeholder="00" maxlength="2">
                           </div>`;
                    break;
                case 'lotto5':
                    html = `<label>5 Chif (3+2 boules)</label>
                           <div class="number-inputs">
                               <input type="text" id="multi-draw-number1" placeholder="000" maxlength="3">
                               <input type="text" id="multi-draw-number2" placeholder="00" maxlength="2">
                           </div>`;
                    break;
            }
            
            numberInputs.innerHTML = html;
        }

        function toggleMultiDrawPanel() {
            const content = document.getElementById('multi-draw-content');
            const toggleBtn = document.getElementById('multi-draw-toggle');
            
            content.classList.toggle('expanded');
            toggleBtn.innerHTML = content.classList.contains('expanded') 
                ? '<i class="fas fa-chevron-up"></i>' 
                : '<i class="fas fa-chevron-down"></i>';
        }

        function addToMultipleDraws() {
            const amount = parseInt(document.getElementById('multi-draw-amount').value);
            let number = '';
            
            switch(selectedMultiGame) {
                case 'borlette':
                case 'boulpe':
                case 'lotto3':
                case 'grap':
                    number = document.getElementById('multi-draw-number').value;
                    break;
                case 'marriage':
                case 'lotto4':
                    const num1 = document.getElementById('multi-draw-number1').value;
                    const num2 = document.getElementById('multi-draw-number2').value;
                    number = `${num1}*${num2}`;
                    break;
                case 'lotto5':
                    const num5_1 = document.getElementById('multi-draw-number1').value;
                    const num5_2 = document.getElementById('multi-draw-number2').value;
                    number = `${num5_1}*${num5_2}`;
                    break;
            }
            
            // Validation
            if (selectedMultiDraws.size === 0) {
                showNotification("Tanpri chwazi pou pi piti yon tiraj", "warning");
                return;
            }
            
            if (!number || isNaN(amount) || amount <= 0) {
                showNotification("Tanpri antre yon nimewo ak kantite valab", "warning");
                return;
            }
            
            selectedMultiDraws.forEach(drawId => {
                activeBets.push({
                    type: selectedMultiGame,
                    name: betTypes[selectedMultiGame].name,
                    number: number,
                    amount: amount,
                    multiplier: betTypes[selectedMultiGame].multiplier,
                    draw: drawId,
                    drawTime: 'morning',
                    isMultiDraw: true
                });
            });
            
            updateBetsList();
            showNotification(`${selectedMultiDraws.size} parye ajoute!`, "success");
            document.getElementById('print-multi-draw-ticket').style.display = 'block';
            document.getElementById('multi-draw-amount').value = '1';
        }

        function printMultiDrawTicket() {
            if (activeBets.length === 0) {
                showNotification("Pa gen parye pou enprime", "warning");
                return;
            }
            
            const multiDrawBets = activeBets.filter(bet => bet.isMultiDraw);
            
            if (multiDrawBets.length === 0) {
                showNotification("Pa gen parye multi-tiraj", "warning");
                return;
            }
            
            const printWindow = window.open('', '_blank');
            
            let drawsHTML = '';
            let totalAmount = 0;
            
            multiDrawBets.forEach(bet => {
                drawsHTML += `
                    <div style="margin-bottom: 10px; padding: 10px; border: 1px solid #ddd;">
                        <strong>${draws[bet.draw].name}:</strong> ${bet.name} - ${bet.number} (${bet.amount} G)
                    </div>
                `;
                totalAmount += bet.amount;
            });
            
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Fiche Multi-Tiraj</title>
                        <style>body { font-family: Arial; padding: 20px; }</style>
                    </head>
                    <body>
                        <h2>FICHE MULTI-TIRAJ</h2>
                        <p><strong>Agent:</strong> ${currentAdmin.name}</p>
                        <p><strong>Dat:</strong> ${new Date().toLocaleString('fr-FR')}</p>
                        <hr>
                        ${drawsHTML}
                        <hr>
                        <div style="font-weight: bold; margin-top: 20px;">
                            TOTAL: ${totalAmount} G
                        </div>
                    </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // ============================================
        // GESTION DES ÉCRANS
        // ============================================
        function showScreen(screenId) {
            // Cacher tous les écrans
            document.querySelectorAll('.screen, .betting-screen, .container, .report-screen').forEach(screen => {
                screen.style.display = 'none';
            });
            
            // Mettre à jour la navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                if (item.getAttribute('data-screen') === screenId) {
                    item.classList.add('active');
                }
            });
            
            // Afficher l'écran demandé
            if (screenId === 'home') {
                document.querySelector('.container').style.display = 'block';
            } else {
                const screen = document.getElementById(screenId + '-screen');
                if (screen) {
                    screen.style.display = 'block';
                    loadScreenData(screenId);
                }
            }
        }

        function loadScreenData(screenId) {
            switch(screenId) {
                case 'ticket-management':
                    loadAgentTickets();
                    break;
                case 'history':
                    loadHistory();
                    break;
                case 'winning-tickets':
                    loadWinningTickets();
                    break;
            }
        }

        async function loadAgentTickets() {
            try {
                const response = await fetch(`${APP_CONFIG.tickets}/agent/${currentAdmin.id}`, {
                    headers: { 'Authorization': `Bearer ${currentAdmin.token}` }
                });
                
                if (response.ok) {
                    const tickets = await response.json();
                    displayAgentTickets(tickets);
                }
            } catch (error) {
                console.error("Erreur chargement fiches:", error);
                document.getElementById('ticket-management-list').innerHTML = 
                    '<p>Erè chajman. Tcheke koneksyon ou.</p>';
            }
        }

        function displayAgentTickets(tickets) {
            const ticketList = document.getElementById('ticket-management-list');
            
            if (!tickets || tickets.length === 0) {
                ticketList.innerHTML = '<p>Pa gen fiche.</p>';
                return;
            }
            
            let html = '';
            tickets.forEach(ticket => {
                html += `
                    <div class="ticket-management">
                        <div class="ticket-management-header">
                            <strong>Fiche #${ticket.ticketNumber || 'N/A'}</strong>
                            <span>${draws[ticket.draw]?.name || 'Inconnu'} - ${ticket.total} G</span>
                        </div>
                        <div class="ticket-details">
                            <p>${new Date(ticket.createdAt).toLocaleString()}</p>
                        </div>
                    </div>
                `;
            });
            
            ticketList.innerHTML = html;
        }

        // ============================================
        // FONCTIONS AUXILIAIRES
        // ============================================
        function showLoginError(message) {
            const errorDiv = document.getElementById('login-error');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
            setTimeout(() => errorDiv.style.display = 'none', 5000);
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'fas fa-info-circle';
            if (type === 'success') icon = 'fas fa-check-circle';
            if (type === 'warning') icon = 'fas fa-exclamation-triangle';
            if (type === 'error') icon = 'fas fa-times-circle';
            
            notification.innerHTML = `<i class="${icon}"></i><span>${message}</span>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function updateSyncStatus(connected) {
            const syncStatus = document.getElementById('sync-status');
            const syncText = document.getElementById('sync-text');
            
            if (connected) {
                syncStatus.className = 'sync-status sync-connected';
                syncText.textContent = 'Konekte';
            } else {
                syncStatus.className = 'sync-status sync-disconnected';
                syncText.textContent = 'Pa Konekte';
            }
        }

        function setupGrapSelection() {
            document.getElementById('select-all-graps').addEventListener('click', function() {
                document.querySelectorAll('.pair-ball').forEach(ball => {
                    ball.classList.add('selected');
                });
            });
            
            document.getElementById('add-selected-graps').addEventListener('click', function() {
                const amount = parseInt(document.getElementById('grap-amount').value);
                const selectedBalls = document.querySelectorAll('.pair-ball.selected');
                
                if (selectedBalls.length === 0) {
                    showNotification("Chwazi omwen yon grap", "warning");
                    return;
                }
                
                selectedBalls.forEach(ball => {
                    const pair = ball.getAttribute('data-pair');
                    activeBets.push({
                        type: 'grap',
                        name: 'GRAP',
                        number: pair,
                        amount: amount,
                        multiplier: 500
                    });
                });
                
                updateBetsList();
                showNotification(`${selectedBalls.length} graps ajoute!`, "success");
                document.getElementById('grap-amount').value = '1';
                document.querySelectorAll('.pair-ball').forEach(ball => ball.classList.remove('selected'));
            });
        }

        async function generateEndOfDrawReport() {
            try {
                const response = await fetch(`${APP_CONFIG.reports}/end-of-draw/${currentAdmin.id}`, {
                    headers: { 'Authorization': `Bearer ${currentAdmin.token}` }
                });
                
                if (response.ok) {
                    const report = await response.json();
                    displayEndOfDrawReport(report);
                }
            } catch (error) {
                console.error("Erreur rapport:", error);
                // Rapport simulé pour la démonstration
                const mockReport = {
                    date: new Date().toISOString(),
                    totalTickets: Math.floor(Math.random() * 50),
                    winningTickets: Math.floor(Math.random() * 10),
                    totalSales: Math.floor(Math.random() * 10000),
                    totalPayouts: Math.floor(Math.random() * 5000),
                    netProfit: Math.floor(Math.random() * 5000)
                };
                displayEndOfDrawReport(mockReport);
            }
        }

        function displayEndOfDrawReport(report) {
            document.querySelector('.container').style.display = 'none';
            const reportScreen = document.getElementById('report-screen');
            const reportContent = document.getElementById('report-content');
            
            reportContent.innerHTML = `
                <div class="report-header">
                    <h2>RAPÒ FIN TIRAJ</h2>
                    <p>LOTATO</p>
                    <p>Agent: ${currentAdmin.name}</p>
                </div>
                
                <div class="report-details">
                    <div class="report-row"><span>#Fiche vendues:</span><span>${report.totalTickets}</span></div>
                    <div class="report-row"><span>#Fiche gagnantes:</span><span>${report.winningTickets}</span></div>
                    <div class="report-row"><span>Ventes:</span><span>${report.totalSales} G</span></div>
                    <div class="report-row"><span>Paiements:</span><span>${report.totalPayouts} G</span></div>
                    <div class="report-row total ${report.netProfit >= 0 ? 'report-profit' : 'report-loss'}">
                        <span>Profit/Perte:</span><span>${report.netProfit} G</span>
                    </div>
                </div>
                
                <div class="ticket-actions" style="margin-top: 30px;">
                    <button class="ticket-action-btn print-ticket-btn" onclick="window.print()">
                        <i class="fas fa-print"></i> Enprime Rapò
                    </button>
                </div>
            `;
            
            reportScreen.style.display = 'block';
        }

        // Fonctions placeholder pour la démonstration
        async function loadHistory() {
            document.getElementById('history-list').innerHTML = 
                '<p>Fonksyon sa a ap disponib pi ta.</p>';
        }

        async function loadWinningTickets() {
            document.getElementById('winning-tickets-list').innerHTML = 
                '<p>Fonksyon sa a ap disponib pi ta.</p>';
        }
    </script>
</body>
</html>