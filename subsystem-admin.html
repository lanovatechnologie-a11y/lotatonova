<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nova / LOTATO - Administration Sous-système</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="manifest" href="manifest.json">
    <style>
        :root {
            --primary-color: #3498db;
            --secondary-color: #2c3e50;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --sidebar-width: 280px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark-color);
            display: flex;
            min-height: 100vh;
        }
        
        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary-color), #2980b9);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        
        .logo-container {
            padding: 25px 20px;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .logo {
            font-size: 2.5rem;
            color: white;
            margin-bottom: 10px;
        }
        
        .logo-text {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }
        
        .logo-subtext {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
            margin-top: 5px;
        }
        
        .user-info {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            background-color: white;
            color: var(--primary-color);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .user-details h3 {
            font-size: 1rem;
            margin-bottom: 5px;
        }
        
        .user-details p {
            font-size: 0.8rem;
            color: rgba(255,255,255,0.7);
        }
        
        .nav-menu {
            padding: 20px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 15px 25px;
            color: rgba(255,255,255,0.8);
            text-decoration: none;
            transition: all 0.3s;
            border-left: 4px solid transparent;
        }
        
        .nav-item:hover {
            background-color: rgba(255,255,255,0.1);
            color: white;
            border-left-color: white;
        }
        
        .nav-item.active {
            background-color: rgba(255,255,255,0.15);
            color: white;
            border-left-color: white;
        }
        
        .nav-icon {
            width: 30px;
            font-size: 1.2rem;
            margin-right: 15px;
        }
        
        .nav-label {
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 20px;
            min-height: 100vh;
        }
        
        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid #ddd;
        }
        
        .page-title {
            font-size: 1.8rem;
            color: var(--dark-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .page-title i {
            color: var(--primary-color);
        }
        
        .top-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2980b9;
        }
        
        .btn-success {
            background-color: var(--success-color);
            color: white;
        }
        
        .btn-success:hover {
            background-color: #219955;
        }
        
        .btn-warning {
            background-color: var(--warning-color);
            color: white;
        }
        
        .btn-warning:hover {
            background-color: #e67e22;
        }
        
        .btn-danger {
            background-color: var(--danger-color);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c0392b;
        }
        
        /* Dashboard Cards */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 20px;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            color: white;
        }
        
        .icon-users {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .icon-tickets {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .icon-revenue {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .icon-active {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .stat-info {
            flex: 1;
        }
        
        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        .stat-trend {
            font-size: 0.8rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .trend-up {
            color: var(--success-color);
        }
        
        .trend-down {
            color: var(--danger-color);
        }
        
        /* Tables */
        .table-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .table-title {
            font-size: 1.3rem;
            color: var(--dark-color);
            font-weight: 600;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
        }
        
        .search-input {
            padding: 8px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            min-width: 250px;
        }
        
        .table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .table th {
            background-color: #f8f9fa;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            color: var(--dark-color);
            border-bottom: 2px solid #dee2e6;
        }
        
        .table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
        }
        
        .table tr:hover {
            background-color: #f8f9fa;
        }
        
        .status-badge {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
        }
        
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .status-pending {
            background-color: #fff3cd;
            color: #856404;
        }
        
        .status-online {
            background-color: #d1ecf1;
            color: #0c5460;
        }
        
        .status-offline {
            background-color: #d6d8d9;
            color: #383d41;
        }
        
        .role-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
            display: inline-block;
        }
        
        .role-owner {
            background-color: var(--danger-color);
            color: white;
        }
        
        .role-supervisor {
            background-color: #f39c12;
            color: white;
        }
        
        .role-agent {
            background-color: #2ecc71;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .action-btn {
            width: 35px;
            height: 35px;
            border-radius: 5px;
            border: none;
            background-color: #f8f9fa;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn:hover {
            background-color: #e9ecef;
            color: var(--dark-color);
        }
        
        .action-btn.edit:hover {
            background-color: var(--warning-color);
            color: white;
        }
        
        .action-btn.delete:hover {
            background-color: var(--danger-color);
            color: white;
        }
        
        .action-btn.view:hover {
            background-color: var(--primary-color);
            color: white;
        }
        
        .action-btn.block:hover {
            background-color: var(--danger-color);
            color: white;
        }
        
        .action-btn.unblock:hover {
            background-color: var(--success-color);
            color: white;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0,0,0,0.5);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .modal-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-size: 1.3rem;
            color: var(--dark-color);
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: var(--danger-color);
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .modal-footer {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark-color);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            font-weight: 600;
            color: #6c757d;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .tab:hover {
            color: var(--dark-color);
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Charts */
        .chart-container {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .chart-title {
            font-size: 1.3rem;
            color: var(--dark-color);
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        /* Responsive */
        @media (max-width: 1024px) {
            .sidebar {
                width: 70px;
                overflow-x: hidden;
            }
            
            .logo-text, .logo-subtext, .user-details, .nav-label {
                display: none;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .user-info {
                justify-content: center;
                padding: 15px 10px;
            }
            
            .nav-item {
                justify-content: center;
                padding: 15px 10px;
            }
            
            .nav-icon {
                margin-right: 0;
            }
        }
        
        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .stats-cards {
                grid-template-columns: 1fr;
            }
            
            .table-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .search-box {
                width: 100%;
            }
            
            .search-input {
                min-width: auto;
                flex: 1;
            }
        }
        
        /* Loading */
        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            color: #6c757d;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 3000;
            animation: slideIn 0.3s ease-out;
            max-width: 400px;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(100%);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }
        
        .notification.success {
            background-color: var(--success-color);
        }
        
        .notification.error {
            background-color: var(--danger-color);
        }
        
        .notification.warning {
            background-color: var(--warning-color);
        }
        
        .notification.info {
            background-color: var(--primary-color);
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6c757d;
        }
        
        .empty-icon {
            font-size: 4rem;
            color: #dee2e6;
            margin-bottom: 20px;
        }
        
        /* Quick Stats */
        .quick-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .quick-stat {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .quick-stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
        }
        
        .quick-stat-info {
            flex: 1;
        }
        
        .quick-stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .quick-stat-label {
            font-size: 0.8rem;
            color: #6c757d;
        }
        
        /* Draw Controls */
        .draw-controls {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .draw-control {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .draw-control-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .draw-name {
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .draw-status {
            font-size: 0.8rem;
            padding: 3px 8px;
            border-radius: 10px;
        }
        
        .draw-times {
            display: flex;
            gap: 10px;
        }
        
        .draw-time {
            flex: 1;
            text-align: center;
            padding: 8px;
            background-color: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9rem;
        }
        
        /* Multiplier Settings */
        .multiplier-settings {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .multiplier-setting {
            background-color: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .multiplier-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .multiplier-name {
            font-weight: bold;
            color: var(--dark-color);
        }
        
        .multiplier-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        /* Activity Timeline */
        .activity-timeline {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .activity-item {
            display: flex;
            gap: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary-color);
        }
        
        .activity-content {
            flex: 1;
        }
        
        .activity-title {
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: #6c757d;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-container">
            <div class="logo">
                <i class="fas fa-building"></i>
            </div>
            <div class="logo-text">NOVA / LOTATO</div>
            <div class="logo-subtext">ADMIN SOUS-SYSTÈME</div>
        </div>
        
        <div class="user-info">
            <div class="user-avatar" id="user-avatar">A</div>
            <div class="user-details">
                <h3 id="user-name">Admin Sous-système</h3>
                <p id="user-email">admin@example.com</p>
            </div>
        </div>
        
        <div class="nav-menu">
            <a href="#" class="nav-item active" data-section="dashboard">
                <div class="nav-icon"><i class="fas fa-tachometer-alt"></i></div>
                <div class="nav-label">Tableau de bord</div>
            </a>
            <a href="#" class="nav-item" data-section="users">
                <div class="nav-icon"><i class="fas fa-users"></i></div>
                <div class="nav-label">Utilisateurs</div>
            </a>
            <a href="#" class="nav-item" data-section="tickets">
                <div class="nav-icon"><i class="fas fa-ticket-alt"></i></div>
                <div class="nav-label">Tickets</div>
            </a>
            <a href="#" class="nav-item" data-section="results">
                <div class="nav-icon"><i class="fas fa-chart-pie"></i></div>
                <div class="nav-label">Résultats</div>
            </a>
            <a href="#" class="nav-item" data-section="settings">
                <div class="nav-icon"><i class="fas fa-cog"></i></div>
                <div class="nav-label">Paramètres</div>
            </a>
            <a href="#" class="nav-item" data-section="reports">
                <div class="nav-icon"><i class="fas fa-chart-bar"></i></div>
                <div class="nav-label">Rapports</div>
            </a>
            <a href="#" class="nav-item" data-section="activity">
                <div class="nav-icon"><i class="fas fa-history"></i></div>
                <div class="nav-label">Activités</div>
            </a>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="page-title">
                <i class="fas fa-tachometer-alt"></i>
                <span id="page-title">Tableau de bord Sous-système</span>
            </div>
            <div class="top-actions">
                <button class="btn btn-primary" id="refresh-btn">
                    <i class="fas fa-sync-alt"></i> Actualiser
                </button>
                <button class="btn btn-success" id="add-user-btn">
                    <i class="fas fa-plus"></i> Nouvel utilisateur
                </button>
                <button class="btn btn-warning" id="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Déconnexion
                </button>
            </div>
        </div>
        
        <!-- Dashboard Section -->
        <div id="dashboard-section" class="section-content active">
            <!-- Stats Cards -->
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-icon icon-users">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="total-users">0</div>
                        <div class="stat-label">Utilisateurs actifs</div>
                        <div class="stat-trend trend-up" id="users-trend">
                            <i class="fas fa-arrow-up"></i> 5% ce mois
                        </div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon icon-tickets">
                        <i class="fas fa-ticket-alt"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="today-tickets">0</div>
                        <div class="stat-label">Tickets aujourd'hui</div>
                        <div class="stat-trend trend-up" id="tickets-trend">
                            <i class="fas fa-arrow-up"></i> 12% aujourd'hui
                        </div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon icon-revenue">
                        <i class="fas fa-money-bill-wave"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="today-revenue">0 HTG</div>
                        <div class="stat-label">Revenu du jour</div>
                        <div class="stat-trend trend-up" id="revenue-trend">
                            <i class="fas fa-arrow-up"></i> 8% aujourd'hui
                        </div>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon icon-active">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <div class="stat-info">
                        <div class="stat-value" id="active-rate">0%</div>
                        <div class="stat-label">Taux d'activité</div>
                        <div class="stat-trend trend-up" id="activity-trend">
                            <i class="fas fa-arrow-up"></i> 3% aujourd'hui
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Quick Stats -->
            <div class="quick-stats">
                <div class="quick-stat">
                    <div class="quick-stat-icon" style="background-color: #3498db;">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="quick-stat-info">
                        <div class="quick-stat-value" id="online-agents">0</div>
                        <div class="quick-stat-label">Agents en ligne</div>
                    </div>
                </div>
                
                <div class="quick-stat">
                    <div class="quick-stat-icon" style="background-color: #9b59b6;">
                        <i class="fas fa-user-check"></i>
                    </div>
                    <div class="quick-stat-info">
                        <div class="quick-stat-value" id="online-supervisors">0</div>
                        <div class="quick-stat-label">Superviseurs en ligne</div>
                    </div>
                </div>
                
                <div class="quick-stat">
                    <div class="quick-stat-icon" style="background-color: #2ecc71;">
                        <i class="fas fa-money-check"></i>
                    </div>
                    <div class="quick-stat-info">
                        <div class="quick-stat-value" id="total-payout">0 HTG</div>
                        <div class="quick-stat-label">Gains à payer</div>
                    </div>
                </div>
                
                <div class="quick-stat">
                    <div class="quick-stat-icon" style="background-color: #e74c3c;">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="quick-stat-info">
                        <div class="quick-stat-value" id="pending-issues">0</div>
                        <div class="quick-stat-label">Problèmes en attente</div>
                    </div>
                </div>
            </div>
            
            <!-- Recent Users -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Utilisateurs récemment actifs</div>
                    <div class="search-box">
                        <input type="text" class="search-input" placeholder="Rechercher..." id="search-users">
                        <button class="btn btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                
                <div class="loading" id="users-loading">
                    <div class="loading-spinner"></div>
                    <p>Chargement des utilisateurs...</p>
                </div>
                
                <table class="table" id="users-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Rôle</th>
                            <th>Superviseur</th>
                            <th>Statut</th>
                            <th>Activité</th>
                            <th>Ventes (HTG)</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body">
                        <!-- Rempli dynamiquement -->
                    </tbody>
                </table>
                
                <div class="empty-state" id="users-empty" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3>Aucun utilisateur trouvé</h3>
                    <p>Créez votre premier utilisateur pour commencer</p>
                    <button class="btn btn-success" id="create-first-user" style="margin-top: 20px;">
                        <i class="fas fa-plus"></i> Créer un utilisateur
                    </button>
                </div>
            </div>
            
            <!-- Recent Tickets -->
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Tickets récents</div>
                    <div class="search-box">
                        <input type="text" class="search-input" placeholder="Rechercher par numéro..." id="search-tickets">
                        <button class="btn btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                        <select class="form-control" id="filter-draw" style="width: 150px;">
                            <option value="all">Tous les tirages</option>
                            <option value="borlette">Borlette</option>
                            <option value="lotto3">Lotto 3</option>
                            <option value="lotto4">Lotto 4</option>
                            <option value="lotto5">Lotto 5</option>
                        </select>
                    </div>
                </div>
                
                <div class="loading" id="tickets-loading">
                    <div class="loading-spinner"></div>
                    <p>Chargement des tickets...</p>
                </div>
                
                <table class="table" id="tickets-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Numéro</th>
                            <th>Agent</th>
                            <th>Tirage</th>
                            <th>Montant</th>
                            <th>Date</th>
                            <th>Statut</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="tickets-table-body">
                        <!-- Rempli dynamiquement -->
                    </tbody>
                </table>
                
                <div class="empty-state" id="tickets-empty" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-ticket-alt"></i>
                    </div>
                    <h3>Aucun ticket trouvé</h3>
                    <p>Les tickets apparaitront lorsque vos agents commenceront à vendre</p>
                </div>
            </div>
        </div>
        
        <!-- Users Section -->
        <div id="users-section" class="section-content" style="display: none;">
            <div class="tabs">
                <button class="tab active" data-user-tab="agents">Agents</button>
                <button class="tab" data-user-tab="supervisors">Superviseurs</button>
                <button class="tab" data-user-tab="all">Tous les utilisateurs</button>
            </div>
            
            <div class="tab-content active" id="agents-tab">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Gestion des Agents</div>
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Rechercher un agent..." id="search-agents">
                            <button class="btn btn-primary" id="search-agents-btn">
                                <i class="fas fa-search"></i>
                            </button>
                            <select class="form-control" id="filter-agent-status" style="width: 150px;">
                                <option value="all">Tous les statuts</option>
                                <option value="active">Actifs</option>
                                <option value="inactive">Inactifs</option>
                                <option value="online">En ligne</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="loading" id="agents-list-loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement des agents...</p>
                    </div>
                    
                    <table class="table" id="agents-list-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Identifiant</th>
                                <th>Superviseur 1</th>
                                <th>Superviseur 2</th>
                                <th>Statut</th>
                                <th>En ligne</th>
                                <th>Ventes (HTG)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="agents-list-table-body">
                            <!-- Rempli dynamiquement -->
                        </tbody>
                    </table>
                    
                    <div class="empty-state" id="agents-list-empty" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <h3>Aucun agent trouvé</h3>
                        <p>Créez votre premier agent pour commencer</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="supervisors-tab">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Gestion des Superviseurs</div>
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Rechercher un superviseur..." id="search-supervisors">
                            <button class="btn btn-primary" id="search-supervisors-btn">
                                <i class="fas fa-search"></i>
                            </button>
                            <select class="form-control" id="filter-supervisor-level" style="width: 150px;">
                                <option value="all">Tous les niveaux</option>
                                <option value="1">Superviseur 1</option>
                                <option value="2">Superviseur 2</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="loading" id="supervisors-list-loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement des superviseurs...</p>
                    </div>
                    
                    <table class="table" id="supervisors-list-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Identifiant</th>
                                <th>Niveau</th>
                                <th>Agents assignés</th>
                                <th>Statut</th>
                                <th>En ligne</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="supervisors-list-table-body">
                            <!-- Rempli dynamiquement -->
                        </tbody>
                    </table>
                    
                    <div class="empty-state" id="supervisors-list-empty" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-user-tie"></i>
                        </div>
                        <h3>Aucun superviseur trouvé</h3>
                        <p>Créez votre premier superviseur pour commencer</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="all-tab">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Tous les Utilisateurs</div>
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Rechercher un utilisateur..." id="search-all-users">
                            <button class="btn btn-primary" id="search-all-users-btn">
                                <i class="fas fa-search"></i>
                            </button>
                            <select class="form-control" id="filter-all-role" style="width: 150px;">
                                <option value="all">Tous les rôles</option>
                                <option value="agent">Agents</option>
                                <option value="supervisor">Superviseurs</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="loading" id="all-users-loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement des utilisateurs...</p>
                    </div>
                    
                    <table class="table" id="all-users-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Nom</th>
                                <th>Identifiant</th>
                                <th>Rôle</th>
                                <th>Niveau</th>
                                <th>Superviseur 1</th>
                                <th>Superviseur 2</th>
                                <th>Statut</th>
                                <th>Création</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="all-users-table-body">
                            <!-- Rempli dynamiquement -->
                        </tbody>
                    </table>
                    
                    <div class="empty-state" id="all-users-empty" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <h3>Aucun utilisateur trouvé</h3>
                        <p>Créez votre premier utilisateur pour commencer</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tickets Section -->
        <div id="tickets-section" class="section-content" style="display: none;">
            <div class="tabs">
                <button class="tab active" data-ticket-tab="today">Aujourd'hui</button>
                <button class="tab" data-ticket-tab="pending">En attente</button>
                <button class="tab" data-ticket-tab="winning">Gagnants</button>
                <button class="tab" data-ticket-tab="all">Tous les tickets</button>
            </div>
            
            <div class="tab-content active" id="today-tab">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Tickets d'aujourd'hui</div>
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Rechercher..." id="search-today-tickets">
                            <button class="btn btn-primary" id="search-today-tickets-btn">
                                <i class="fas fa-search"></i>
                            </button>
                            <select class="form-control" id="filter-today-agent" style="width: 150px;">
                                <option value="all">Tous les agents</option>
                                <!-- Rempli dynamiquement -->
                            </select>
                        </div>
                    </div>
                    
                    <div class="loading" id="today-tickets-loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement des tickets...</p>
                    </div>
                    
                    <table class="table" id="today-tickets-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Numéro</th>
                                <th>Agent</th>
                                <th>Tirage</th>
                                <th>Heure</th>
                                <th>Parieurs</th>
                                <th>Montant (HTG)</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="today-tickets-table-body">
                            <!-- Rempli dynamiquement -->
                        </tbody>
                    </table>
                    
                    <div class="empty-state" id="today-tickets-empty" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <h3>Aucun ticket aujourd'hui</h3>
                        <p>Les tickets d'aujourd'hui apparaîtront ici</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="pending-tab">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Tickets en attente de synchronisation</div>
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Rechercher..." id="search-pending-tickets">
                            <button class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="loading" id="pending-tickets-loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement des tickets en attente...</p>
                    </div>
                    
                    <table class="table" id="pending-tickets-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Numéro</th>
                                <th>Agent</th>
                                <th>Tirage</th>
                                <th>Date</th>
                                <th>Montant (HTG)</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="pending-tickets-table-body">
                            <!-- Rempli dynamiquement -->
                        </tbody>
                    </table>
                    
                    <div class="empty-state" id="pending-tickets-empty" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <h3>Aucun ticket en attente</h3>
                        <p>Tous les tickets sont synchronisés</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="winning-tab">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Tickets gagnants</div>
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Rechercher..." id="search-winning-tickets">
                            <button class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                            <select class="form-control" id="filter-winning-status" style="width: 150px;">
                                <option value="all">Tous les statuts</option>
                                <option value="paid">Payés</option>
                                <option value="unpaid">Non payés</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="loading" id="winning-tickets-loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement des tickets gagnants...</p>
                    </div>
                    
                    <table class="table" id="winning-tickets-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Numéro</th>
                                <th>Agent</th>
                                <th>Tirage</th>
                                <th>Date</th>
                                <th>Gains (HTG)</th>
                                <th>Statut paiement</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="winning-tickets-table-body">
                            <!-- Rempli dynamiquement -->
                        </tbody>
                    </table>
                    
                    <div class="empty-state" id="winning-tickets-empty" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <h3>Aucun ticket gagnant</h3>
                        <p>Les tickets gagnants apparaîtront ici</p>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="all-tickets-tab">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Historique des tickets</div>
                        <div class="search-box">
                            <input type="text" class="search-input" placeholder="Rechercher..." id="search-all-tickets">
                            <button class="btn btn-primary">
                                <i class="fas fa-search"></i>
                            </button>
                            <input type="date" class="form-control" id="filter-ticket-date" style="width: 150px;">
                        </div>
                    </div>
                    
                    <div class="loading" id="all-tickets-loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement de l'historique...</p>
                    </div>
                    
                    <table class="table" id="all-tickets-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Numéro</th>
                                <th>Agent</th>
                                <th>Tirage</th>
                                <th>Date</th>
                                <th>Montant (HTG)</th>
                                <th>Statut</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="all-tickets-table-body">
                            <!-- Rempli dynamiquement -->
                        </tbody>
                    </table>
                    
                    <div class="empty-state" id="all-tickets-empty" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-history"></i>
                        </div>
                        <h3>Aucun ticket dans l'historique</h3>
                        <p>L'historique des tickets apparaîtra ici</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Results Section -->
        <div id="results-section" class="section-content" style="display: none;">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Gestion des Résultats</div>
                    <div class="search-box">
                        <input type="text" class="search-input" placeholder="Rechercher un tirage..." id="search-results">
                        <button class="btn btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                        <input type="date" class="form-control" id="filter-result-date" style="width: 150px;">
                    </div>
                </div>
                
                <!-- Draw Controls -->
                <div class="draw-controls">
                    <div class="draw-control">
                        <div class="draw-control-header">
                            <div class="draw-name">Borlette</div>
                            <span class="draw-status status-active">Actif</span>
                        </div>
                        <div class="draw-times">
                            <div class="draw-time">Matin: 12:00</div>
                            <div class="draw-time">Soir: 18:00</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary btn-sm" onclick="enterResult('borlette', 'morning')">
                                <i class="fas fa-edit"></i> Résultat Matin
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="enterResult('borlette', 'evening')">
                                <i class="fas fa-edit"></i> Résultat Soir
                            </button>
                        </div>
                    </div>
                    
                    <div class="draw-control">
                        <div class="draw-control-header">
                            <div class="draw-name">Lotto 3</div>
                            <span class="draw-status status-active">Actif</span>
                        </div>
                        <div class="draw-times">
                            <div class="draw-time">Matin: 12:30</div>
                            <div class="draw-time">Soir: 18:30</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary btn-sm" onclick="enterResult('lotto3', 'morning')">
                                <i class="fas fa-edit"></i> Résultat Matin
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="enterResult('lotto3', 'evening')">
                                <i class="fas fa-edit"></i> Résultat Soir
                            </button>
                        </div>
                    </div>
                    
                    <div class="draw-control">
                        <div class="draw-control-header">
                            <div class="draw-name">Lotto 4</div>
                            <span class="draw-status status-active">Actif</span>
                        </div>
                        <div class="draw-times">
                            <div class="draw-time">Matin: 13:00</div>
                            <div class="draw-time">Soir: 19:00</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary btn-sm" onclick="enterResult('lotto4', 'morning')">
                                <i class="fas fa-edit"></i> Résultat Matin
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="enterResult('lotto4', 'evening')">
                                <i class="fas fa-edit"></i> Résultat Soir
                            </button>
                        </div>
                    </div>
                    
                    <div class="draw-control">
                        <div class="draw-control-header">
                            <div class="draw-name">Lotto 5</div>
                            <span class="draw-status status-active">Actif</span>
                        </div>
                        <div class="draw-times">
                            <div class="draw-time">Matin: 13:30</div>
                            <div class="draw-time">Soir: 19:30</div>
                        </div>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary btn-sm" onclick="enterResult('lotto5', 'morning')">
                                <i class="fas fa-edit"></i> Résultat Matin
                            </button>
                            <button class="btn btn-primary btn-sm" onclick="enterResult('lotto5', 'evening')">
                                <i class="fas fa-edit"></i> Résultat Soir
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Recent Results -->
                <div style="margin-top: 30px;">
                    <h3 style="margin-bottom: 20px; color: var(--dark-color);">Résultats récents</h3>
                    
                    <div class="loading" id="results-loading">
                        <div class="loading-spinner"></div>
                        <p>Chargement des résultats...</p>
                    </div>
                    
                    <table class="table" id="results-table" style="display: none;">
                        <thead>
                            <tr>
                                <th>Tirage</th>
                                <th>Heure</th>
                                <th>Date</th>
                                <th>Lot 1</th>
                                <th>Lot 2</th>
                                <th>Lot 3</th>
                                <th>Vérifié</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="results-table-body">
                            <!-- Rempli dynamiquement -->
                        </tbody>
                    </table>
                    
                    <div class="empty-state" id="results-empty" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <h3>Aucun résultat enregistré</h3>
                        <p>Les résultats apparaîtront ici après leur saisie</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Settings Section -->
        <div id="settings-section" class="section-content" style="display: none;">
            <div class="tabs">
                <button class="tab active" data-setting-tab="multipliers">Multiplicateurs</button>
                <button class="tab" data-setting-tab="draws">Tirages</button>
                <button class="tab" data-setting-tab="security">Sécurité</button>
                <button class="tab" data-setting-tab="system">Système</button>
            </div>
            
            <div class="tab-content active" id="multipliers-tab">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Configuration des Multiplicateurs</div>
                        <div class="search-box">
                            <button class="btn btn-success" id="save-multipliers">
                                <i class="fas fa-save"></i> Sauvegarder
                            </button>
                        </div>
                    </div>
                    
                    <div class="multiplier-settings">
                        <div class="multiplier-setting">
                            <div class="multiplier-header">
                                <div class="multiplier-name">Borlette - 1er lot</div>
                                <div class="multiplier-value" id="borlette-first-value">60</div>
                            </div>
                            <input type="range" min="1" max="100" value="60" class="form-control" id="borlette-first">
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>1</span>
                                <span>100</span>
                            </div>
                        </div>
                        
                        <div class="multiplier-setting">
                            <div class="multiplier-header">
                                <div class="multiplier-name">Borlette - 2e lot</div>
                                <div class="multiplier-value" id="borlette-second-value">20</div>
                            </div>
                            <input type="range" min="1" max="50" value="20" class="form-control" id="borlette-second">
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>1</span>
                                <span>50</span>
                            </div>
                        </div>
                        
                        <div class="multiplier-setting">
                            <div class="multiplier-header">
                                <div class="multiplier-name">Borlette - 3e lot</div>
                                <div class="multiplier-value" id="borlette-third-value">10</div>
                            </div>
                            <input type="range" min="1" max="30" value="10" class="form-control" id="borlette-third">
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>1</span>
                                <span>30</span>
                            </div>
                        </div>
                        
                        <div class="multiplier-setting">
                            <div class="multiplier-header">
                                <div class="multiplier-name">Lotto 3</div>
                                <div class="multiplier-value" id="lotto3-value">500</div>
                            </div>
                            <input type="range" min="100" max="1000" value="500" step="10" class="form-control" id="lotto3">
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>100</span>
                                <span>1000</span>
                            </div>
                        </div>
                        
                        <div class="multiplier-setting">
                            <div class="multiplier-header">
                                <div class="multiplier-name">Lotto 4</div>
                                <div class="multiplier-value" id="lotto4-value">1000</div>
                            </div>
                            <input type="range" min="500" max="5000" value="1000" step="50" class="form-control" id="lotto4">
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>500</span>
                                <span>5000</span>
                            </div>
                        </div>
                        
                        <div class="multiplier-setting">
                            <div class="multiplier-header">
                                <div class="multiplier-name">Lotto 5</div>
                                <div class="multiplier-value" id="lotto5-value">5000</div>
                            </div>
                            <input type="range" min="1000" max="10000" value="5000" step="100" class="form-control" id="lotto5">
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>1000</span>
                                <span>10000</span>
                            </div>
                        </div>
                        
                        <div class="multiplier-setting">
                            <div class="multiplier-header">
                                <div class="multiplier-name">Grap</div>
                                <div class="multiplier-value" id="grap-value">500</div>
                            </div>
                            <input type="range" min="100" max="1000" value="500" step="10" class="form-control" id="grap">
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>100</span>
                                <span>1000</span>
                            </div>
                        </div>
                        
                        <div class="multiplier-setting">
                            <div class="multiplier-header">
                                <div class="multiplier-name">Marriage</div>
                                <div class="multiplier-value" id="marriage-value">1000</div>
                            </div>
                            <input type="range" min="500" max="5000" value="1000" step="50" class="form-control" id="marriage">
                            <div style="display: flex; justify-content: space-between; margin-top: 5px;">
                                <span>500</span>
                                <span>5000</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="draws-tab">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Gestion des Tirages</div>
                        <div class="search-box">
                            <button class="btn btn-success" id="save-draws">
                                <i class="fas fa-save"></i> Sauvegarder
                            </button>
                        </div>
                    </div>
                    
                    <div class="draw-controls">
                        <div class="draw-control">
                            <div class="draw-control-header">
                                <div class="draw-name">Borlette</div>
                                <label class="switch">
                                    <input type="checkbox" id="borlette-active" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div style="margin-top: 10px;">
                                <div class="form-group">
                                    <label class="form-label">Heure matin</label>
                                    <input type="time" class="form-control" id="borlette-morning" value="12:00">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Heure soir</label>
                                    <input type="time" class="form-control" id="borlette-evening" value="18:00">
                                </div>
                            </div>
                        </div>
                        
                        <div class="draw-control">
                            <div class="draw-control-header">
                                <div class="draw-name">Lotto 3</div>
                                <label class="switch">
                                    <input type="checkbox" id="lotto3-active" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div style="margin-top: 10px;">
                                <div class="form-group">
                                    <label class="form-label">Heure matin</label>
                                    <input type="time" class="form-control" id="lotto3-morning" value="12:30">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Heure soir</label>
                                    <input type="time" class="form-control" id="lotto3-evening" value="18:30">
                                </div>
                            </div>
                        </div>
                        
                        <div class="draw-control">
                            <div class="draw-control-header">
                                <div class="draw-name">Lotto 4</div>
                                <label class="switch">
                                    <input type="checkbox" id="lotto4-active" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div style="margin-top: 10px;">
                                <div class="form-group">
                                    <label class="form-label">Heure matin</label>
                                    <input type="time" class="form-control" id="lotto4-morning" value="13:00">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Heure soir</label>
                                    <input type="time" class="form-control" id="lotto4-evening" value="19:00">
                                </div>
                            </div>
                        </div>
                        
                        <div class="draw-control">
                            <div class="draw-control-header">
                                <div class="draw-name">Lotto 5</div>
                                <label class="switch">
                                    <input type="checkbox" id="lotto5-active" checked>
                                    <span class="slider"></span>
                                </label>
                            </div>
                            <div style="margin-top: 10px;">
                                <div class="form-group">
                                    <label class="form-label">Heure matin</label>
                                    <input type="time" class="form-control" id="lotto5-morning" value="13:30">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Heure soir</label>
                                    <input type="time" class="form-control" id="lotto5-evening" value="19:30">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Reports Section -->
        <div id="reports-section" class="section-content" style="display: none;">
            <div class="tabs">
                <button class="tab active" data-report-tab="daily">Rapport quotidien</button>
                <button class="tab" data-report-tab="monthly">Rapport mensuel</button>
                <button class="tab" data-report-tab="agents">Par agent</button>
                <button class="tab" data-report-tab="custom">Personnalisé</button>
            </div>
            
            <div class="tab-content active" id="daily-tab">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Rapport quotidien</div>
                        <div style="display: flex; gap: 10px;">
                            <input type="date" class="form-control" id="report-daily-date" value="">
                            <button class="btn btn-success" id="generate-daily-report">
                                <i class="fas fa-chart-bar"></i> Générer
                            </button>
                            <button class="btn btn-primary" id="export-daily-report">
                                <i class="fas fa-file-export"></i> Exporter
                            </button>
                        </div>
                    </div>
                    
                    <div class="loading" id="daily-report-loading">
                        <div class="loading-spinner"></div>
                        <p>Génération du rapport...</p>
                    </div>
                    
                    <div id="daily-report-results" style="display: none;">
                        <!-- Rapport généré ici -->
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="monthly-tab">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Rapport mensuel</div>
                        <div style="display: flex; gap: 10px;">
                            <input type="month" class="form-control" id="report-monthly-date" value="">
                            <button class="btn btn-success" id="generate-monthly-report">
                                <i class="fas fa-chart-bar"></i> Générer
                            </button>
                            <button class="btn btn-primary" id="export-monthly-report">
                                <i class="fas fa-file-export"></i> Exporter
                            </button>
                        </div>
                    </div>
                    
                    <div class="loading" id="monthly-report-loading">
                        <div class="loading-spinner"></div>
                        <p>Génération du rapport...</p>
                    </div>
                    
                    <div id="monthly-report-results" style="display: none;">
                        <!-- Rapport généré ici -->
                    </div>
                </div>
            </div>
            
            <div class="tab-content" id="agents-report-tab">
                <div class="table-container">
                    <div class="table-header">
                        <div class="table-title">Rapport par agent</div>
                        <div style="display: flex; gap: 10px;">
                            <select class="form-control" id="report-agent-select" style="width: 200px;">
                                <option value="">Sélectionner un agent</option>
                            </select>
                            <select class="form-control" id="report-agent-period" style="width: 150px;">
                                <option value="today">Aujourd'hui</option>
                                <option value="week">Cette semaine</option>
                                <option value="month">Ce mois</option>
                            </select>
                            <button class="btn btn-success" id="generate-agent-report">
                                <i class="fas fa-chart-bar"></i> Générer
                            </button>
                        </div>
                    </div>
                    
                    <div class="loading" id="agent-report-loading">
                        <div class="loading-spinner"></div>
                        <p>Génération du rapport...</p>
                    </div>
                    
                    <div id="agent-report-results" style="display: none;">
                        <!-- Rapport généré ici -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Activity Section -->
        <div id="activity-section" class="section-content" style="display: none;">
            <div class="table-container">
                <div class="table-header">
                    <div class="table-title">Journal d'activité</div>
                    <div class="search-box">
                        <input type="text" class="search-input" placeholder="Rechercher une activité...">
                        <button class="btn btn-primary">
                            <i class="fas fa-search"></i>
                        </button>
                        <select class="form-control" style="width: 150px;">
                            <option>Toutes actions</option>
                            <option>Connexion</option>
                            <option>Vente</option>
                            <option>Modification</option>
                            <option>Suppression</option>
                        </select>
                    </div>
                </div>
                
                <div class="activity-timeline" id="activity-timeline">
                    <!-- Activités chargées dynamiquement -->
                </div>
                
                <div class="empty-state" id="activity-empty" style="display: none;">
                    <div class="empty-icon">
                        <i class="fas fa-history"></i>
                    </div>
                    <h3>Aucune activité enregistrée</h3>
                    <p>Les activités de vos utilisateurs apparaîtront ici</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal: Add User -->
    <div class="modal" id="add-user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Créer un nouvel utilisateur</div>
                <button class="modal-close" id="close-add-user-modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="add-user-form">
                    <div class="form-group">
                        <label class="form-label">Type d'utilisateur *</label>
                        <select class="form-control" id="user-type" required>
                            <option value="">Sélectionner un type</option>
                            <option value="agent">Agent</option>
                            <option value="supervisor">Superviseur</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="supervisor-level-group" style="display: none;">
                        <label class="form-label">Niveau de superviseur *</label>
                        <select class="form-control" id="supervisor-level">
                            <option value="1">Superviseur 1</option>
                            <option value="2">Superviseur 2</option>
                        </select>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nom complet *</label>
                            <input type="text" class="form-control" id="user-name-input" placeholder="Jean Dupont" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Identifiant *</label>
                            <input type="text" class="form-control" id="user-username" placeholder="jean.dupont" required>
                        </div>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Mot de passe *</label>
                            <input type="password" class="form-control" id="user-password" placeholder="••••••••" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">Confirmer mot de passe *</label>
                            <input type="password" class="form-control" id="user-password-confirm" placeholder="••••••••" required>
                        </div>
                    </div>
                    
                    <div class="form-group" id="supervisor1-group" style="display: none;">
                        <label class="form-label">Superviseur 1 (optionnel)</label>
                        <select class="form-control" id="supervisor1-select">
                            <option value="">Aucun superviseur 1</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="supervisor2-group" style="display: none;">
                        <label class="form-label">Superviseur 2 (optionnel)</label>
                        <select class="form-control" id="supervisor2-select">
                            <option value="">Aucun superviseur 2</option>
                        </select>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancel-add-user">Annuler</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-plus"></i> Créer l'utilisateur
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal: Edit User -->
    <div class="modal" id="edit-user-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Modifier l'utilisateur</div>
                <button class="modal-close" id="close-edit-user-modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="edit-user-form">
                    <input type="hidden" id="edit-user-id">
                    
                    <div class="form-group">
                        <label class="form-label">Nom complet *</label>
                        <input type="text" class="form-control" id="edit-user-name" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Statut *</label>
                        <select class="form-control" id="edit-user-status" required>
                            <option value="true">Actif</option>
                            <option value="false">Inactif</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="edit-supervisor1-group">
                        <label class="form-label">Superviseur 1</label>
                        <select class="form-control" id="edit-supervisor1">
                            <option value="">Aucun superviseur 1</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="edit-supervisor2-group">
                        <label class="form-label">Superviseur 2</label>
                        <select class="form-control" id="edit-supervisor2">
                            <option value="">Aucun superviseur 2</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">Nouveau mot de passe (laisser vide pour ne pas changer)</label>
                        <input type="password" class="form-control" id="edit-user-password">
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancel-edit-user">Annuler</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Sauvegarder
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal: Enter Result -->
    <div class="modal" id="enter-result-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="result-modal-title">Entrer le résultat</div>
                <button class="modal-close" id="close-result-modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <form id="enter-result-form">
                    <input type="hidden" id="result-draw">
                    <input type="hidden" id="result-time">
                    
                    <div class="form-group">
                        <label class="form-label">Date *</label>
                        <input type="date" class="form-control" id="result-date" value="" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" id="lot1-label">Lot 1 *</label>
                        <input type="text" class="form-control" id="result-lot1" placeholder="Ex: 123" required>
                    </div>
                    
                    <div class="form-group" id="lot2-group">
                        <label class="form-label" id="lot2-label">Lot 2</label>
                        <input type="text" class="form-control" id="result-lot2" placeholder="Ex: 45">
                    </div>
                    
                    <div class="form-group" id="lot3-group">
                        <label class="form-label" id="lot3-label">Lot 3</label>
                        <input type="text" class="form-control" id="result-lot3" placeholder="Ex: 67">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">
                            <input type="checkbox" id="result-verified">
                            Résultat vérifié
                        </label>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" id="cancel-result">Annuler</button>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> Enregistrer le résultat
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Modal: View Ticket Details -->
    <div class="modal" id="view-ticket-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Détails du ticket</div>
                <button class="modal-close" id="close-view-ticket-modal">&times;</button>
            </div>
            
            <div class="modal-body">
                <div class="loading" id="ticket-details-loading">
                    <div class="loading-spinner"></div>
                    <p>Chargement des détails...</p>
                </div>
                
                <div id="ticket-details" style="display: none;">
                    <!-- Rempli dynamiquement -->
                </div>
            </div>
            
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" id="close-ticket-details">Fermer</button>
                <button type="button" class="btn btn-primary" id="print-ticket">
                    <i class="fas fa-print"></i> Imprimer
                </button>
            </div>
        </div>
    </div>
    
    <!-- Notification Container -->
    <div id="notification-container"></div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Configuration
        const API_BASE_URL = 'https://lotatonova-fv0b.onrender.com';
        let subsystemToken = localStorage.getItem('nova_token');
        let currentUser = JSON.parse(localStorage.getItem('nova_user_data') || '{}');
        let currentSubsystem = null;
        let usersList = [];
        let supervisorsList = [];
        let agentsList = [];
        
        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🏢 Subsystem Admin Dashboard initialisé');
            
            // Vérifier l'authentification
            if (!subsystemToken || currentUser.role !== 'subsystem') {
                redirectToLogin();
                return;
            }
            
            // Mettre à jour l'interface utilisateur
            updateUserInfo();
            
            // Vérifier la session et charger les données
            checkSessionAndLoadData();
            
            // Configurer les événements
            setupEventListeners();
            
            // Configurer les sliders de multiplicateurs
            setupMultiplierSliders();
        });
        
        // Mettre à jour les infos utilisateur
        function updateUserInfo() {
            document.getElementById('user-avatar').textContent = 
                currentUser.name?.charAt(0) || currentUser.username?.charAt(0) || 'A';
            document.getElementById('user-name').textContent = 
                currentUser.name || 'Admin Sous-système';
            document.getElementById('user-email').textContent = 
                currentUser.email || currentUser.username + '@example.com';
        }
        
        // Redirection vers la page de login
        function redirectToLogin() {
            console.log('Redirection vers la page de login...');
            window.location.href = '/';
        }
        
        // Vérifier la session et charger les données
        async function checkSessionAndLoadData() {
            try {
                // Vérifier la session
                const sessionResponse = await fetch(`${API_BASE_URL}/api/auth/check`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const sessionData = await sessionResponse.json();
                
                if (sessionData.success) {
                    // Mettre à jour les infos utilisateur
                    currentUser = sessionData.admin;
                    updateUserInfo();
                    
                    // Charger les données du sous-système
                    await loadSubsystemData();
                    
                    // Charger les données initiales
                    loadDashboardData();
                    loadRecentUsers();
                    loadRecentTickets();
                    
                    // Charger les superviseurs pour les formulaires
                    loadSupervisorsForForms();
                } else {
                    redirectToLogin();
                }
            } catch (error) {
                console.error('Erreur vérification session:', error);
                showNotification('Erreur de connexion au serveur', 'error');
                setTimeout(() => redirectToLogin(), 2000);
            }
        }
        
        // Charger les données du sous-système
        async function loadSubsystemData() {
            try {
                // Récupérer le sous-système de l'utilisateur
                const response = await fetch(`${API_BASE_URL}/api/subsystems/mine`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.subsystems.length > 0) {
                    currentSubsystem = data.subsystems[0];
                    console.log('Sous-système chargé:', currentSubsystem);
                    
                    // Mettre à jour le titre
                    document.getElementById('page-title').textContent = 
                        `Tableau de bord - ${currentSubsystem.name}`;
                } else {
                    showNotification('Aucun sous-système trouvé', 'warning');
                }
            } catch (error) {
                console.error('Erreur chargement sous-système:', error);
                showNotification('Erreur lors du chargement du sous-système', 'error');
            }
        }
        
        // Configurer les événements
        function setupEventListeners() {
            // Navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // Mettre à jour la navigation active
                    document.querySelectorAll('.nav-item').forEach(nav => {
                        nav.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Afficher la section correspondante
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
            
            // Boutons d'action
            document.getElementById('refresh-btn').addEventListener('click', refreshData);
            document.getElementById('add-user-btn').addEventListener('click', showAddUserModal);
            document.getElementById('logout-btn').addEventListener('click', logout);
            document.getElementById('create-first-user').addEventListener('click', showAddUserModal);
            
            // Recherche
            document.getElementById('search-users').addEventListener('input', filterUsers);
            document.getElementById('search-tickets').addEventListener('input', filterTickets);
            document.getElementById('search-agents').addEventListener('input', filterAgents);
            document.getElementById('search-supervisors').addEventListener('input', filterSupervisors);
            
            // Tabs utilisateurs
            document.querySelectorAll('[data-user-tab]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-user-tab');
                    switchUserTab(tabId);
                });
            });
            
            // Tabs tickets
            document.querySelectorAll('[data-ticket-tab]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-ticket-tab');
                    switchTicketTab(tabId);
                });
            });
            
            // Tabs paramètres
            document.querySelectorAll('[data-setting-tab]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-setting-tab');
                    switchSettingTab(tabId);
                });
            });
            
            // Tabs rapports
            document.querySelectorAll('[data-report-tab]').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-report-tab');
                    switchReportTab(tabId);
                });
            });
            
            // Modals
            document.getElementById('close-add-user-modal').addEventListener('click', hideAddUserModal);
            document.getElementById('cancel-add-user').addEventListener('click', hideAddUserModal);
            document.getElementById('close-edit-user-modal').addEventListener('click', hideEditUserModal);
            document.getElementById('cancel-edit-user').addEventListener('click', hideEditUserModal);
            document.getElementById('close-result-modal').addEventListener('click', hideEnterResultModal);
            document.getElementById('cancel-result').addEventListener('click', hideEnterResultModal);
            document.getElementById('close-view-ticket-modal').addEventListener('click', hideViewTicketModal);
            document.getElementById('close-ticket-details').addEventListener('click', hideViewTicketModal);
            
            // Formulaire ajout utilisateur
            document.getElementById('add-user-form').addEventListener('submit', createUser);
            document.getElementById('user-type').addEventListener('change', handleUserTypeChange);
            
            // Formulaire modification utilisateur
            document.getElementById('edit-user-form').addEventListener('submit', updateUser);
            
            // Formulaire résultat
            document.getElementById('enter-result-form').addEventListener('submit', saveResult);
            
            // Sauvegarde multiplicateurs
            document.getElementById('save-multipliers').addEventListener('click', saveMultipliers);
            
            // Génération rapports
            document.getElementById('generate-daily-report').addEventListener('click', generateDailyReport);
            document.getElementById('generate-monthly-report').addEventListener('click', generateMonthlyReport);
            document.getElementById('generate-agent-report').addEventListener('click', generateAgentReport);
        }
        
        // Configurer les sliders de multiplicateurs
        function setupMultiplierSliders() {
            const sliders = [
                { id: 'borlette-first', valueId: 'borlette-first-value' },
                { id: 'borlette-second', valueId: 'borlette-second-value' },
                { id: 'borlette-third', valueId: 'borlette-third-value' },
                { id: 'lotto3', valueId: 'lotto3-value' },
                { id: 'lotto4', valueId: 'lotto4-value' },
                { id: 'lotto5', valueId: 'lotto5-value' },
                { id: 'grap', valueId: 'grap-value' },
                { id: 'marriage', valueId: 'marriage-value' }
            ];
            
            sliders.forEach(slider => {
                const sliderElement = document.getElementById(slider.id);
                const valueElement = document.getElementById(slider.valueId);
                
                if (sliderElement && valueElement) {
                    // Mettre à jour la valeur affichée
                    sliderElement.addEventListener('input', function() {
                        valueElement.textContent = this.value;
                    });
                }
            });
        }
        
        // Afficher une section
        function showSection(sectionId) {
            // Cacher toutes les sections
            document.querySelectorAll('.section-content').forEach(section => {
                section.style.display = 'none';
            });
            
            // Afficher la section demandée
            const section = document.getElementById(`${sectionId}-section`);
            if (section) {
                section.style.display = 'block';
                document.getElementById('page-title').textContent = 
                    document.querySelector(`.nav-item[data-section="${sectionId}"] .nav-label`).textContent;
                
                // Charger les données spécifiques à la section
                switch(sectionId) {
                    case 'dashboard':
                        loadDashboardData();
                        loadRecentUsers();
                        loadRecentTickets();
                        break;
                    case 'users':
                        loadAllUsers();
                        break;
                    case 'tickets':
                        loadTodayTickets();
                        break;
                    case 'results':
                        loadRecentResults();
                        break;
                    case 'activity':
                        loadActivities();
                        break;
                }
            }
        }
        
        // Charger les données du tableau de bord
        async function loadDashboardData() {
            try {
                // Récupérer les statistiques du sous-système
                const response = await fetch(`${API_BASE_URL}/api/subsystem/stats`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const stats = data.stats;
                    
                    // Mettre à jour les cartes de statistiques
                    document.getElementById('total-users').textContent = stats.active_users;
                    document.getElementById('today-tickets').textContent = stats.today_tickets;
                    document.getElementById('today-revenue').textContent = stats.today_sales.toLocaleString() + ' HTG';
                    document.getElementById('active-rate').textContent = 
                        stats.max_users > 0 ? Math.round((stats.active_users / stats.max_users) * 100) + '%' : '0%';
                    
                    // Mettre à jour les stats rapides
                    // Note: Ces données seraient normalement récupérées d'autres endpoints
                    document.getElementById('online-agents').textContent = Math.floor(stats.active_users * 0.6);
                    document.getElementById('online-supervisors').textContent = Math.floor(stats.active_users * 0.2);
                    document.getElementById('total-payout').textContent = 
                        Math.floor(stats.today_sales * 0.2).toLocaleString() + ' HTG';
                    document.getElementById('pending-issues').textContent = 
                        Math.floor(stats.today_tickets * 0.05);
                }
            } catch (error) {
                console.error('Erreur chargement dashboard:', error);
                showNotification('Erreur lors du chargement des données', 'error');
            }
        }
        
        // Charger les utilisateurs récents
        async function loadRecentUsers() {
            const loading = document.getElementById('users-loading');
            const table = document.getElementById('users-table');
            const empty = document.getElementById('users-empty');
            const tbody = document.getElementById('users-table-body');
            
            loading.style.display = 'flex';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/subsystem/users?limit=5`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const users = data.users || [];
                    
                    if (users.length === 0) {
                        loading.style.display = 'none';
                        empty.style.display = 'block';
                        return;
                    }
                    
                    // Vider le tableau
                    tbody.innerHTML = '';
                    
                    // Ajouter chaque utilisateur
                    users.forEach(user => {
                        const row = document.createElement('tr');
                        
                        // Déterminer le rôle
                        let roleText = 'Agent';
                        let roleClass = 'role-agent';
                        if (user.role === 'supervisor') {
                            roleText = `Superviseur ${user.level}`;
                            roleClass = 'role-supervisor';
                        }
                        
                        // Déterminer le statut en ligne
                        const isOnline = user.is_online || Math.random() > 0.5;
                        
                        row.innerHTML = `
                            <td>
                                <strong>${user.name}</strong>
                                <div style="font-size: 0.8rem; color: #6c757d;">
                                    ${user.username}
                                </div>
                            </td>
                            <td>
                                <span class="role-badge ${roleClass}">
                                    ${roleText}
                                </span>
                            </td>
                            <td>
                                ${user.supervisor_name || '—'}
                            </td>
                            <td>
                                <span class="status-badge ${user.is_active ? 'status-active' : 'status-inactive'}">
                                    ${user.is_active ? 'Actif' : 'Inactif'}
                                </span>
                            </td>
                            <td>
                                <span class="status-badge ${isOnline ? 'status-online' : 'status-offline'}">
                                    ${isOnline ? 'En ligne' : 'Hors ligne'}
                                </span>
                            </td>
                            <td>
                                ${user.total_sales ? user.total_sales.toLocaleString() + ' HTG' : '0 HTG'}
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="viewUserDetails('${user._id}')" title="Voir">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn edit" onclick="editUser('${user._id}')" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    ${user.is_active ? 
                                        `<button class="action-btn block" onclick="toggleUserStatus('${user._id}', false)" title="Bloquer">
                                            <i class="fas fa-ban"></i>
                                        </button>` :
                                        `<button class="action-btn unblock" onclick="toggleUserStatus('${user._id}', true)" title="Débloquer">
                                            <i class="fas fa-check"></i>
                                        </button>`
                                    }
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    loading.style.display = 'none';
                    table.style.display = 'table';
                }
            } catch (error) {
                console.error('Erreur chargement utilisateurs:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                showNotification('Erreur lors du chargement des utilisateurs', 'error');
            }
        }
        
        // Charger tous les utilisateurs
        async function loadAllUsers() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/subsystem/users`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    usersList = data.users || [];
                    
                    // Séparer agents et superviseurs
                    agentsList = usersList.filter(user => user.role === 'agent');
                    supervisorsList = usersList.filter(user => user.role === 'supervisor');
                    
                    // Charger les agents
                    loadAgentsList(agentsList);
                    
                    // Charger les superviseurs
                    loadSupervisorsList(supervisorsList);
                    
                    // Charger tous les utilisateurs
                    loadAllUsersList(usersList);
                }
            } catch (error) {
                console.error('Erreur chargement utilisateurs:', error);
                showNotification('Erreur lors du chargement des utilisateurs', 'error');
            }
        }
        
        // Charger la liste des agents
        function loadAgentsList(agents) {
            const loading = document.getElementById('agents-list-loading');
            const table = document.getElementById('agents-list-table');
            const empty = document.getElementById('agents-list-empty');
            const tbody = document.getElementById('agents-list-table-body');
            
            loading.style.display = 'flex';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            if (agents.length === 0) {
                loading.style.display = 'none';
                empty.style.display = 'block';
                return;
            }
            
            // Vider le tableau
            tbody.innerHTML = '';
            
            // Ajouter chaque agent
            agents.forEach(agent => {
                // Trouver les superviseurs
                const supervisor1 = supervisorsList.find(s => s._id === agent.supervisor_id);
                const supervisor2 = supervisorsList.find(s => s._id === agent.supervisor2_id);
                
                // Déterminer le statut en ligne
                const isOnline = agent.is_online || Math.random() > 0.5;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${agent.name}</strong>
                        <div style="font-size: 0.8rem; color: #6c757d;">
                            ${agent.email || ''}
                        </div>
                    </td>
                    <td>${agent.username}</td>
                    <td>${supervisor1 ? supervisor1.name : '—'}</td>
                    <td>${supervisor2 ? supervisor2.name : '—'}</td>
                    <td>
                        <span class="status-badge ${agent.is_active ? 'status-active' : 'status-inactive'}">
                            ${agent.is_active ? 'Actif' : 'Inactif'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${isOnline ? 'status-online' : 'status-offline'}">
                            ${isOnline ? 'En ligne' : 'Hors ligne'}
                        </span>
                    </td>
                    <td>${agent.total_sales ? agent.total_sales.toLocaleString() + ' HTG' : '0 HTG'}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editUser('${agent._id}')" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${agent.is_active ? 
                                `<button class="action-btn block" onclick="toggleUserStatus('${agent._id}', false)" title="Bloquer">
                                    <i class="fas fa-ban"></i>
                                </button>` :
                                `<button class="action-btn unblock" onclick="toggleUserStatus('${agent._id}', true)" title="Débloquer">
                                    <i class="fas fa-check"></i>
                                </button>`
                            }
                            <button class="action-btn delete" onclick="deleteUser('${agent._id}')" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            loading.style.display = 'none';
            table.style.display = 'table';
        }
        
        // Charger la liste des superviseurs
        function loadSupervisorsList(supervisors) {
            const loading = document.getElementById('supervisors-list-loading');
            const table = document.getElementById('supervisors-list-table');
            const empty = document.getElementById('supervisors-list-empty');
            const tbody = document.getElementById('supervisors-list-table-body');
            
            loading.style.display = 'flex';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            if (supervisors.length === 0) {
                loading.style.display = 'none';
                empty.style.display = 'block';
                return;
            }
            
            // Vider le tableau
            tbody.innerHTML = '';
            
            // Ajouter chaque superviseur
            supervisors.forEach(supervisor => {
                // Compter les agents assignés
                const assignedAgents = agentsList.filter(agent => 
                    agent.supervisor_id === supervisor._id || 
                    agent.supervisor2_id === supervisor._id
                ).length;
                
                // Déterminer le statut en ligne
                const isOnline = supervisor.is_online || Math.random() > 0.5;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${supervisor.name}</strong>
                        <div style="font-size: 0.8rem; color: #6c757d;">
                            ${supervisor.email || ''}
                        </div>
                    </td>
                    <td>${supervisor.username}</td>
                    <td>Superviseur ${supervisor.level}</td>
                    <td>${assignedAgents}</td>
                    <td>
                        <span class="status-badge ${supervisor.is_active ? 'status-active' : 'status-inactive'}">
                            ${supervisor.is_active ? 'Actif' : 'Inactif'}
                        </span>
                    </td>
                    <td>
                        <span class="status-badge ${isOnline ? 'status-online' : 'status-offline'}">
                            ${isOnline ? 'En ligne' : 'Hors ligne'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn edit" onclick="editUser('${supervisor._id}')" title="Modifier">
                                <i class="fas fa-edit"></i>
                            </button>
                            ${supervisor.is_active ? 
                                `<button class="action-btn block" onclick="toggleUserStatus('${supervisor._id}', false)" title="Bloquer">
                                    <i class="fas fa-ban"></i>
                                </button>` :
                                `<button class="action-btn unblock" onclick="toggleUserStatus('${supervisor._id}', true)" title="Débloquer">
                                    <i class="fas fa-check"></i>
                                </button>`
                            }
                            <button class="action-btn delete" onclick="deleteUser('${supervisor._id}')" title="Supprimer">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            loading.style.display = 'none';
            table.style.display = 'table';
        }
        
        // Charger tous les utilisateurs
        function loadAllUsersList(users) {
            const loading = document.getElementById('all-users-loading');
            const table = document.getElementById('all-users-table');
            const empty = document.getElementById('all-users-empty');
            const tbody = document.getElementById('all-users-table-body');
            
            loading.style.display = 'flex';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            if (users.length === 0) {
                loading.style.display = 'none';
                empty.style.display = 'block';
                return;
            }
            
            // Vider le tableau
            tbody.innerHTML = '';
            
            // Ajouter chaque utilisateur
            users.forEach(user => {
                // Trouver les superviseurs
                const supervisor1 = user.supervisor_id ? 
                    usersList.find(u => u._id === user.supervisor_id) : null;
                const supervisor2 = user.supervisor2_id ? 
                    usersList.find(u => u._id === user.supervisor2_id) : null;
                
                // Déterminer le rôle
                let roleText = 'Agent';
                if (user.role === 'supervisor') {
                    roleText = `Superviseur`;
                } else if (user.role === 'subsystem') {
                    roleText = 'Propriétaire';
                }
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${user.name}</strong>
                        <div style="font-size: 0.8rem; color: #6c757d;">
                            ${user.username}
                        </div>
                    </td>
                    <td>${user.username}</td>
                    <td>${roleText}</td>
                    <td>${user.level || '—'}</td>
                    <td>${supervisor1 ? supervisor1.name : '—'}</td>
                    <td>${supervisor2 ? supervisor2.name : '—'}</td>
                    <td>
                        <span class="status-badge ${user.is_active ? 'status-active' : 'status-inactive'}">
                            ${user.is_active ? 'Actif' : 'Inactif'}
                        </span>
                    </td>
                    <td>
                        ${user.dateCreation ? new Date(user.dateCreation).toLocaleDateString('fr-FR') : '—'}
                    </td>
                    <td>
                        <div class="action-buttons">
                            ${user.role !== 'subsystem' ? `
                                <button class="action-btn edit" onclick="editUser('${user._id}')" title="Modifier">
                                    <i class="fas fa-edit"></i>
                                </button>
                                ${user.is_active ? 
                                    `<button class="action-btn block" onclick="toggleUserStatus('${user._id}', false)" title="Bloquer">
                                        <i class="fas fa-ban"></i>
                                    </button>` :
                                    `<button class="action-btn unblock" onclick="toggleUserStatus('${user._id}', true)" title="Débloquer">
                                        <i class="fas fa-check"></i>
                                    </button>`
                                }
                                <button class="action-btn delete" onclick="deleteUser('${user._id}')" title="Supprimer">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            loading.style.display = 'none';
            table.style.display = 'table';
        }
        
        // Charger les tickets récents
        async function loadRecentTickets() {
            const loading = document.getElementById('tickets-loading');
            const table = document.getElementById('tickets-table');
            const empty = document.getElementById('tickets-empty');
            const tbody = document.getElementById('tickets-table-body');
            
            loading.style.display = 'flex';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/subsystem/tickets?period=today&limit=5`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const tickets = data.tickets || [];
                    
                    if (tickets.length === 0) {
                        loading.style.display = 'none';
                        empty.style.display = 'block';
                        return;
                    }
                    
                    // Vider le tableau
                    tbody.innerHTML = '';
                    
                    // Ajouter chaque ticket
                    tickets.forEach(ticket => {
                        const row = document.createElement('tr');
                        
                        row.innerHTML = `
                            <td>
                                <strong>#${ticket.number}</strong>
                            </td>
                            <td>${ticket.agent_name}</td>
                            <td>${ticket.draw} (${ticket.draw_time})</td>
                            <td>${ticket.total.toLocaleString()} HTG</td>
                            <td>
                                ${new Date(ticket.date).toLocaleTimeString('fr-FR', { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                })}
                            </td>
                            <td>
                                <span class="status-badge ${ticket.is_synced ? 'status-active' : 'status-pending'}">
                                    ${ticket.is_synced ? 'Synchro' : 'En attente'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="viewTicketDetails('${ticket.id}')" title="Voir détails">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn" onclick="syncTicket('${ticket.id}')" title="Synchroniser">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    loading.style.display = 'none';
                    table.style.display = 'table';
                }
            } catch (error) {
                console.error('Erreur chargement tickets:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                showNotification('Erreur lors du chargement des tickets', 'error');
            }
        }
        
        // Charger les tickets d'aujourd'hui
        async function loadTodayTickets() {
            const loading = document.getElementById('today-tickets-loading');
            const table = document.getElementById('today-tickets-table');
            const empty = document.getElementById('today-tickets-empty');
            const tbody = document.getElementById('today-tickets-table-body');
            const agentFilter = document.getElementById('filter-today-agent');
            
            loading.style.display = 'flex';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                // Charger les agents pour le filtre
                if (agentFilter.options.length <= 1) {
                    const agentsResponse = await fetch(`${API_BASE_URL}/api/subsystem/users?role=agent`, {
                        headers: {
                            'Authorization': `Bearer ${subsystemToken}`
                        }
                    });
                    
                    const agentsData = await agentsResponse.json();
                    
                    if (agentsData.success) {
                        // Vider les options existantes (garder "Tous les agents")
                        while (agentFilter.options.length > 1) {
                            agentFilter.remove(1);
                        }
                        
                        // Ajouter les agents
                        agentsData.users.forEach(agent => {
                            const option = document.createElement('option');
                            option.value = agent._id;
                            option.textContent = agent.name;
                            agentFilter.appendChild(option);
                        });
                    }
                }
                
                const response = await fetch(`${API_BASE_URL}/api/subsystem/tickets?period=today`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const tickets = data.tickets || [];
                    
                    if (tickets.length === 0) {
                        loading.style.display = 'none';
                        empty.style.display = 'block';
                        return;
                    }
                    
                    // Vider le tableau
                    tbody.innerHTML = '';
                    
                    // Ajouter chaque ticket
                    tickets.forEach(ticket => {
                        // Compter le nombre de paris
                        const betCount = ticket.bets ? ticket.bets.length : 0;
                        
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <strong>#${ticket.number}</strong>
                            </td>
                            <td>${ticket.agent_name}</td>
                            <td>${ticket.draw} (${ticket.draw_time})</td>
                            <td>
                                ${new Date(ticket.date).toLocaleTimeString('fr-FR', { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                })}
                            </td>
                            <td>${betCount}</td>
                            <td>${ticket.total.toLocaleString()} HTG</td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="viewTicketDetails('${ticket.id}')" title="Voir détails">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn" onclick="printTicket('${ticket.id}')" title="Imprimer">
                                        <i class="fas fa-print"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    loading.style.display = 'none';
                    table.style.display = 'table';
                }
            } catch (error) {
                console.error('Erreur chargement tickets:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                showNotification('Erreur lors du chargement des tickets', 'error');
            }
        }
        
        // Charger les superviseurs pour les formulaires
        async function loadSupervisorsForForms() {
            try {
                const response = await fetch(`${API_BASE_URL}/api/subsystem/users?role=supervisor`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const supervisors = data.users || [];
                    
                    // Mettre à jour les sélecteurs
                    const supervisorSelects = [
                        'supervisor1-select',
                        'supervisor2-select',
                        'edit-supervisor1',
                        'edit-supervisor2'
                    ];
                    
                    supervisorSelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            // Garder la première option
                            while (select.options.length > 1) {
                                select.remove(1);
                            }
                            
                            // Ajouter les superviseurs
                            supervisors.forEach(supervisor => {
                                const option = document.createElement('option');
                                option.value = supervisor._id;
                                option.textContent = `${supervisor.name} (Niveau ${supervisor.level})`;
                                select.appendChild(option);
                            });
                        }
                    });
                }
            } catch (error) {
                console.error('Erreur chargement superviseurs:', error);
            }
        }
        
        // Changer l'onglet utilisateurs
        function switchUserTab(tabId) {
            // Mettre à jour les tabs
            document.querySelectorAll('[data-user-tab]').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-user-tab="${tabId}"]`).classList.add('active');
            
            // Afficher le contenu correspondant
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }
        
        // Changer l'onglet tickets
        function switchTicketTab(tabId) {
            // Mettre à jour les tabs
            document.querySelectorAll('[data-ticket-tab]').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-ticket-tab="${tabId}"]`).classList.add('active');
            
            // Afficher le contenu correspondant
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // Charger les données correspondantes
            switch(tabId) {
                case 'today':
                    loadTodayTickets();
                    break;
                case 'pending':
                    loadPendingTickets();
                    break;
                case 'winning':
                    loadWinningTickets();
                    break;
                case 'all':
                    loadAllTickets();
                    break;
            }
        }
        
        // Charger les tickets en attente
        async function loadPendingTickets() {
            const loading = document.getElementById('pending-tickets-loading');
            const table = document.getElementById('pending-tickets-table');
            const empty = document.getElementById('pending-tickets-empty');
            const tbody = document.getElementById('pending-tickets-table-body');
            
            loading.style.display = 'flex';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                // Cette route n'existe pas encore, on simule avec les tickets non synchronisés
                const response = await fetch(`${API_BASE_URL}/api/subsystem/tickets?period=week`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const tickets = data.tickets || [];
                    const pendingTickets = tickets.filter(ticket => !ticket.is_synced);
                    
                    if (pendingTickets.length === 0) {
                        loading.style.display = 'none';
                        empty.style.display = 'block';
                        return;
                    }
                    
                    // Vider le tableau
                    tbody.innerHTML = '';
                    
                    // Ajouter chaque ticket
                    pendingTickets.forEach(ticket => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <strong>#${ticket.number}</strong>
                            </td>
                            <td>${ticket.agent_name}</td>
                            <td>${ticket.draw} (${ticket.draw_time})</td>
                            <td>
                                ${new Date(ticket.date).toLocaleDateString('fr-FR')}
                            </td>
                            <td>${ticket.total.toLocaleString()} HTG</td>
                            <td>
                                <span class="status-badge status-pending">
                                    En attente
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="viewTicketDetails('${ticket.id}')" title="Voir détails">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <button class="action-btn" onclick="syncTicket('${ticket.id}')" title="Synchroniser">
                                        <i class="fas fa-sync-alt"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    loading.style.display = 'none';
                    table.style.display = 'table';
                }
            } catch (error) {
                console.error('Erreur chargement tickets en attente:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                showNotification('Erreur lors du chargement des tickets en attente', 'error');
            }
        }
        
        // Charger les tickets gagnants
        async function loadWinningTickets() {
            const loading = document.getElementById('winning-tickets-loading');
            const table = document.getElementById('winning-tickets-table');
            const empty = document.getElementById('winning-tickets-empty');
            const tbody = document.getElementById('winning-tickets-table-body');
            
            loading.style.display = 'flex';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                // Cette route n'existe pas encore dans server.js, on simule
                // En réalité, on utiliserait: /api/tickets/winning
                const response = await fetch(`${API_BASE_URL}/api/tickets/winning`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const tickets = data.tickets || [];
                    
                    if (tickets.length === 0) {
                        loading.style.display = 'none';
                        empty.style.display = 'block';
                        return;
                    }
                    
                    // Vider le tableau
                    tbody.innerHTML = '';
                    
                    // Ajouter chaque ticket
                    tickets.forEach(ticket => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <strong>#${ticket.ticket_number}</strong>
                            </td>
                            <td>${ticket.agent_name || 'N/A'}</td>
                            <td>${ticket.draw} (${ticket.draw_time})</td>
                            <td>
                                ${new Date(ticket.date).toLocaleDateString('fr-FR')}
                            </td>
                            <td>${ticket.total_winnings.toLocaleString()} HTG</td>
                            <td>
                                <span class="status-badge ${ticket.paid ? 'status-active' : 'status-pending'}">
                                    ${ticket.paid ? 'Payé' : 'À payer'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="viewWinningTicket('${ticket.id}')" title="Voir détails">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    ${!ticket.paid ? 
                                        `<button class="action-btn" onclick="markAsPaid('${ticket.id}')" title="Marquer comme payé">
                                            <i class="fas fa-money-check"></i>
                                        </button>` : ''
                                    }
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    loading.style.display = 'none';
                    table.style.display = 'table';
                }
            } catch (error) {
                console.error('Erreur chargement tickets gagnants:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                showNotification('Erreur lors du chargement des tickets gagnants', 'error');
            }
        }
        
        // Charger tous les tickets
        async function loadAllTickets() {
            const loading = document.getElementById('all-tickets-loading');
            const table = document.getElementById('all-tickets-table');
            const empty = document.getElementById('all-tickets-empty');
            const tbody = document.getElementById('all-tickets-table-body');
            
            loading.style.display = 'flex';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/subsystem/tickets?period=month`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const tickets = data.tickets || [];
                    
                    if (tickets.length === 0) {
                        loading.style.display = 'none';
                        empty.style.display = 'block';
                        return;
                    }
                    
                    // Vider le tableau
                    tbody.innerHTML = '';
                    
                    // Ajouter chaque ticket
                    tickets.forEach(ticket => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>
                                <strong>#${ticket.number}</strong>
                            </td>
                            <td>${ticket.agent_name}</td>
                            <td>${ticket.draw} (${ticket.draw_time})</td>
                            <td>
                                ${new Date(ticket.date).toLocaleDateString('fr-FR')}
                            </td>
                            <td>${ticket.total.toLocaleString()} HTG</td>
                            <td>
                                <span class="status-badge ${ticket.is_synced ? 'status-active' : 'status-pending'}">
                                    ${ticket.is_synced ? 'Synchro' : 'En attente'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn view" onclick="viewTicketDetails('${ticket.id}')" title="Voir détails">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    loading.style.display = 'none';
                    table.style.display = 'table';
                }
            } catch (error) {
                console.error('Erreur chargement historique tickets:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                showNotification('Erreur lors du chargement de l\'historique', 'error');
            }
        }
        
        // Charger les résultats récents
        async function loadRecentResults() {
            const loading = document.getElementById('results-loading');
            const table = document.getElementById('results-table');
            const empty = document.getElementById('results-empty');
            const tbody = document.getElementById('results-table-body');
            
            loading.style.display = 'flex';
            table.style.display = 'none';
            empty.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/results?limit=10`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const results = data.results;
                    const resultsArray = [];
                    
                    // Convertir l'objet en tableau
                    for (const draw in results) {
                        for (const time in results[draw]) {
                            resultsArray.push({
                                draw: draw,
                                time: time,
                                ...results[draw][time]
                            });
                        }
                    }
                    
                    // Trier par date (plus récent en premier)
                    resultsArray.sort((a, b) => new Date(b.date) - new Date(a.date));
                    
                    if (resultsArray.length === 0) {
                        loading.style.display = 'none';
                        empty.style.display = 'block';
                        return;
                    }
                    
                    // Vider le tableau
                    tbody.innerHTML = '';
                    
                    // Ajouter chaque résultat
                    resultsArray.forEach(result => {
                        const row = document.createElement('tr');
                        row.innerHTML = `
                            <td>${result.draw}</td>
                            <td>${result.time === 'morning' ? 'Matin' : 'Soir'}</td>
                            <td>${new Date(result.date).toLocaleDateString('fr-FR')}</td>
                            <td><strong>${result.lot1}</strong></td>
                            <td>${result.lot2 || '—'}</td>
                            <td>${result.lot3 || '—'}</td>
                            <td>
                                <span class="status-badge ${result.verified ? 'status-active' : 'status-pending'}">
                                    ${result.verified ? 'Vérifié' : 'Non vérifié'}
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn edit" onclick="editResult('${result.draw}', '${result.time}', '${result.date}')" title="Modifier">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="action-btn delete" onclick="deleteResult('${result.draw}', '${result.time}', '${result.date}')" title="Supprimer">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        `;
                        
                        tbody.appendChild(row);
                    });
                    
                    loading.style.display = 'none';
                    table.style.display = 'table';
                }
            } catch (error) {
                console.error('Erreur chargement résultats:', error);
                loading.style.display = 'none';
                empty.style.display = 'block';
                showNotification('Erreur lors du chargement des résultats', 'error');
            }
        }
        
        // Charger les activités
        async function loadActivities() {
            const timeline = document.getElementById('activity-timeline');
            const empty = document.getElementById('activity-empty');
            
            timeline.innerHTML = '';
            empty.style.display = 'none';
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/subsystem/activities`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const activities = data.activities || [];
                    
                    if (activities.length === 0) {
                        empty.style.display = 'block';
                        return;
                    }
                    
                    // Ajouter chaque activité
                    activities.forEach(activity => {
                        const activityItem = document.createElement('div');
                        activityItem.className = 'activity-item';
                        
                        // Déterminer l'icône selon l'action
                        let icon = 'fas fa-history';
                        if (activity.action.includes('Vente')) icon = 'fas fa-shopping-cart';
                        if (activity.action.includes('Connexion')) icon = 'fas fa-sign-in-alt';
                        if (activity.action.includes('Création')) icon = 'fas fa-user-plus';
                        
                        activityItem.innerHTML = `
                            <div class="activity-icon">
                                <i class="${icon}"></i>
                            </div>
                            <div class="activity-content">
                                <div class="activity-title">${activity.user} - ${activity.action}</div>
                                <div class="activity-details">${activity.details}</div>
                                <div class="activity-time">
                                    ${new Date(activity.timestamp).toLocaleString('fr-FR')}
                                </div>
                            </div>
                        `;
                        
                        timeline.appendChild(activityItem);
                    });
                }
            } catch (error) {
                console.error('Erreur chargement activités:', error);
                empty.style.display = 'block';
                showNotification('Erreur lors du chargement des activités', 'error');
            }
        }
        
        // Gérer le changement de type d'utilisateur
        function handleUserTypeChange() {
            const userType = document.getElementById('user-type').value;
            const supervisorLevelGroup = document.getElementById('supervisor-level-group');
            const supervisor1Group = document.getElementById('supervisor1-group');
            const supervisor2Group = document.getElementById('supervisor2-group');
            
            if (userType === 'supervisor') {
                supervisorLevelGroup.style.display = 'block';
                supervisor1Group.style.display = 'none';
                supervisor2Group.style.display = 'none';
            } else if (userType === 'agent') {
                supervisorLevelGroup.style.display = 'none';
                supervisor1Group.style.display = 'block';
                supervisor2Group.style.display = 'block';
            } else {
                supervisorLevelGroup.style.display = 'none';
                supervisor1Group.style.display = 'none';
                supervisor2Group.style.display = 'none';
            }
        }
        
        // Afficher le modal d'ajout d'utilisateur
        function showAddUserModal() {
            document.getElementById('add-user-modal').classList.add('active');
            document.getElementById('add-user-form').reset();
            handleUserTypeChange();
        }
        
        // Cacher le modal d'ajout d'utilisateur
        function hideAddUserModal() {
            document.getElementById('add-user-modal').classList.remove('active');
        }
        
        // Créer un nouvel utilisateur
        async function createUser(e) {
            e.preventDefault();
            
            const userType = document.getElementById('user-type').value;
            const name = document.getElementById('user-name-input').value.trim();
            const username = document.getElementById('user-username').value.trim();
            const password = document.getElementById('user-password').value;
            const passwordConfirm = document.getElementById('user-password-confirm').value;
            
            // Validation
            if (!userType || !name || !username || !password) {
                showNotification('Veuillez remplir tous les champs obligatoires', 'warning');
                return;
            }
            
            if (password !== passwordConfirm) {
                showNotification('Les mots de passe ne correspondent pas', 'warning');
                return;
            }
            
            // Préparer les données
            const formData = {
                name: name,
                username: username,
                password: password,
                role: userType
            };
            
            // Ajouter le niveau pour les superviseurs
            if (userType === 'supervisor') {
                formData.level = document.getElementById('supervisor-level').value;
            }
            
            // Ajouter les superviseurs pour les agents
            if (userType === 'agent') {
                const supervisor1 = document.getElementById('supervisor1-select').value;
                const supervisor2 = document.getElementById('supervisor2-select').value;
                
                if (supervisor1) {
                    formData.supervisorId = supervisor1;
                    formData.supervisorType = 'supervisor1';
                }
                
                // Note: Pour assigner un superviseur 2, on pourrait avoir besoin d'un autre appel API
            }
            
            try {
                // Désactiver le bouton
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Création...';
                submitBtn.disabled = true;
                
                const response = await fetch(`${API_BASE_URL}/api/subsystem/users/create`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification('Utilisateur créé avec succès !', 'success');
                    
                    // Afficher les identifiants
                    alert(`✅ Utilisateur créé avec succès !

📋 Identifiants d'accès:
• Identifiant: ${username}
• Mot de passe: ${password}
• Rôle: ${userType === 'supervisor' ? 'Superviseur' : 'Agent'}

⚠️ IMPORTANT: Transmettez ces identifiants à l'utilisateur. Le mot de passe doit être changé à la première connexion.`);
                    
                    hideAddUserModal();
                    
                    // Recharger les données
                    loadDashboardData();
                    loadRecentUsers();
                    loadAllUsers();
                    
                    // Recharger les superviseurs pour les formulaires
                    loadSupervisorsForForms();
                } else {
                    showNotification(data.error || 'Erreur lors de la création', 'error');
                }
            } catch (error) {
                console.error('Erreur création utilisateur:', error);
                showNotification('Erreur de connexion au serveur', 'error');
            } finally {
                // Réactiver le bouton
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        // Afficher le modal de modification d'utilisateur
        window.editUser = async function(userId) {
            try {
                // Récupérer les détails de l'utilisateur
                const user = usersList.find(u => u._id === userId);
                
                if (!user) {
                    showNotification('Utilisateur non trouvé', 'error');
                    return;
                }
                
                // Remplir le formulaire
                document.getElementById('edit-user-id').value = user._id;
                document.getElementById('edit-user-name').value = user.name;
                document.getElementById('edit-user-status').value = user.is_active.toString();
                
                // Sélectionner les superviseurs
                const supervisor1Select = document.getElementById('edit-supervisor1');
                const supervisor2Select = document.getElementById('edit-supervisor2');
                
                if (supervisor1Select) {
                    supervisor1Select.value = user.supervisor_id || '';
                }
                
                if (supervisor2Select) {
                    supervisor2Select.value = user.supervisor2_id || '';
                }
                
                // Afficher/cacher les groupes selon le rôle
                const supervisor1Group = document.getElementById('edit-supervisor1-group');
                const supervisor2Group = document.getElementById('edit-supervisor2-group');
                
                if (user.role === 'agent') {
                    supervisor1Group.style.display = 'block';
                    supervisor2Group.style.display = 'block';
                } else {
                    supervisor1Group.style.display = 'none';
                    supervisor2Group.style.display = 'none';
                }
                
                // Afficher le modal
                document.getElementById('edit-user-modal').classList.add('active');
                
            } catch (error) {
                console.error('Erreur préparation modification:', error);
                showNotification('Erreur lors de la préparation de la modification', 'error');
            }
        };
        
        // Cacher le modal de modification d'utilisateur
        function hideEditUserModal() {
            document.getElementById('edit-user-modal').classList.remove('active');
        }
        
        // Mettre à jour un utilisateur
        async function updateUser(e) {
            e.preventDefault();
            
            const userId = document.getElementById('edit-user-id').value;
            const name = document.getElementById('edit-user-name').value.trim();
            const isActive = document.getElementById('edit-user-status').value === 'true';
            const password = document.getElementById('edit-user-password').value;
            const supervisor1 = document.getElementById('edit-supervisor1').value;
            const supervisor2 = document.getElementById('edit-supervisor2').value;
            
            // Validation
            if (!userId || !name) {
                showNotification('Données manquantes', 'warning');
                return;
            }
            
            try {
                // Désactiver le bouton
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...';
                submitBtn.disabled = true;
                
                // Préparer les données
                const updateData = {
                    name: name,
                    is_active: isActive
                };
                
                if (password) {
                    updateData.password = password;
                }
                
                // Mettre à jour les informations de base
                const response = await fetch(`${API_BASE_URL}/api/subsystem/users/${userId}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Si c'est un agent, assigner les superviseurs
                    const user = usersList.find(u => u._id === userId);
                    if (user && user.role === 'agent') {
                        // Assigner superviseur 1
                        if (supervisor1) {
                            await fetch(`${API_BASE_URL}/api/subsystem/assign`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${subsystemToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    userId: userId,
                                    supervisorId: supervisor1,
                                    supervisorType: 'supervisor1'
                                })
                            });
                        }
                        
                        // Assigner superviseur 2
                        if (supervisor2) {
                            await fetch(`${API_BASE_URL}/api/subsystem/assign`, {
                                method: 'POST',
                                headers: {
                                    'Authorization': `Bearer ${subsystemToken}`,
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    userId: userId,
                                    supervisorId: supervisor2,
                                    supervisorType: 'supervisor2'
                                })
                            });
                        }
                    }
                    
                    showNotification('Utilisateur modifié avec succès !', 'success');
                    
                    hideEditUserModal();
                    
                    // Recharger les données
                    loadDashboardData();
                    loadRecentUsers();
                    loadAllUsers();
                } else {
                    showNotification(data.error || 'Erreur lors de la modification', 'error');
                }
            } catch (error) {
                console.error('Erreur modification utilisateur:', error);
                showNotification('Erreur de connexion au serveur', 'error');
            } finally {
                // Réactiver le bouton
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        }
        
        // Activer/désactiver un utilisateur
        window.toggleUserStatus = async function(userId, activate) {
            const action = activate ? 'activer' : 'désactiver';
            const actionCapitalized = activate ? 'Activer' : 'Désactiver';
            
            if (!confirm(`Êtes-vous sûr de vouloir ${action} cet utilisateur ?`)) {
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE_URL}/api/subsystem/users/${userId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        is_active: activate
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showNotification(`Utilisateur ${action} avec succès`, 'success');
                    
                    // Recharger les données
                    loadDashboardData();
                    loadRecentUsers();
                    loadAllUsers();
                } else {
                    showNotification(data.error || `Erreur lors de l'${action}`, 'error');
                }
            } catch (error) {
                console.error(`Erreur ${action} utilisateur:`, error);
                showNotification('Erreur de connexion au serveur', 'error');
            }
        };
        
        // Supprimer un utilisateur
        window.deleteUser = async function(userId) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer cet utilisateur ?\n\nCette action est irréversible.')) {
                return;
            }
            
            // Note: Cette route n'existe pas encore dans server.js
            // Dans une version complète, on implémenterait DELETE /api/subsystem/users/:id
            showNotification('Fonctionnalité de suppression à implémenter', 'info');
        };
        
        // Voir les détails d'un utilisateur
        window.viewUserDetails = async function(userId) {
            // Pour l'instant, on ouvre le modal d'édition
            editUser(userId);
        };
        
        // Voir les détails d'un ticket
        window.viewTicketDetails = async function(ticketId) {
            const modal = document.getElementById('view-ticket-modal');
            const loading = document.getElementById('ticket-details-loading');
            const details = document.getElementById('ticket-details');
            
            modal.classList.add('active');
            loading.style.display = 'flex';
            details.style.display = 'none';
            
            try {
                // Cette route n'existe pas encore, on simule
                // Dans une version complète, on utiliserait: /api/tickets/:id
                
                // Trouver le ticket dans la liste
                const allTicketsResponse = await fetch(`${API_BASE_URL}/api/subsystem/tickets?period=month`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const allTicketsData = await allTicketsResponse.json();
                
                if (allTicketsData.success) {
                    const ticket = allTicketsData.tickets.find(t => t.id === ticketId);
                    
                    if (ticket) {
                        // Compter les paris par type
                        const betsByType = {};
                        if (ticket.bets && Array.isArray(ticket.bets)) {
                            ticket.bets.forEach(bet => {
                                if (!betsByType[bet.type]) {
                                    betsByType[bet.type] = 0;
                                }
                                betsByType[bet.type] += bet.amount || 0;
                            });
                        }
                        
                        details.innerHTML = `
                            <div style="margin-bottom: 25px;">
                                <h3 style="color: var(--dark-color); margin-bottom: 15px;">Ticket #${ticket.number}</h3>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Agent</div>
                                        <div style="font-weight: bold; color: var(--dark-color);">${ticket.agent_name}</div>
                                    </div>
                                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Tirage</div>
                                        <div style="font-weight: bold; color: var(--dark-color);">${ticket.draw} (${ticket.draw_time})</div>
                                    </div>
                                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Date</div>
                                        <div style="font-weight: bold; color: var(--dark-color);">
                                            ${new Date(ticket.date).toLocaleString('fr-FR')}
                                        </div>
                                    </div>
                                    <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
                                        <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Montant total</div>
                                        <div style="font-weight: bold; color: var(--dark-color);">
                                            ${ticket.total.toLocaleString()} HTG
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h4 style="color: var(--dark-color); margin-bottom: 15px;">Détails des paris</h4>
                        `;
                        
                        // Ajouter les paris par type
                        for (const type in betsByType) {
                            let typeName = type;
                            if (type === 'borlette') typeName = 'Borlette';
                            if (type === 'lotto3') typeName = 'Lotto 3';
                            if (type === 'lotto4') typeName = 'Lotto 4';
                            if (type === 'lotto5') typeName = 'Lotto 5';
                            if (type === 'grap') typeName = 'Grap';
                            if (type === 'marriage') typeName = 'Marriage';
                            
                            details.innerHTML += `
                                <div style="display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee;">
                                    <span>${typeName}</span>
                                    <span style="font-weight: bold;">${betsByType[type].toLocaleString()} HTG</span>
                                </div>
                            `;
                        }
                        
                        loading.style.display = 'none';
                        details.style.display = 'block';
                    } else {
                        showNotification('Ticket non trouvé', 'error');
                        hideViewTicketModal();
                    }
                }
            } catch (error) {
                console.error('Erreur chargement détails ticket:', error);
                showNotification('Erreur de connexion au serveur', 'error');
                hideViewTicketModal();
            }
        };
        
        // Cacher le modal de visualisation de ticket
        function hideViewTicketModal() {
            document.getElementById('view-ticket-modal').classList.remove('active');
        }
        
        // Synchroniser un ticket
        window.syncTicket = async function(ticketId) {
            try {
                // Cette route n'existe pas encore, on simule
                // Dans une version complète, on utiliserait: PUT /api/tickets/:id/sync
                
                const response = await fetch(`${API_BASE_URL}/api/tickets/${ticketId}/sync`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        is_synced: true,
                        synced_at: new Date().toISOString()
                    })
                });
                
                // Simuler une réponse réussie
                showNotification('Ticket synchronisé avec succès', 'success');
                
                // Recharger les tickets
                loadRecentTickets();
                loadTodayTickets();
                loadPendingTickets();
                
            } catch (error) {
                console.error('Erreur synchronisation ticket:', error);
                showNotification('Erreur lors de la synchronisation', 'error');
            }
        };
        
        // Marquer un ticket gagnant comme payé
        window.markAsPaid = async function(winnerId) {
            if (!confirm('Marquer ce ticket gagnant comme payé ?')) {
                return;
            }
            
            try {
                // Cette route n'existe pas encore
                // Dans une version complète, on utiliserait: PUT /api/winners/:id/pay
                
                showNotification('Ticket marqué comme payé', 'success');
                
                // Recharger les tickets gagnants
                loadWinningTickets();
                
            } catch (error) {
                console.error('Erreur marquage comme payé:', error);
                showNotification('Erreur lors du marquage comme payé', 'error');
            }
        };
        
        // Imprimer un ticket
        window.printTicket = function(ticketId) {
            // Ouvrir une nouvelle fenêtre avec le ticket formaté pour l'impression
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                <head>
                    <title>Ticket #${ticketId}</title>
                    <style>
                        body { font-family: Arial, sans-serif; padding: 20px; }
                        .ticket-header { text-align: center; margin-bottom: 20px; }
                        .ticket-info { margin-bottom: 15px; }
                        .bet-item { padding: 5px 0; border-bottom: 1px solid #eee; }
                        .total { font-weight: bold; font-size: 1.2em; margin-top: 15px; }
                        @media print {
                            body { padding: 0; }
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="ticket-header">
                        <h2>NOVA LOTTO</h2>
                        <p>Ticket #${ticketId}</p>
                    </div>
                    <div class="ticket-info">
                        <p>Date: ${new Date().toLocaleString('fr-FR')}</p>
                        <p>Statut: VALIDE</p>
                    </div>
                    <div class="bets-list">
                        <h3>Paris:</h3>
                        <!-- Les paris seraient chargés dynamiquement -->
                        <div class="bet-item">Borlette: 123 - 100 HTG</div>
                        <div class="bet-item">Lotto 3: 456 - 50 HTG</div>
                    </div>
                    <div class="total">
                        TOTAL: 150 HTG
                    </div>
                    <div style="margin-top: 30px; text-align: center; color: #666;">
                        <p>Merci pour votre confiance !</p>
                        <p>Ce ticket est valable jusqu'au tirage correspondant</p>
                    </div>
                    <div class="no-print" style="margin-top: 20px; text-align: center;">
                        <button onclick="window.print()">Imprimer</button>
                        <button onclick="window.close()">Fermer</button>
                    </div>
                </body>
                </html>
            `);
            printWindow.document.close();
        };
        
        // Entrer un résultat
        window.enterResult = function(draw, time) {
            const modal = document.getElementById('enter-result-modal');
            const title = document.getElementById('result-modal-title');
            
            // Mettre à jour le titre
            let drawName = draw;
            if (draw === 'borlette') drawName = 'Borlette';
            if (draw === 'lotto3') drawName = 'Lotto 3';
            if (draw === 'lotto4') drawName = 'Lotto 4';
            if (draw === 'lotto5') drawName = 'Lotto 5';
            
            let timeName = time === 'morning' ? 'Matin' : 'Soir';
            
            title.textContent = `Résultat ${drawName} - ${timeName}`;
            
            // Configurer les champs selon le tirage
            const lot1Label = document.getElementById('lot1-label');
            const lot2Group = document.getElementById('lot2-group');
            const lot3Group = document.getElementById('lot3-group');
            
            // Définir la date d'aujourd'hui par défaut
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('result-date').value = today;
            
            if (draw === 'borlette') {
                lot1Label.textContent = 'Lot 1 (3 chiffres) *';
                lot2Group.style.display = 'block';
                lot3Group.style.display = 'block';
                document.getElementById('lot2-label').textContent = 'Lot 2 (2 chiffres)';
                document.getElementById('lot3-label').textContent = 'Lot 3 (2 chiffres)';
            } else if (draw === 'lotto3') {
                lot1Label.textContent = 'Numéro gagnant (3 chiffres) *';
                lot2Group.style.display = 'none';
                lot3Group.style.display = 'none';
            } else if (draw === 'lotto4') {
                lot1Label.textContent = 'Numéro gagnant (4 chiffres) *';
                lot2Group.style.display = 'none';
                lot3Group.style.display = 'none';
            } else if (draw === 'lotto5') {
                lot1Label.textContent = 'Numéro gagnant (5 chiffres) *';
                lot2Group.style.display = 'none';
                lot3Group.style.display = 'none';
            }
            
            // Stocker les informations
            document.getElementById('result-draw').value = draw;
            document.getElementById('result-time').value = time;
            
            // Réinitialiser les champs
            document.getElementById('result-lot1').value = '';
            document.getElementById('result-lot2').value = '';
            document.getElementById('result-lot3').value = '';
            document.getElementById('result-verified').checked = false;
            
            // Afficher le modal
            modal.classList.add('active');
        };
        
        // Cacher le modal d'entrée de résultat
        function hideEnterResultModal() {
            document.getElementById('enter-result-modal').classList.remove('active');
        }
        
        // Sauvegarder un résultat
        async function saveResult(e) {
            e.preventDefault();
            
            const draw = document.getElementById('result-draw').value;
            const time = document.getElementById('result-time').value;
            const date = document.getElementById('result-date').value;
            const lot1 = document.getElementById('result-lot1').value.trim();
            const lot2 = document.getElementById('result-lot2').value.trim();
            const lot3 = document.getElementById('result-lot3').value.trim();
            const verified = document.getElementById('result-verified').checked;
            
            // Validation
            if (!draw || !time || !date || !lot1) {
                showNotification('Veuillez remplir tous les champs obligatoires', 'warning');
                return;
            }
            
            // Validation des formats
            if (draw === 'borlette') {
                if (lot1.length !== 3 || !/^\d{3}$/.test(lot1)) {
                    showNotification('Le lot 1 doit être composé de 3 chiffres', 'warning');
                    return;
                }
                if (lot2 && (lot2.length !== 2 || !/^\d{2}$/.test(lot2))) {
                    showNotification('Le lot 2 doit être composé de 2 chiffres', 'warning');
                    return;
                }
                if (lot3 && (lot3.length !== 2 || !/^\d{2}$/.test(lot3))) {
                    showNotification('Le lot 3 doit être composé de 2 chiffres', 'warning');
                    return;
                }
            } else if (draw === 'lotto3') {
                if (lot1.length !== 3 || !/^\d{3}$/.test(lot1)) {
                    showNotification('Le numéro doit être composé de 3 chiffres', 'warning');
                    return;
                }
            } else if (draw === 'lotto4') {
                if (lot1.length !== 4 || !/^\d{4}$/.test(lot1)) {
                    showNotification('Le numéro doit être composé de 4 chiffres', 'warning');
                    return;
                }
            } else if (draw === 'lotto5') {
                if (lot1.length !== 5 || !/^\d{5}$/.test(lot1)) {
                    showNotification('Le numéro doit être composé de 5 chiffres', 'warning');
                    return;
                }
            }
            
            try {
                // Désactiver le bouton
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enregistrement...';
                submitBtn.disabled = true;
                
                // Note: Cette route n'existe pas encore dans server.js
                // Dans une version complète, on utiliserait: POST /api/results
                
                // Simuler un enregistrement réussi
                setTimeout(() => {
                    showNotification('Résultat enregistré avec succès !', 'success');
                    
                    hideEnterResultModal();
                    
                    // Recharger les résultats
                    loadRecentResults();
                    
                    // Réactiver le bouton
                    submitBtn.innerHTML = originalText;
                    submitBtn.disabled = false;
                }, 1000);
                
            } catch (error) {
                console.error('Erreur enregistrement résultat:', error);
                showNotification('Erreur de connexion au serveur', 'error');
                
                // Réactiver le bouton
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        };
        
        // Modifier un résultat
        window.editResult = function(draw, time, date) {
            // Pour l'instant, on ouvre le modal d'entrée avec les données existantes
            enterResult(draw, time);
            
            // Remplir les champs avec les données existantes
            // Dans une version complète, on chargerait les données depuis l'API
            setTimeout(() => {
                document.getElementById('result-date').value = date.split('T')[0];
                document.getElementById('result-lot1').value = '123'; // Exemple
                document.getElementById('result-lot2').value = '45'; // Exemple
                document.getElementById('result-lot3').value = '67'; // Exemple
                document.getElementById('result-verified').checked = true;
            }, 100);
        };
        
        // Supprimer un résultat
        window.deleteResult = function(draw, time, date) {
            if (!confirm('Êtes-vous sûr de vouloir supprimer ce résultat ?')) {
                return;
            }
            
            // Note: Cette route n'existe pas encore
            showNotification('Résultat supprimé (simulation)', 'success');
            
            // Recharger les résultats
            loadRecentResults();
        };
        
        // Changer l'onglet paramètres
        function switchSettingTab(tabId) {
            // Mettre à jour les tabs
            document.querySelectorAll('[data-setting-tab]').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-setting-tab="${tabId}"]`).classList.add('active');
            
            // Afficher le contenu correspondant
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
        }
        
        // Changer l'onglet rapports
        function switchReportTab(tabId) {
            // Mettre à jour les tabs
            document.querySelectorAll('[data-report-tab]').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelector(`[data-report-tab="${tabId}"]`).classList.add('active');
            
            // Afficher le contenu correspondant
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // Charger les agents pour le rapport par agent
            if (tabId === 'agents') {
                loadAgentsForReport();
            }
        }
        
        // Charger les agents pour le rapport
        async function loadAgentsForReport() {
            const agentSelect = document.getElementById('report-agent-select');
            
            if (agentSelect.options.length <= 1) {
                try {
                    const response = await fetch(`${API_BASE_URL}/api/subsystem/users?role=agent`, {
                        headers: {
                            'Authorization': `Bearer ${subsystemToken}`
                        }
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        // Vider les options existantes (garder "Sélectionner un agent")
                        while (agentSelect.options.length > 1) {
                            agentSelect.remove(1);
                        }
                        
                        // Ajouter les agents
                        data.users.forEach(agent => {
                            const option = document.createElement('option');
                            option.value = agent._id;
                            option.textContent = agent.name;
                            agentSelect.appendChild(option);
                        });
                    }
                } catch (error) {
                    console.error('Erreur chargement agents pour rapport:', error);
                }
            }
        }
        
        // Sauvegarder les multiplicateurs
        async function saveMultipliers() {
            try {
                // Récupérer les valeurs
                const multipliers = {
                    borlette_first: parseInt(document.getElementById('borlette-first').value),
                    borlette_second: parseInt(document.getElementById('borlette-second').value),
                    borlette_third: parseInt(document.getElementById('borlette-third').value),
                    lotto3: parseInt(document.getElementById('lotto3').value),
                    lotto4: parseInt(document.getElementById('lotto4').value),
                    lotto5: parseInt(document.getElementById('lotto5').value),
                    grap: parseInt(document.getElementById('grap').value),
                    marriage: parseInt(document.getElementById('marriage').value)
                };
                
                // Note: Cette route n'existe pas encore dans server.js
                // Dans une version complète, on utiliserait: POST /api/system/settings/multipliers
                
                showNotification('Multiplicateurs sauvegardés avec succès !', 'success');
                
            } catch (error) {
                console.error('Erreur sauvegarde multiplicateurs:', error);
                showNotification('Erreur lors de la sauvegarde des multiplicateurs', 'error');
            }
        }
        
        // Générer un rapport quotidien
        async function generateDailyReport() {
            const loading = document.getElementById('daily-report-loading');
            const results = document.getElementById('daily-report-results');
            
            loading.style.display = 'flex';
            results.style.display = 'none';
            
            try {
                const date = document.getElementById('report-daily-date').value || 
                    new Date().toISOString().split('T')[0];
                
                // Récupérer les tickets du jour
                const response = await fetch(`${API_BASE_URL}/api/subsystem/tickets?period=day&date=${date}`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const tickets = data.tickets || [];
                    
                    // Calculer les totaux
                    const totalTickets = tickets.length;
                    const totalSales = tickets.reduce((sum, ticket) => sum + ticket.total, 0);
                    
                    // Regrouper par agent
                    const agentsMap = new Map();
                    tickets.forEach(ticket => {
                        if (!agentsMap.has(ticket.agent_name)) {
                            agentsMap.set(ticket.agent_name, {
                                tickets: 0,
                                sales: 0
                            });
                        }
                        
                        const agentData = agentsMap.get(ticket.agent_name);
                        agentData.tickets++;
                        agentData.sales += ticket.total;
                    });
                    
                    // Générer le HTML du rapport
                    let html = `
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: var(--dark-color); margin-bottom: 15px;">Rapport quotidien - ${date}</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Tickets vendus</div>
                                    <div style="font-weight: bold; color: var(--dark-color);">${totalTickets}</div>
                                </div>
                                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Ventes totales</div>
                                    <div style="font-weight: bold; color: var(--dark-color);">${totalSales.toLocaleString()} HTG</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Détails par agent
                    if (agentsMap.size > 0) {
                        html += `
                            <h4 style="color: var(--dark-color); margin-bottom: 15px;">Détails par agent</h4>
                            <table class="table" style="margin-bottom: 25px;">
                                <thead>
                                    <tr>
                                        <th>Agent</th>
                                        <th>Tickets</th>
                                        <th>Ventes</th>
                                        <th>Moyenne par ticket</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        for (const [agentName, agentData] of agentsMap) {
                            const avg = agentData.tickets > 0 ? agentData.sales / agentData.tickets : 0;
                            html += `
                                <tr>
                                    <td>${agentName}</td>
                                    <td>${agentData.tickets}</td>
                                    <td>${agentData.sales.toLocaleString()} HTG</td>
                                    <td>${avg.toLocaleString()} HTG</td>
                                </tr>
                            `;
                        }
                        
                        // Total
                        html += `
                                <tr style="background-color: #f8f9fa; font-weight: bold;">
                                    <td>TOTAL</td>
                                    <td>${totalTickets}</td>
                                    <td>${totalSales.toLocaleString()} HTG</td>
                                    <td>${totalTickets > 0 ? (totalSales / totalTickets).toLocaleString() : 0} HTG</td>
                                </tr>
                            </tbody>
                            </table>
                        `;
                    }
                    
                    html += `
                        <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #dee2e6; font-size: 0.9rem; color: #6c757d;">
                            Rapport généré le ${new Date().toLocaleString('fr-FR')}
                        </div>
                    `;
                    
                    results.innerHTML = html;
                    loading.style.display = 'none';
                    results.style.display = 'block';
                }
            } catch (error) {
                console.error('Erreur génération rapport quotidien:', error);
                loading.style.display = 'none';
                showNotification('Erreur lors de la génération du rapport', 'error');
            }
        }
        
        // Générer un rapport mensuel
        async function generateMonthlyReport() {
            const loading = document.getElementById('monthly-report-loading');
            const results = document.getElementById('monthly-report-results');
            
            loading.style.display = 'flex';
            results.style.display = 'none';
            
            try {
                const month = document.getElementById('report-monthly-date').value || 
                    new Date().toISOString().slice(0, 7); // YYYY-MM
                
                // Récupérer les tickets du mois
                const response = await fetch(`${API_BASE_URL}/api/subsystem/tickets?period=month&month=${month}`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    const tickets = data.tickets || [];
                    
                    // Calculer les totaux
                    const totalTickets = tickets.length;
                    const totalSales = tickets.reduce((sum, ticket) => sum + ticket.total, 0);
                    
                    // Regrouper par jour
                    const dailyMap = new Map();
                    tickets.forEach(ticket => {
                        const dateStr = new Date(ticket.date).toISOString().split('T')[0];
                        if (!dailyMap.has(dateStr)) {
                            dailyMap.set(dateStr, {
                                tickets: 0,
                                sales: 0
                            });
                        }
                        
                        const dayData = dailyMap.get(dateStr);
                        dayData.tickets++;
                        dayData.sales += ticket.total;
                    });
                    
                    // Convertir en tableau et trier
                    const dailyArray = Array.from(dailyMap.entries())
                        .map(([date, data]) => ({ date, ...data }))
                        .sort((a, b) => a.date.localeCompare(b.date));
                    
                    // Générer le HTML du rapport
                    let html = `
                        <div style="margin-bottom: 25px;">
                            <h3 style="color: var(--dark-color); margin-bottom: 15px;">Rapport mensuel - ${month}</h3>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Tickets vendus</div>
                                    <div style="font-weight: bold; color: var(--dark-color);">${totalTickets}</div>
                                </div>
                                <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
                                    <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Ventes totales</div>
                                    <div style="font-weight: bold; color: var(--dark-color);">${totalSales.toLocaleString()} HTG</div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    // Évolution quotidienne
                    if (dailyArray.length > 0) {
                        html += `
                            <h4 style="color: var(--dark-color); margin-bottom: 15px;">Évolution quotidienne</h4>
                            <table class="table" style="margin-bottom: 25px;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Tickets</th>
                                        <th>Ventes</th>
                                        <th>Moyenne par ticket</th>
                                    </tr>
                                </thead>
                                <tbody>
                        `;
                        
                        dailyArray.forEach(day => {
                            const avg = day.tickets > 0 ? day.sales / day.tickets : 0;
                            html += `
                                <tr>
                                    <td>${day.date}</td>
                                    <td>${day.tickets}</td>
                                    <td>${day.sales.toLocaleString()} HTG</td>
                                    <td>${avg.toLocaleString()} HTG</td>
                                </tr>
                            `;
                        });
                        
                        // Total
                        const avgTotal = totalTickets > 0 ? totalSales / totalTickets : 0;
                        html += `
                                <tr style="background-color: #f8f9fa; font-weight: bold;">
                                    <td>TOTAL</td>
                                    <td>${totalTickets}</td>
                                    <td>${totalSales.toLocaleString()} HTG</td>
                                    <td>${avgTotal.toLocaleString()} HTG</td>
                                </tr>
                            </tbody>
                            </table>
                        `;
                    }
                    
                    html += `
                        <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #dee2e6; font-size: 0.9rem; color: #6c757d;">
                            Rapport généré le ${new Date().toLocaleString('fr-FR')}
                        </div>
                    `;
                    
                    results.innerHTML = html;
                    loading.style.display = 'none';
                    results.style.display = 'block';
                }
            } catch (error) {
                console.error('Erreur génération rapport mensuel:', error);
                loading.style.display = 'none';
                showNotification('Erreur lors de la génération du rapport', 'error');
            }
        }
        
        // Générer un rapport par agent
        async function generateAgentReport() {
            const loading = document.getElementById('agent-report-loading');
            const results = document.getElementById('agent-report-results');
            
            loading.style.display = 'flex';
            results.style.display = 'none';
            
            try {
                const agentId = document.getElementById('report-agent-select').value;
                const period = document.getElementById('report-agent-period').value;
                
                if (!agentId) {
                    showNotification('Veuillez sélectionner un agent', 'warning');
                    loading.style.display = 'none';
                    return;
                }
                
                // Récupérer l'agent
                const agentResponse = await fetch(`${API_BASE_URL}/api/subsystem/users`, {
                    headers: {
                        'Authorization': `Bearer ${subsystemToken}`
                    }
                });
                
                const agentData = await agentResponse.json();
                
                if (agentData.success) {
                    const agent = agentData.users.find(u => u._id === agentId);
                    
                    if (agent) {
                        // Récupérer les tickets de l'agent
                        // Note: Il faudrait une route spécifique pour les tickets par agent
                        const ticketsResponse = await fetch(`${API_BASE_URL}/api/subsystem/tickets?period=${period}`, {
                            headers: {
                                'Authorization': `Bearer ${subsystemToken}`
                            }
                        });
                        
                        const ticketsData = await ticketsResponse.json();
                        
                        if (ticketsData.success) {
                            const allTickets = ticketsData.tickets || [];
                            const agentTickets = allTickets.filter(t => {
                                // Trouver l'ID de l'agent dans le ticket
                                // Note: Cette logique dépend de la structure des données
                                return t.agent_name === agent.name;
                            });
                            
                            // Calculer les totaux
                            const totalTickets = agentTickets.length;
                            const totalSales = agentTickets.reduce((sum, ticket) => sum + ticket.total, 0);
                            
                            // Générer le HTML du rapport
                            let html = `
                                <div style="margin-bottom: 25px;">
                                    <h3 style="color: var(--dark-color); margin-bottom: 15px;">Rapport agent - ${agent.name}</h3>
                                    <div style="display: flex; align-items: center; gap: 20px; margin-bottom: 20px;">
                                        <div style="width: 60px; height: 60px; background-color: #f8f9fa; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--primary-color);">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div>
                                            <h4 style="margin: 0 0 5px 0; color: var(--dark-color);">${agent.name}</h4>
                                            <p style="margin: 0; color: #6c757d;">
                                                <i class="fas fa-user-tag"></i> ${agent.username}
                                                <br>
                                                <i class="fas fa-calendar"></i> Période: ${period === 'today' ? 'Aujourd\'hui' : period === 'week' ? 'Cette semaine' : 'Ce mois'}
                                            </p>
                                        </div>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                                        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
                                            <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Tickets vendus</div>
                                            <div style="font-weight: bold; color: var(--dark-color);">${totalTickets}</div>
                                        </div>
                                        <div style="background-color: #f8f9fa; padding: 15px; border-radius: 8px;">
                                            <div style="font-size: 0.9rem; color: #6c757d; margin-bottom: 5px;">Ventes totales</div>
                                            <div style="font-weight: bold; color: var(--dark-color);">${totalSales.toLocaleString()} HTG</div>
                                        </div>
                                    </div>
                                </div>
                            `;
                            
                            // Détails des tickets
                            if (agentTickets.length > 0) {
                                html += `
                                    <h4 style="color: var(--dark-color); margin-bottom: 15px;">Détails des tickets</h4>
                                    <table class="table" style="margin-bottom: 25px;">
                                        <thead>
                                            <tr>
                                                <th>Numéro</th>
                                                <th>Tirage</th>
                                                <th>Date</th>
                                                <th>Montant</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                `;
                                
                                agentTickets.slice(0, 10).forEach(ticket => {
                                    html += `
                                        <tr>
                                            <td>#${ticket.number}</td>
                                            <td>${ticket.draw} (${ticket.draw_time})</td>
                                            <td>${new Date(ticket.date).toLocaleDateString('fr-FR')}</td>
                                            <td>${ticket.total.toLocaleString()} HTG</td>
                                        </tr>
                                    `;
                                });
                                
                                if (agentTickets.length > 10) {
                                    html += `
                                        <tr>
                                            <td colspan="4" style="text-align: center; color: #6c757d;">
                                                ... et ${agentTickets.length - 10} autres tickets
                                            </td>
                                        </tr>
                                    `;
                                }
                                
                                html += `</tbody></table>`;
                            }
                            
                            html += `
                                <div style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #dee2e6; font-size: 0.9rem; color: #6c757d;">
                                    Rapport généré le ${new Date().toLocaleString('fr-FR')}
                                </div>
                            `;
                            
                            results.innerHTML = html;
                            loading.style.display = 'none';
                            results.style.display = 'block';
                        }
                    }
                }
            } catch (error) {
                console.error('Erreur génération rapport agent:', error);
                loading.style.display = 'none';
                showNotification('Erreur lors de la génération du rapport', 'error');
            }
        }
        
        // Filtrer les utilisateurs
        function filterUsers() {
            const searchTerm = document.getElementById('search-users').value.toLowerCase();
            const rows = document.querySelectorAll('#users-table-body tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // Filtrer les tickets
        function filterTickets() {
            const searchTerm = document.getElementById('search-tickets').value.toLowerCase();
            const rows = document.querySelectorAll('#tickets-table-body tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // Filtrer les agents
        function filterAgents() {
            const searchTerm = document.getElementById('search-agents').value.toLowerCase();
            const rows = document.querySelectorAll('#agents-list-table-body tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // Filtrer les superviseurs
        function filterSupervisors() {
            const searchTerm = document.getElementById('search-supervisors').value.toLowerCase();
            const rows = document.querySelectorAll('#supervisors-list-table-body tr');
            
            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                row.style.display = text.includes(searchTerm) ? '' : 'none';
            });
        }
        
        // Rafraîchir les données
        function refreshData() {
            const refreshBtn = document.getElementById('refresh-btn');
            const originalHtml = refreshBtn.innerHTML;
            
            refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            refreshBtn.disabled = true;
            
            // Recharger les données selon la section active
            const activeSection = document.querySelector('.section-content.active').id;
            
            switch(activeSection) {
                case 'dashboard-section':
                    loadDashboardData();
                    loadRecentUsers();
                    loadRecentTickets();
                    break;
                case 'users-section':
                    loadAllUsers();
                    break;
                case 'tickets-section':
                    const activeTab = document.querySelector('.tab.active[data-ticket-tab]');
                    if (activeTab) {
                        const tabId = activeTab.getAttribute('data-ticket-tab');
                        switch(tabId) {
                            case 'today':
                                loadTodayTickets();
                                break;
                            case 'pending':
                                loadPendingTickets();
                                break;
                            case 'winning':
                                loadWinningTickets();
                                break;
                            case 'all':
                                loadAllTickets();
                                break;
                        }
                    }
                    break;
                case 'results-section':
                    loadRecentResults();
                    break;
                case 'activity-section':
                    loadActivities();
                    break;
            }
            
            // Réactiver le bouton après 2 secondes
            setTimeout(() => {
                refreshBtn.innerHTML = originalHtml;
                refreshBtn.disabled = false;
                showNotification('Données rafraîchies', 'success');
            }, 2000);
        }
        
        // Afficher une notification
        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            let icon = 'fas fa-info-circle';
            if (type === 'success') icon = 'fas fa-check-circle';
            if (type === 'error') icon = 'fas fa-times-circle';
            if (type === 'warning') icon = 'fas fa-exclamation-triangle';
            
            notification.innerHTML = `
                <i class="${icon}"></i>
                <span>${message}</span>
                <button style="background: none; border: none; color: inherit; margin-left: auto; cursor: pointer;" 
                        onclick="this.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            // Supprimer automatiquement après 5 secondes
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Déconnexion
        function logout() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                localStorage.removeItem('nova_token');
                localStorage.removeItem('nova_user_data');
                localStorage.removeItem('nova_user_role');
                redirectToLogin();
            }
        }
        
        // Exporter un rapport
        document.getElementById('export-daily-report').addEventListener('click', function() {
            alert('Fonctionnalité d\'export à implémenter');
        });
        
        document.getElementById('export-monthly-report').addEventListener('click', function() {
            alert('Fonctionnalité d\'export à implémenter');
        });
    </script>
</body>
</html>