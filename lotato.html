<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LOTATO - PRODUCTION</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/auth-check.js"></script>

    <style>
        /* --- DESIGN & COULEURS CONSERVÉS --- */
        :root {
            --primary-color: #ad00f1;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --success-color: #9000f0;
            --warning-color: #1cf100;
            --light-color: #ecf0f1;
            --dark-color: #0004ff;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #f5f7fa; color: var(--dark-color); max-width: 500px; margin: 0 auto; }
        .container { padding: 15px; padding-bottom: 80px; }
        
        header {
            background: linear-gradient(135deg, var(--primary-color), #1a2530);
            color: white; padding: 15px; text-align: center; border-radius: 12px; margin-bottom: 20px;
        }

        /* --- STYLES DES BOUTONS BO ET AUTO --- */
        .auto-panel {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }
        .bo-btn {
            background-color: #f39c12;
            color: white;
            border: none;
            padding: 10px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .bo-btn:active { transform: scale(0.95); }

        /* --- FORMULAIRE ET LISTE --- */
        .betting-screen { display: none; position: fixed; inset: 0; background: white; z-index: 100; padding: 15px; overflow-y: auto; }
        .bet-form { background: #fff; border: 1px solid #ddd; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .input-row { display: flex; gap: 8px; margin-bottom: 10px; }
        input { width: 100%; padding: 12px; border: 2px solid #eee; border-radius: 8px; text-align: center; font-size: 1.2rem; font-weight: bold; }
        input:focus { border-color: var(--secondary-color); outline: none; }
        
        .btn-add { background: var(--success-color); color: white; width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: bold; margin-top: 10px; }
        
        .active-bets { margin-top: 20px; border-top: 2px solid #eee; padding-top: 10px; }
        .bet-item { display: flex; justify-content: space-between; padding: 10px; background: #f9f9f9; margin-bottom: 5px; border-radius: 5px; }
        .bet-remove { color: red; font-weight: bold; cursor: pointer; }

        .draw-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .draw-btn { padding: 8px 15px; border: none; border-radius: 5px; margin: 5px; cursor: pointer; background: var(--light-color); }
        
        /* Navigation */
        .bottom-nav { position: fixed; bottom: 0; width: 100%; max-width: 500px; background: white; display: flex; justify-content: space-around; padding: 10px; border-top: 1px solid #ddd; }
    </style>
</head>
<body>

    <div class="container" id="main-app">
        <header>
            <h1 id="company-name">NOVA LOTTO</h1>
            <div id="clock">00:00:00</div>
        </header>

        <div id="draws-list">
            </div>

        <div class="results-section">
            <h3>Dènye Rezilta (MongoDB)</h3>
            <div id="results-display">Chajman...</div>
        </div>
    </div>

    <div id="betting-screen" class="betting-screen">
        <div style="display: flex; align-items: center; margin-bottom: 20px;">
            <button onclick="closeBetting()" style="border:none; background:none; font-size: 1.5rem; margin-right: 15px;"><i class="fas fa-arrow-left"></i></button>
            <h2 id="draw-title">Tiraj</h2>
        </div>

        <div class="auto-panel">
            <button class="bo-btn" onclick="autoPaires()">Boul Pè</button>
            <button class="bo-btn" onclick="autoMariage()">Maryaj Auto</button>
            <button class="bo-btn" onclick="autoLotto()">Loto Auto</button>
        </div>

        <div class="bet-form">
            <select id="game-type" onchange="updateFormFields()" style="width:100%; padding:10px; margin-bottom:10px; border-radius:8px;">
                <option value="borlette">Borlette (x60)</option>
                <option value="marriage">Maryaj (x1000)</option>
                <option value="lotto3">Lotto 3 (x500)</option>
                <option value="lotto4">Lotto 4 (x5000)</option>
                <option value="lotto5">Lotto 5 (x25000)</option>
            </select>

            <div class="input-row" id="inputs-container">
                <input type="number" id="num1" placeholder="Boul" maxlength="2" oninput="autoTab(this, 'amount')">
            </div>
            <input type="number" id="amount" placeholder="Goud" oninput="autoTab(this, 'btn-add-bet')">
            <button class="btn-add" id="btn-add-bet" onclick="addBet()">AJOUTE</button>
        </div>

        <div class="active-bets">
            <h3>Paryaj ou yo</h3>
            <div id="bets-list"></div>
            <div style="font-weight: bold; font-size: 1.3rem; margin-top: 10px; text-align: right;">
                Total: <span id="total-amount">0</span> G
            </div>
            <button class="btn-add" style="background: var(--primary-color); margin-top: 20px;" onclick="validateTicket()">VALIDE & ENPRIME</button>
        </div>
    </div>

    <div class="bottom-nav">
        <div onclick="location.reload()"><i class="fas fa-home"></i><br>Akèy</div>
        <div onclick="showHistory()"><i class="fas fa-history"></i><br>Istorik</div>
    </div>

    <script>
        let currentDraw = "";
        let currentDrawTime = "";
        let activeBets = [];
        let currentAdmin = JSON.parse(localStorage.getItem('lotatoAgent'));

        // 1. AUTO-TABULATION : Déplacement automatique du curseur
        function autoTab(current, nextId) {
            const gameType = document.getElementById('game-type').value;
            let limit = 2; // Par défaut borlette
            
            if (gameType === 'lotto3') limit = 3;
            if (gameType === 'lotto5' && current.id === 'num1') limit = 3;

            // Si c'est un champ de numéro et qu'il atteint la limite
            if (current.type === "number" && current.id !== "amount") {
                if (current.value.length >= limit) {
                    current.value = current.value.slice(0, limit);
                    document.getElementById(nextId).focus();
                }
            } 
            // Si on tape le montant, on peut appuyer sur Enter pour ajouter
            current.addEventListener('keypress', function (e) {
                if (e.key === 'Enter') {
                    if (current.id === 'amount') addBet();
                    else document.getElementById(nextId).focus();
                }
            });
        }

        // 2. BOUTONS BO (Logique Automatique)
        function autoPaires() {
            const amount = prompt("Kantite goud pou chak pè:", "10");
            if (!amount) return;
            const paires = ["00", "11", "22", "33", "44", "55", "66", "77", "88", "99"];
            paires.forEach(p => {
                activeBets.push({ type: 'borlette', name: 'Boul Pè', number: p, amount: parseInt(amount) });
            });
            updateBetsList();
        }

        function autoMariage() {
            const boules = prompt("Antre boul yo (separe pa espas) ex: 12 45 09:");
            const amount = prompt("Kantite goud pou chak maryaj:", "5");
            if (!boules || !amount) return;
            const list = boules.split(" ");
            for (let i = 0; i < list.length; i++) {
                for (let j = i + 1; j < list.length; j++) {
                    activeBets.push({ type: 'marriage', name: 'Maryaj', number: `${list[i]}x${list[j]}`, amount: parseInt(amount) });
                }
            }
            updateBetsList();
        }

        function autoLotto() {
            const num = prompt("Antre boul la (2 chif):");
            const amount = prompt("Kantite goud:", "10");
            if (!num || !amount) return;
            // Génère 10 loto 3 avec cette boule (023, 123, 223...)
            for (let i = 0; i < 10; i++) {
                activeBets.push({ type: 'lotto3', name: 'Loto 3', number: `${i}${num}`, amount: parseInt(amount) });
            }
            updateBetsList();
        }

        // 3. MISE À JOUR DES CHAMPS SELON LE JEU
        function updateFormFields() {
            const type = document.getElementById('game-type').value;
            const container = document.getElementById('inputs-container');
            container.innerHTML = "";
            
            if (type === 'marriage' || type === 'lotto4') {
                container.innerHTML = `
                    <input type="number" id="num1" placeholder="Boul 1" oninput="autoTab(this, 'num2')">
                    <input type="number" id="num2" placeholder="Boul 2" oninput="autoTab(this, 'amount')">
                `;
            } else if (type === 'lotto5') {
                container.innerHTML = `
                    <input type="number" id="num1" placeholder="3 chif" oninput="autoTab(this, 'num2')">
                    <input type="number" id="num2" placeholder="2 chif" oninput="autoTab(this, 'amount')">
                `;
            } else {
                container.innerHTML = `<input type="number" id="num1" placeholder="Boul" oninput="autoTab(this, 'amount')">`;
            }
            document.getElementById('num1').focus();
        }

        // GESTION DES PARIS
        function addBet() {
            const type = document.getElementById('game-type').value;
            const amount = parseInt(document.getElementById('amount').value);
            const n1 = document.getElementById('num1').value;
            
            if (!n1 || !amount) return alert("Ranpli tout champs yo!");

            let number = n1;
            if (document.getElementById('num2')) {
                number = `${n1}x${document.getElementById('num2').value}`;
            }

            activeBets.push({ type, name: type.toUpperCase(), number, amount });
            updateBetsList();
            
            // Reset fields
            document.getElementById('amount').value = "";
            updateFormFields(); 
        }

        function updateBetsList() {
            const list = document.getElementById('bets-list');
            list.innerHTML = "";
            let total = 0;
            activeBets.forEach((b, i) => {
                total += b.amount;
                list.innerHTML += `
                    <div class="bet-item">
                        <span>${b.name} : <b>${b.number}</b></span>
                        <span>${b.amount} G <i class="fas fa-trash bet-remove" onclick="removeBet(${i})"></i></span>
                    </div>
                `;
            });
            document.getElementById('total-amount').textContent = total;
        }

        function removeBet(i) {
            activeBets.splice(i, 1);
            updateBetsList();
        }

        // CONNEXION SERVEUR (MONGODB)
        async function validateTicket() {
            if (activeBets.length === 0) return alert("Fiche la vid!");

            const payload = {
                draw: currentDraw,
                drawTime: currentDrawTime,
                bets: activeBets,
                agentId: currentAdmin.id,
                total: document.getElementById('total-amount').textContent
            };

            try {
                const res = await fetch('/api/tickets/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                const data = await res.json();
                if (data.success) {
                    alert("Fiche anrejistre avec succès!");
                    printTicket(data.ticket);
                    activeBets = [];
                    closeBetting();
                }
            } catch (e) {
                alert("Erreur connexion serveur Atlas");
            }
        }

        // INITIALISATION
        function initDraws() {
            const draws = [
                { id: 'miami', name: 'Miami', morning: '1:30', evening: '9:30' },
                { id: 'newyork', name: 'New York', morning: '2:30', evening: '10:30' }
            ];
            const container = document.getElementById('draws-list');
            draws.forEach(d => {
                container.innerHTML += `
                    <div class="draw-card">
                        <h3>${d.name}</h3>
                        <button class="draw-btn" onclick="openBetting('${d.id}', 'matin')">Matin (${d.morning})</button>
                        <button class="draw-btn" onclick="openBetting('${d.id}', 'swè')">Swè (${d.evening})</button>
                    </div>
                `;
            });
        }

        function openBetting(id, time) {
            currentDraw = id;
            currentDrawTime = time;
            document.getElementById('draw-title').textContent = `${id.toUpperCase()} - ${time}`;
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('betting-screen').style.display = 'block';
            updateFormFields();
        }

        function closeBetting() {
            document.getElementById('betting-screen').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
        }

        // Horloge
        setInterval(() => {
            document.getElementById('clock').textContent = new Date().toLocaleTimeString();
        }, 1000);

        window.onload = () => {
            initDraws();
            // Récupérer résultats depuis MongoDB (via server.js)
            fetch('/api/results/latest').then(r => r.json()).then(data => {
                if (data.results) {
                    // Logique d'affichage des résultats ici
                }
            });
        };

        function printTicket(ticket) {
            const w = window.open('', '', 'width=300,height=600');
            w.document.write(`
                <div style="text-align:center; font-family:monospace;">
                    <h2>NOVA LOTTO</h2>
                    <p>Fiche #${ticket.ticketNumber}</p>
                    <p>${new Date().toLocaleString()}</p>
                    <hr>
                    ${ticket.bets.map(b => `<div>${b.name} ${b.number} : ${b.amount}G</div>`).join('')}
                    <hr>
                    <h3>TOTAL: ${ticket.totalAmount} G</h3>
                    <p>Agent: ${currentAdmin.username}</p>
                </div>
            `);
            w.print();
            w.close();
        }
    </script>
</body>
</html>